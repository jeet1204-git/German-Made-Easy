<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - German Made Easy</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        nav {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, #FF6B35, #004E89);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .user-email {
            font-weight: 600;
            color: #1A1A2E;
        }

        .btn-logout {
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
            background: #FF6B35;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #004E89;
        }

        .btn-nav-link {
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 600;
            background: white;
            color: #FF6B35;
            border: 2px solid #FF6B35;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-nav-link:hover {
            background: #FF6B35;
            color: white;
        }

        .leaderboard-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 40px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 42px;
            font-weight: 900;
            color: #1A1A2E;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }

        .user-stats-card {
            background: linear-gradient(135deg, #FF6B35, #FF8C61);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
            color: white;
            margin-bottom: 30px;
        }

        .user-stats-title {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 15px;
            text-align: center;
        }

        .user-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .user-stat-item {
            text-align: center;
        }

        .user-stat-label {
            font-size: 13px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .user-stat-value {
            font-size: 22px;
            font-weight: 800;
        }

        .tab-switcher {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            flex: 1;
            max-width: 200px;
            padding: 12px 30px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #FF6B35;
            color: white;
        }

        .leaderboard-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .leaderboard-content {
            transition: opacity 0.3s ease;
        }

        .leaderboard-content.hidden {
            opacity: 0;
            display: none;
        }

        .leaderboard-list {
            list-style: none;
        }

        .leaderboard-row {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .leaderboard-row:last-child {
            margin-bottom: 0;
        }

        .leaderboard-row:nth-child(odd) {
            background: #fafafa;
        }

        .leaderboard-row.current-user {
            background: #FFF3ED;
            border-left: 4px solid #FF6B35;
        }

        .leaderboard-row.top-3 {
            font-size: 1.05em;
            font-weight: 700;
        }

        .lb-trophy {
            font-size: 24px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .lb-rank {
            font-size: 18px;
            font-weight: 800;
            color: #1A1A2E;
            width: 36px;
            text-align: center;
            flex-shrink: 0;
        }

        .lb-rank.gold { color: #f59e0b; }
        .lb-rank.silver { color: #9ca3af; }
        .lb-rank.bronze { color: #cd7f32; }

        .lb-info {
            flex: 1;
            margin-left: 12px;
        }

        .lb-name-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .lb-name {
            font-weight: 700;
            color: #1A1A2E;
        }

        .lb-level-badge {
            background: #FF6B35;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
        }

        .lb-motivational-badge {
            font-size: 13px;
            color: #666;
        }

        .lb-stats {
            display: flex;
            gap: 12px;
            flex-shrink: 0;
            align-items: center;
        }

        .lb-stat {
            font-size: 14px;
            font-weight: 600;
            color: #1A1A2E;
        }

        .lb-score {
            color: #FF6B35;
            font-weight: 800;
        }

        .leaderboard-empty {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .leaderboard-empty-emoji {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .leaderboard-empty-text {
            font-size: 20px;
            font-weight: 600;
            color: #1A1A2E;
        }

        .level-switcher {
            text-align: center;
            margin-bottom: 20px;
        }

        .level-switcher-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .level-btn {
            padding: 8px 20px;
            margin: 0 5px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level-btn.active {
            background: #FF6B35;
            color: white;
            border-color: #FF6B35;
        }

        .level-btn.not-your-level {
            opacity: 0.7;
        }

        .footer-note {
            text-align: center;
            font-size: 13px;
            color: #999;
            padding: 20px;
        }

        .loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            nav {
                padding: 20px;
            }

            .leaderboard-container {
                padding: 0 20px;
                margin: 24px auto;
            }

            .page-title {
                font-size: 32px;
            }

            .user-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .user-stat-value {
                font-size: 20px;
            }

            .tab-switcher {
                flex-direction: column;
                gap: 8px;
            }

            .tab-btn {
                max-width: 100%;
            }

            .leaderboard-row {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }

            .lb-info {
                margin-left: 0;
                margin-top: 8px;
                margin-bottom: 8px;
            }

            .lb-stats {
                width: 100%;
                justify-content: space-between;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo" style="text-decoration:none;">German Made Easy</a>
            <div class="user-info">
                <span class="user-email" id="userEmail">Loading...</span>
                <a href="index.html" class="btn-nav-link">üè† Home</a>
                <a href="dashboard.html" class="btn-nav-link">üìä Dashboard</a>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="leaderboard-container">
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-spinner"></div>
        </div>
        <div id="mainContent" style="display: none;">
            <div class="page-header">
                <h1 class="page-title">üèÜ Leaderboard</h1>
                <p class="page-subtitle" id="weekSubtitle">Loading...</p>
                
                <div class="user-stats-card" id="userStatsCard"></div>
            </div>

            <div class="tab-switcher">
                <button class="tab-btn active" onclick="switchTab('weekly')">This Week</button>
                <button class="tab-btn" onclick="switchTab('alltime')">All Time</button>
            </div>

            <div class="leaderboard-card">
                <div id="weeklyContent" class="leaderboard-content"></div>
                <div id="alltimeContent" class="leaderboard-content hidden"></div>
            </div>

            <div class="level-switcher">
                <div class="level-switcher-label">Viewing:</div>
                <button class="level-btn" id="levelBtnA1" onclick="switchLevel('A1')">A1</button>
                <button class="level-btn" id="levelBtnA2" onclick="switchLevel('A2')">A2</button>
            </div>

            <div class="footer-note">
                Leaderboard resets every Monday at midnight. Rankings are based on login streaks and course activity.
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, limit, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E",
            authDomain: "german-made-easy.firebaseapp.com",
            projectId: "german-made-easy",
            storageBucket: "german-made-easy.firebasestorage.app",
            messagingSenderId: "259276936055",
            appId: "1:259276936055:web:5c9b4916734d0271100772",
            measurementId: "G-B7JMB0G85L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTab = 'weekly';
        let currentViewLevel = null;
        let userData = null;

        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                alert('Error logging out. Please try again.');
            }
        };

        function escapeHtml(str) {
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function getWeekId() {
            var now = new Date();
            var startOfYear = new Date(now.getFullYear(), 0, 1);
            var days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
            var weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return now.getFullYear() + '-W' + String(weekNumber).padStart(2, '0');
        }

        function getLastMonday() {
            var now = new Date();
            var day = now.getDay();
            var diff = day === 0 ? 6 : day - 1;
            var monday = new Date(now);
            monday.setDate(now.getDate() - diff);
            monday.setHours(0, 0, 0, 0);
            return monday;
        }

        function formatDate(date) {
            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getDate() + ', ' + date.getFullYear();
        }

        window.switchTab = function(tab) {
            currentTab = tab;
            
            var weeklyBtn = document.querySelector('.tab-btn:nth-child(1)');
            var alltimeBtn = document.querySelector('.tab-btn:nth-child(2)');
            var weeklyContent = document.getElementById('weeklyContent');
            var alltimeContent = document.getElementById('alltimeContent');

            if (tab === 'weekly') {
                weeklyBtn.classList.add('active');
                alltimeBtn.classList.remove('active');
                weeklyContent.classList.remove('hidden');
                alltimeContent.classList.add('hidden');
            } else {
                alltimeBtn.classList.add('active');
                weeklyBtn.classList.remove('active');
                alltimeContent.classList.remove('hidden');
                weeklyContent.classList.add('hidden');
            }
        };

        window.switchLevel = function(level) {
            currentViewLevel = level;
            
            var btnA1 = document.getElementById('levelBtnA1');
            var btnA2 = document.getElementById('levelBtnA2');
            
            if (level === 'A1') {
                btnA1.classList.add('active');
                btnA2.classList.remove('active');
            } else {
                btnA2.classList.add('active');
                btnA1.classList.remove('active');
            }

            if (userData && userData.level !== level) {
                btnA1.classList.add('not-your-level');
                btnA2.classList.add('not-your-level');
                document.getElementById('levelBtn' + level).classList.remove('not-your-level');
            }

            loadLeaderboards();
        };

        async function loadUserStats(user) {
            try {
                var userDocRef = doc(db, 'users', user.uid);
                var userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.exists() ? userDocSnap.data() : {};

                var weekId = getWeekId();
                var weeklyDocRef = doc(db, 'leaderboard_weekly', weekId, user.uid);
                var weeklyDocSnap = await getDoc(weeklyDocRef);
                var weeklyData = weeklyDocSnap.exists() ? weeklyDocSnap.data() : {};

                var allTimeDocRef = doc(db, 'leaderboard', user.uid);
                var allTimeDocSnap = await getDoc(allTimeDocRef);
                var allTimeData = allTimeDocSnap.exists() ? allTimeDocSnap.data() : {};

                var weeklyRank = await getUserRank(weekId, userData.level, user.uid, true);
                var allTimeRank = await getUserRank(null, userData.level, user.uid, false);

                var daysSinceJoined = 0;
                if (userData.joinedAt) {
                    var joinedDate = userData.joinedAt.toDate ? userData.joinedAt.toDate() : new Date(userData.joinedAt);
                    daysSinceJoined = Math.floor((new Date() - joinedDate) / (1000 * 60 * 60 * 24));
                }

                document.getElementById('userStatsCard').innerHTML =
                    '<div class="user-stats-title">Your Stats</div>' +
                    '<div class="user-stats-grid">' +
                        '<div class="user-stat-item">' +
                            '<div class="user-stat-label">This Week Rank</div>' +
                            '<div class="user-stat-value">#' + weeklyRank + '</div>' +
                        '</div>' +
                        '<div class="user-stat-item">' +
                            '<div class="user-stat-label">Weekly Points</div>' +
                            '<div class="user-stat-value">‚≠ê ' + (userData.weeklyScore || 0) + '</div>' +
                        '</div>' +
                        '<div class="user-stat-item">' +
                            '<div class="user-stat-label">Streak</div>' +
                            '<div class="user-stat-value">üî• ' + (userData.streakDays || 0) + '</div>' +
                        '</div>' +
                        '<div class="user-stat-item">' +
                            '<div class="user-stat-label">Badge</div>' +
                            '<div class="user-stat-value" style="font-size: 18px;">' + escapeHtml(weeklyData.badge || allTimeData.badge || 'üìö Learning') + '</div>' +
                        '</div>' +
                    '</div>';

            } catch (error) {
                document.getElementById('userStatsCard').innerHTML =
                    '<div class="user-stats-title">Your Stats</div>' +
                    '<div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.8);">Stats loading...</div>';
            }
        }

        async function getUserRank(weekId, level, userId, isWeekly) {
            try {
                var collectionPath = isWeekly ? collection(db, 'leaderboard_weekly', weekId) : collection(db, 'leaderboard');
                var q = query(
                    collectionPath,
                    where('level', '==', level),
                    orderBy('totalScore', 'desc')
                );
                var snapshot = await getDocs(q);
                
                var rank = 1;
                var found = false;
                snapshot.forEach(function(docSnap) {
                    if (docSnap.id === userId) {
                        found = true;
                        return;
                    }
                    if (!found) rank++;
                });

                return found ? rank : '-';
            } catch (error) {
                return '-';
            }
        }

        async function loadLeaderboards() {
            var weekId = getWeekId();
            await loadLeaderboard(weekId, currentViewLevel, true);
            await loadLeaderboard(null, currentViewLevel, false);
        }

        async function loadLeaderboard(weekId, level, isWeekly) {
            var contentEl = document.getElementById(isWeekly ? 'weeklyContent' : 'alltimeContent');
            contentEl.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Loading...</div>';

            try {
                var collectionPath = isWeekly ? collection(db, 'leaderboard_weekly', weekId) : collection(db, 'leaderboard');
                var q = query(
                    collectionPath,
                    where('level', '==', level),
                    orderBy('totalScore', 'desc'),
                    limit(50)
                );
                var snapshot = await getDocs(q);

                if (snapshot.size < 3) {
                    contentEl.innerHTML =
                        '<div class="leaderboard-empty">' +
                            '<div class="leaderboard-empty-emoji">üöÄ</div>' +
                            '<div class="leaderboard-empty-text">Be one of the first to claim the top spot!</div>' +
                        '</div>';
                    return;
                }

                var listHtml = '<ul class="leaderboard-list">';
                var rank = 0;

                snapshot.forEach(function(docSnap) {
                    rank++;
                    var entry = docSnap.data();
                    var isCurrentUser = currentUser && docSnap.id === currentUser.uid;
                    var rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
                    var rowClass = 'leaderboard-row';
                    if (isCurrentUser) rowClass += ' current-user';
                    if (rank <= 3) rowClass += ' top-3';

                    var trophy = '';
                    if (rank === 1) trophy = '<span class="lb-trophy">ü•á</span>';
                    else if (rank === 2) trophy = '<span class="lb-trophy">ü•à</span>';
                    else if (rank === 3) trophy = '<span class="lb-trophy">ü•â</span>';

                    var daysSinceJoined = 0;
                    if (entry.lastUpdated) {
                        daysSinceJoined = Math.floor((new Date() - entry.lastUpdated.toDate()) / (1000 * 60 * 60 * 24));
                    }

                    listHtml +=
                        '<li class="' + rowClass + '">' +
                            trophy +
                            '<span class="lb-rank ' + rankClass + '">#' + rank + '</span>' +
                            '<div class="lb-info">' +
                                '<div class="lb-name-line">' +
                                    '<span class="lb-name">' + escapeHtml(entry.name || 'Student') + (isCurrentUser ? ' (You)' : '') + '</span>' +
                                    '<span class="lb-level-badge">' + escapeHtml(entry.level || 'A1') + '</span>' +
                                    '<span class="lb-motivational-badge">' + escapeHtml(entry.badge || 'üìö Learning') + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="lb-stats">' +
                                '<span class="lb-stat lb-score">‚≠ê ' + (entry.totalScore || 0) + ' pts</span>' +
                                '<span class="lb-stat">üî• ' + (entry.streakDays || 0) + ' days</span>' +
                            '</div>' +
                        '</li>';
                });

                listHtml += '</ul>';
                contentEl.innerHTML = listHtml;

            } catch (error) {
                contentEl.innerHTML =
                    '<div class="leaderboard-empty">' +
                        '<div class="leaderboard-empty-text">Error loading leaderboard. Please try again later.</div>' +
                    '</div>';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            document.getElementById('userEmail').textContent = user.email;

            try {
                var userDocRef = doc(db, 'users', user.uid);
                var userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.exists() ? userDocSnap.data() : {};
                currentViewLevel = userData.level || 'A1';

                var lastMonday = getLastMonday();
                document.getElementById('weekSubtitle').textContent = 'Week of ' + formatDate(lastMonday);

                var btnA1 = document.getElementById('levelBtnA1');
                var btnA2 = document.getElementById('levelBtnA2');
                
                if (currentViewLevel === 'A1') {
                    btnA1.classList.add('active');
                } else {
                    btnA2.classList.add('active');
                }

                await loadUserStats(user);
                await loadLeaderboards();

                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                document.getElementById('loadingScreen').innerHTML =
                    '<div style="text-align:center;padding:40px;">' +
                        '<h3 style="color:#1A1A2E;margin-bottom:15px;">Something went wrong</h3>' +
                        '<p style="color:#666;">We couldn\'t load the leaderboard. Please refresh the page or try again later.</p>' +
                    '</div>';
            }
        });
    </script>
</body>
</html>
