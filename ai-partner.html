<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprechen Buddy AI â€” German Made Easy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1209;
    --parchment: #faf6ef;
    --cream: #f3ece0;
    --gold: #c9963a;
    --gold-light: #e8c06a;
    --gold-pale: #f5e8c8;
    --forest: #2d5a3d;
    --forest-light: #4a8a5f;
    --red: #c0392b;
    --red-light: #e74c3c;
    --muted: #8a7d6a;
    --border: #ddd5c4;
    --shadow: rgba(26,18,9,0.12);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--parchment); color: var(--ink); min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: radial-gradient(ellipse at 20% 10%, rgba(201,150,58,0.06) 0%, transparent 50%), radial-gradient(ellipse at 80% 90%, rgba(45,90,61,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }
  #auth-overlay { position: fixed; inset: 0; background: var(--ink); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; gap: 1rem; }
  #auth-overlay p { color: var(--gold-light); font-family: 'DM Mono', monospace; font-size: 0.85rem; letter-spacing: 0.1em; }
  .auth-spinner { width: 40px; height: 40px; border: 3px solid rgba(201,150,58,0.2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  #access-denied { display: none; position: fixed; inset: 0; background: var(--parchment); align-items: center; justify-content: center; z-index: 999; flex-direction: column; gap: 1.5rem; text-align: center; padding: 2rem; }
  #access-denied h2 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--red); }
  #access-denied p { color: var(--muted); max-width: 400px; line-height: 1.6; }
  #access-denied a { display: inline-block; padding: 0.75rem 2rem; background: var(--ink); color: var(--gold-light); text-decoration: none; font-weight: 600; border-radius: 2px; }
  #trial-limit-modal { display: none; position: fixed; inset: 0; background: rgba(26,18,9,0.72); align-items: center; justify-content: center; z-index: 1000; padding: 1.5rem; }
  #trial-limit-modal.visible { display: flex; }
  .trial-modal-card { background: var(--parchment); border-radius: 8px; padding: 2.5rem 2rem; max-width: 440px; width: 100%; text-align: center; box-shadow: 0 8px 40px rgba(26,18,9,0.35); animation: fadeUp 0.4s ease both; }
  .trial-badge { display: inline-block; background: var(--gold-pale); color: var(--gold); font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; padding: 0.3rem 0.85rem; border-radius: 20px; margin-bottom: 1.25rem; }
  .trial-modal-card h2 { font-family: 'Playfair Display', serif; font-size: 1.75rem; color: var(--ink); margin-bottom: 0.75rem; }
  .trial-modal-card p { color: var(--muted); line-height: 1.65; margin-bottom: 1.75rem; max-width: 360px; margin-left: auto; margin-right: auto; }
  .trial-modal-btn { display: inline-block; padding: 0.85rem 2.25rem; background: var(--ink); color: var(--gold-light); text-decoration: none; font-weight: 700; font-family: 'Playfair Display', serif; font-size: 1.05rem; border-radius: 4px; transition: background 0.2s; }
  .trial-modal-btn:hover { background: var(--forest); }
  .trial-counter-badge { display: inline-block; font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); background: var(--cream); border: 1px solid var(--border); border-radius: 20px; padding: 0.2rem 0.7rem; }
  #trial-counter-wrap { display: none; text-align: center; margin-bottom: 0.75rem; }
  .topbar { position: relative; z-index: 10; display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; border-bottom: 1px solid var(--border); background: rgba(250,246,239,0.9); backdrop-filter: blur(8px); }
  .topbar-brand { display: flex; align-items: center; gap: 0.75rem; }
  .topbar-logo { width: 36px; height: 36px; background: var(--ink); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--gold-light); font-size: 1.1rem; }
  .topbar-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; }
  .topbar-sub { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .topbar-user { display: flex; align-items: center; gap: 1rem; }
  .user-badge { font-size: 0.75rem; font-family: 'DM Mono', monospace; background: var(--forest); color: #fff; padding: 0.25rem 0.65rem; border-radius: 20px; }
  .topbar-back { font-size: 0.8rem; color: var(--muted); text-decoration: none; transition: color 0.2s; }
  .topbar-back:hover { color: var(--ink); }
  .container { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
  .hero { text-align: center; margin-bottom: 3rem; animation: fadeUp 0.6s ease both; }
  .hero-eyebrow { font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.75rem; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: clamp(2.2rem, 5vw, 3.5rem); font-weight: 900; line-height: 1.1; margin-bottom: 0.75rem; }
  .hero h1 span { color: var(--gold); }
  .hero p { font-size: 1.05rem; color: var(--muted); max-width: 520px; margin: 0 auto; line-height: 1.7; }
  #setup-panel { animation: fadeUp 0.6s 0.1s ease both; }
  .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
  @media (max-width: 600px) { .setup-grid { grid-template-columns: 1fr; } }
  .setup-card { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; padding: 1.5rem; box-shadow: 0 2px 12px var(--shadow); }
  .setup-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
  .level-tabs { display: flex; gap: 0.5rem; }
  .level-tab { flex: 1; padding: 0.6rem; text-align: center; border: 1.5px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; background: var(--cream); color: var(--muted); }
  .level-tab.active { background: var(--ink); color: var(--gold-light); border-color: var(--ink); }
  .scenario-select { width: 100%; padding: 0.7rem 0.9rem; border: 1.5px solid var(--border); border-radius: 4px; background: var(--cream); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a7d6a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.9rem center; padding-right: 2.5rem; }
  .scenario-select:focus { outline: none; border-color: var(--gold); }
  .scenario-desc { margin-top: 0.6rem; font-size: 0.8rem; color: var(--muted); font-style: italic; line-height: 1.5; min-height: 2.5rem; }
  .input-mode-tabs { display: flex; gap: 0.5rem; }
  .mode-tab { flex: 1; padding: 0.6rem; text-align: center; border: 1.5px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500; background: var(--cream); color: var(--muted); transition: all 0.2s; }
  .mode-tab.active { background: var(--forest); color: #fff; border-color: var(--forest); }
  .start-btn { display: block; width: 100%; padding: 1.1rem; background: var(--ink); color: var(--gold-light); font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; border: none; border-radius: 5px; cursor: pointer; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 20px var(--shadow); }
  .start-btn:hover { background: var(--forest); transform: translateY(-1px); }
  #session-panel { display: none; animation: fadeUp 0.5s ease both; }
  .session-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
  .session-info h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; }
  .session-info p { font-size: 0.82rem; color: var(--muted); margin-top: 0.2rem; }
  .session-timer { font-family: 'DM Mono', monospace; font-size: 1.8rem; font-weight: 500; color: var(--ink); letter-spacing: 0.05em; }
  .session-timer.warning { color: var(--red); animation: pulse 1s infinite; }
  .role-card { background: var(--ink); color: var(--parchment); border-radius: 6px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem; display: flex; align-items: flex-start; gap: 1rem; }
  .role-avatar { width: 48px; height: 48px; min-width: 48px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
  .role-info h3 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 0.25rem; color: var(--gold-light); }
  .role-info p { font-size: 0.85rem; line-height: 1.6; opacity: 0.85; }
  .ai-speaking-banner { display: none; align-items: center; gap: 0.6rem; background: var(--ink); color: var(--gold-light); padding: 0.6rem 1rem; border-radius: 4px; font-size: 0.82rem; font-family: 'DM Mono', monospace; margin-bottom: 0.75rem; }
  .ai-speaking-banner.visible { display: flex; }
  .speaking-wave { display: flex; gap: 3px; align-items: center; }
  .speaking-wave span { display: inline-block; width: 3px; background: var(--gold); border-radius: 2px; animation: wave 0.8s infinite; }
  .speaking-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
  .speaking-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
  .speaking-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
  .speaking-wave span:nth-child(4) { height: 16px; animation-delay: 0.15s; }
  .speaking-wave span:nth-child(5) { height: 8px; animation-delay: 0.05s; }
  @keyframes wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
  .recording-status { display: none; align-items: center; gap: 0.75rem; background: #fff0f0; border: 1.5px solid var(--red-light); border-radius: 4px; padding: 0.6rem 1rem; margin-bottom: 0.75rem; font-size: 0.85rem; color: var(--red); font-family: 'DM Mono', monospace; }
  .recording-status.visible { display: flex; }
  .rec-dot { width: 10px; height: 10px; background: var(--red); border-radius: 50%; animation: pulse 1s infinite; flex-shrink: 0; }
  .processing-status { display: none; align-items: center; gap: 0.75rem; background: #f0f7ff; border: 1.5px solid #93c5fd; border-radius: 4px; padding: 0.6rem 1rem; margin-bottom: 0.75rem; font-size: 0.85rem; color: #1d4ed8; font-family: 'DM Mono', monospace; }
  .processing-status.visible { display: flex; }
  .conversation-box { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; height: 340px; overflow-y: auto; padding: 1.25rem; margin-bottom: 1rem; scroll-behavior: smooth; }
  .msg { display: flex; gap: 0.75rem; margin-bottom: 1.1rem; animation: fadeUp 0.3s ease both; }
  .msg.user { flex-direction: row-reverse; }
  .msg-avatar { width: 34px; height: 34px; min-width: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: 700; }
  .msg.ai .msg-avatar { background: var(--ink); color: var(--gold-light); }
  .msg.user .msg-avatar { background: var(--forest); color: #fff; }
  .msg-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.92rem; line-height: 1.6; }
  .msg.ai .msg-bubble { background: var(--cream); border: 1px solid var(--border); border-top-left-radius: 4px; }
  .msg.user .msg-bubble { background: var(--forest); color: #fff; border-top-right-radius: 4px; }
  .msg-time { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; font-family: 'DM Mono', monospace; }
  .msg.user .msg-time { text-align: right; }
  .feedback-inline { background: var(--gold-pale); border-left: 3px solid var(--gold); border-radius: 0 6px 6px 0; padding: 0.5rem 0.75rem; font-size: 0.8rem; color: var(--ink); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-inline strong { color: var(--forest); }
  .feedback-pronunciation { background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0; padding: 0.5rem 0.75rem; font-size: 0.8rem; color: var(--ink); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-pronunciation strong { color: #1d4ed8; }
  .thinking { display: flex; gap: 0.4rem; align-items: center; padding: 0.5rem 0; }
  .thinking-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: bounce 1.2s infinite; }
  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
  .input-area { display: flex; gap: 0.75rem; align-items: flex-end; margin-bottom: 1rem; }
  .text-input-wrap { flex: 1; }
  #text-input { width: 100%; padding: 0.85rem 1rem; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--ink); background: #fff; resize: none; transition: border-color 0.2s; min-height: 50px; max-height: 120px; }
  #text-input:focus { outline: none; border-color: var(--gold); }
  #text-input::placeholder { color: var(--muted); }
  .send-btn, .mic-btn { width: 50px; height: 50px; min-width: 50px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .send-btn { background: var(--ink); color: var(--gold-light); }
  .send-btn:hover { background: var(--forest); }
  .mic-btn { background: var(--cream); border: 1.5px solid var(--border); color: var(--muted); }
  .mic-btn.recording { background: var(--red); color: #fff; border-color: var(--red); }
  .mic-btn.processing { background: #3b82f6; color: #fff; border-color: #3b82f6; cursor: wait; }
  .mic-btn.waiting { background: #9ca3af; color: #fff; border-color: #9ca3af; cursor: not-allowed; }
  .mic-btn:hover:not(.recording):not(.processing):not(.waiting) { background: var(--border); }
  .session-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; }
  .ctrl-btn { padding: 0.55rem 1rem; border: 1.5px solid var(--border); background: var(--cream); color: var(--ink); border-radius: 4px; cursor: pointer; font-size: 0.82rem; font-weight: 500; font-family: 'DM Sans', sans-serif; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
  .ctrl-btn:hover { background: var(--border); }
  .ctrl-btn.danger { border-color: var(--red-light); color: var(--red); }
  .ctrl-btn.danger:hover { background: var(--red-light); color: #fff; }
  #score-panel { display: none; animation: fadeUp 0.5s ease both; }
  .score-header { text-align: center; margin-bottom: 2rem; }
  .score-header h2 { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 0.5rem; }
  .score-header p { color: var(--muted); }
  .score-big { display: flex; align-items: center; justify-content: center; margin-bottom: 2.5rem; }
  .score-circle { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--gold) 0%, var(--gold) var(--pct, 75%), var(--cream) var(--pct, 75%)); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 8px var(--gold-pale), 0 4px 20px var(--shadow); }
  .score-inner { width: 110px; height: 110px; background: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .score-num { font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 900; line-height: 1; }
  .score-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
  .criteria-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
  @media (max-width: 500px) { .criteria-grid { grid-template-columns: 1fr; } }
  .criterion-card { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; padding: 1rem 1.25rem; box-shadow: 0 2px 8px var(--shadow); }
  .criterion-card h4 { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.6rem; font-family: 'DM Mono', monospace; }
  .criterion-bar-wrap { height: 8px; background: var(--cream); border-radius: 4px; overflow: hidden; margin-bottom: 0.4rem; }
  .criterion-bar { height: 100%; border-radius: 4px; background: var(--gold); transition: width 1s ease; }
  .criterion-score { font-weight: 700; font-size: 1.1rem; }
  .criterion-comment { font-size: 0.8rem; color: var(--muted); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-section { background: var(--cream); border: 1.5px solid var(--border); border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem; }
  .feedback-section h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 0.75rem; }
  .feedback-section p { font-size: 0.9rem; line-height: 1.7; }
  .pronunciation-section { background: #eff6ff; border: 1.5px solid #bfdbfe; border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem; }
  .pronunciation-section h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 1rem; color: #1e40af; }
  .pronunciation-tip { background: #fff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 0.6rem; font-size: 0.85rem; line-height: 1.6; }
  .pronunciation-tip .word { font-family: 'DM Mono', monospace; font-weight: 600; color: #1d4ed8; }
  .pronunciation-tip .gujarati-note { color: #92400e; font-size: 0.78rem; margin-top: 0.25rem; display: block; }
  .errors-list { list-style: none; }
  .errors-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.87rem; line-height: 1.6; }
  .errors-list li:last-child { border-bottom: none; }
  .err-orig { color: var(--red); text-decoration: line-through; font-family: 'DM Mono', monospace; }
  .err-correct { color: var(--forest); font-family: 'DM Mono', monospace; font-weight: 600; }
  .score-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
  .score-actions button { padding: 0.8rem 1.75rem; border-radius: 4px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
  .btn-primary { background: var(--ink); color: var(--gold-light); border: none; }
  .btn-primary:hover { background: var(--forest); }
  .btn-secondary { background: transparent; color: var(--ink); border: 1.5px solid var(--border); }
  .btn-secondary:hover { background: var(--cream); }
  .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: var(--ink); color: var(--parchment); padding: 0.75rem 1.5rem; border-radius: 4px; font-size: 0.85rem; z-index: 999; animation: fadeUp 0.3s ease both; font-family: 'DM Mono', monospace; pointer-events: none; }
  .sr-badge { display: inline-block; font-size: 0.65rem; font-family: 'DM Mono', monospace; background: var(--forest); color: #fff; padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.4rem; vertical-align: middle; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
  button, a { touch-action: manipulation; }
</style>
<link rel="stylesheet" href="dark-mode.css">
</head>
<body>

<div id="auth-overlay">
  <div class="auth-spinner"></div>
  <p>Verifying access...</p>
</div>

<div id="access-denied" style="display:none; position:fixed; inset:0; background:var(--parchment); align-items:center; justify-content:center; z-index:999; flex-direction:column; gap:1.5rem; text-align:center; padding:2rem;">
  <div style="font-size:3rem;">ğŸ”’</div>
  <h2 style="font-family:'Playfair Display',serif; font-size:2rem; color:var(--red);">Access Restricted</h2>
  <p style="color:var(--muted); max-width:420px; line-height:1.6;">Please sign in to try AI Practice Partner â€” <strong>2 free conversations</strong> for everyone, no purchase needed to start!</p>
  <a href="/login.html" style="display:inline-block; padding:0.75rem 2rem; background:var(--ink); color:var(--gold-light); text-decoration:none; font-weight:600; border-radius:2px;">Sign In to Try Free</a>
</div>

<div id="main-app" style="display:none;">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">ğŸ‡©ğŸ‡ª</div>
      <div>
        <div class="topbar-title">Sprechen Buddy AI</div>
        <div class="topbar-sub">German Made Easy</div>
      </div>
    </div>
    <div class="topbar-user">
      <span class="user-badge" id="level-badge">A1</span>
      <span id="user-name" style="font-size:0.85rem; color:var(--muted);"></span>
      <a href="/dashboard.html" class="topbar-back">â† Dashboard</a>
    </div>
  </div>

  <div class="container">

    <!-- SETUP PANEL -->
    <div id="setup-panel">
      <div class="hero">
        <div class="hero-eyebrow">ğŸ¤– AI Conversation Partner</div>
        <h1>Practice German<br><span>anytime, alone.</span></h1>
        <p>Your personal AI partner plays real Goethe &amp; TELC exam roles. Speak or type â€” get instant grammar feedback and a final score.</p>
      </div>
      <div class="setup-grid">
        <div class="setup-card">
          <h3><span>ğŸ“š</span> Your Level</h3>
          <div class="level-tabs">
            <div class="level-tab active" onclick="setLevel('A1')">A1 Beginner</div>
            <div class="level-tab" onclick="setLevel('A2')">A2 Elementary</div>
          </div>
        </div>
        <div class="setup-card">
          <h3><span>ğŸ™ï¸</span> Input Mode <span class="sr-badge">Deepgram AI</span></h3>
          <div class="input-mode-tabs">
            <div class="mode-tab active" onclick="setInputMode('both')">ğŸ™ï¸ + âŒ¨ï¸ Both</div>
            <div class="mode-tab" onclick="setInputMode('voice')">ğŸ™ï¸ Voice only</div>
            <div class="mode-tab" onclick="setInputMode('text')">âŒ¨ï¸ Type only</div>
          </div>
        </div>
        <div class="setup-card" style="grid-column: 1 / -1;">
          <h3><span>ğŸ­</span> Choose a Scenario</h3>
          <select class="scenario-select" id="scenario-select" onchange="onScenarioChange()">
            <optgroup label="â€” A1 Scenarios â€”">
              <option value="a1_shop" data-level="A1" data-role="Shopkeeper" data-emoji="ğŸ›’" data-desc="You're a customer at a German supermarket. Ask for items, quantities, and prices.">ğŸ›’ At the Supermarket</option>
              <option value="a1_doctor" data-level="A1" data-role="Doctor" data-emoji="ğŸ¥" data-desc="You're at a German GP clinic. Describe your symptoms and understand basic advice.">ğŸ¥ At the Doctor</option>
              <option value="a1_hotel" data-level="A1" data-role="Hotel Receptionist" data-emoji="ğŸ¨" data-desc="Check into a German hotel. Ask about room types, prices, breakfast, and facilities.">ğŸ¨ Hotel Check-in</option>
              <option value="a1_cafe" data-level="A1" data-role="CafÃ© Waiter" data-emoji="â˜•" data-desc="Order food and drinks at a German cafÃ©. Ask about the menu and pay the bill.">â˜• At the CafÃ©</option>
              <option value="a1_directions" data-level="A1" data-role="Passerby" data-emoji="ğŸ—ºï¸" data-desc="You're lost in a German city. Ask for directions to key locations.">ğŸ—ºï¸ Asking for Directions</option>
              <option value="a1_phone" data-level="A1" data-role="Office Secretary" data-emoji="ğŸ“" data-desc="Make a simple phone call to book an appointment in German.">ğŸ“ Making an Appointment</option>
              <option value="a1_introduce" data-level="A1" data-role="New Neighbour" data-emoji="ğŸ‘‹" data-desc="Introduce yourself to a new German neighbour. Share your name, country, job, and hobbies.">ğŸ‘‹ Introducing Yourself</option>
              <option value="a1_transport" data-level="A1" data-role="Ticket Office Staff" data-emoji="ğŸš‚" data-desc="Buy a train or bus ticket at a German station. Ask about times and prices.">ğŸš‚ Buying a Train Ticket</option>
            </optgroup>
            <optgroup label="â€” A2 Scenarios â€”">
              <option value="a2_flat" data-level="A2" data-role="Landlord" data-emoji="ğŸ " data-desc="Discuss renting a flat in Germany. Ask about rent, deposit, and utilities.">ğŸ  Renting a Flat</option>
              <option value="a2_job" data-level="A2" data-role="HR Manager" data-emoji="ğŸ’¼" data-desc="Attend a simple job interview. Describe your experience and strengths.">ğŸ’¼ Job Interview</option>
              <option value="a2_bank" data-level="A2" data-role="Bank Clerk" data-emoji="ğŸ¦" data-desc="Open a bank account in Germany. Provide personal details and ask about fees.">ğŸ¦ Opening a Bank Account</option>
              <option value="a2_complaint" data-level="A2" data-role="Shop Manager" data-emoji="âš ï¸" data-desc="Return a faulty product and make a complaint politely in German.">âš ï¸ Making a Complaint</option>
              <option value="a2_party" data-level="A2" data-role="German Friend" data-emoji="ğŸ‰" data-desc="Discuss plans for a party. Talk about food, guests, location, and time.">ğŸ‰ Planning a Party</option>
              <option value="a2_health" data-level="A2" data-role="Pharmacist" data-emoji="ğŸ’Š" data-desc="Visit a German pharmacy. Describe symptoms and ask for medication.">ğŸ’Š At the Pharmacy</option>
              <option value="a2_school" data-level="A2" data-role="School Administrator" data-emoji="ğŸ«" data-desc="Enrol in a German school or language course. Ask about schedules and fees.">ğŸ« School Enrolment</option>
              <option value="a2_travel" data-level="A2" data-role="Travel Agent" data-emoji="âœˆï¸" data-desc="Book a holiday package. Discuss destinations, dates, and budget.">âœˆï¸ Booking a Holiday</option>
            </optgroup>
          </select>
          <div class="scenario-desc" id="scenario-desc">You're a customer at a German supermarket. Ask for items, quantities, and prices.</div>
        </div>
      </div>
      <div id="trial-counter-wrap">
        <span class="trial-counter-badge" id="trial-counter-text"></span>
      </div>
      <button class="start-btn" onclick="startSession()">ğŸ¬ Start Conversation</button>
    </div>

    <!-- SESSION PANEL -->
    <div id="session-panel">
      <div class="session-header">
        <div class="session-info">
          <h2 id="session-title">At the Supermarket</h2>
          <p id="session-subtitle">A1 Â· Shopkeeper Â· AI Partner</p>
        </div>
        <div class="session-timer" id="session-timer">20:00</div>
      </div>
      <div class="role-card">
        <div class="role-avatar" id="role-avatar">ğŸ›’</div>
        <div class="role-info">
          <h3 id="role-name">The Shopkeeper</h3>
          <p id="role-description">Your AI partner is playing a German shopkeeper. Respond in German. Don't worry about mistakes â€” you'll get feedback after!</p>
        </div>
      </div>
      <div class="ai-speaking-banner" id="ai-speaking-banner">
        <div class="speaking-wave"><span></span><span></span><span></span><span></span><span></span></div>
        ğŸ¤– AI speaking... mic activates when done
      </div>
      <div class="recording-status" id="recording-status">
        <div class="rec-dot"></div>
        ğŸ™ï¸ Recording... tap mic again to stop and send
      </div>
      <div class="processing-status" id="processing-status">
        â³ Transcribing your German with Deepgram AI...
      </div>
      <div class="conversation-box" id="conversation-box"></div>
      <div class="input-area" id="input-area">
        <div class="text-input-wrap">
          <textarea id="text-input" placeholder="Type in German... or tap ğŸ™ï¸ to speak" rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
        </div>
        <button class="mic-btn" id="mic-btn" onclick="toggleMic()" title="Tap to speak">ğŸ™ï¸</button>
        <button class="send-btn" onclick="sendMessage()">â¤</button>
      </div>
      <div class="session-controls">
        <button class="ctrl-btn" onclick="changeScenario()">ğŸ”„ Change Task</button>
        <button class="ctrl-btn" onclick="addTime()" id="add-time-btn">â±ï¸ +10 min</button>
        <button class="ctrl-btn" onclick="toggleFeedback()" id="feedback-btn">ğŸ’¡ Toggle Feedback</button>
        <button class="ctrl-btn danger" onclick="endSession()">ğŸ End &amp; Get Score</button>
      </div>
    </div>

    <!-- SCORE PANEL -->
    <div id="score-panel">
      <div class="score-header">
        <h2>ğŸ† Session Complete!</h2>
        <p id="score-scenario-label">Supermarket Â· A1 Â· AI Partner</p>
      </div>
      <div class="score-big">
        <div class="score-circle" id="score-circle">
          <div class="score-inner">
            <div class="score-num" id="score-num">â€”</div>
            <div class="score-label">/ 100</div>
          </div>
        </div>
      </div>
      <div class="criteria-grid">
        <div class="criterion-card">
          <h4>Vocabulary</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-vocab" style="width:0%"></div></div>
          <div class="criterion-score" id="score-vocab">â€”</div>
          <div class="criterion-comment" id="comment-vocab"></div>
        </div>
        <div class="criterion-card">
          <h4>Grammar</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-grammar" style="width:0%"></div></div>
          <div class="criterion-score" id="score-grammar">â€”</div>
          <div class="criterion-comment" id="comment-grammar"></div>
        </div>
        <div class="criterion-card">
          <h4>Fluency</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-fluency" style="width:0%"></div></div>
          <div class="criterion-score" id="score-fluency">â€”</div>
          <div class="criterion-comment" id="comment-fluency"></div>
        </div>
        <div class="criterion-card">
          <h4>Task Completion</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-task" style="width:0%"></div></div>
          <div class="criterion-score" id="score-task">â€”</div>
          <div class="criterion-comment" id="comment-task"></div>
        </div>
      </div>
      <div class="feedback-section">
        <h3>ğŸ“ Overall Feedback</h3>
        <p id="overall-feedback-text">Loading...</p>
      </div>
      <div class="pronunciation-section" id="pronunciation-section" style="display:none;">
        <h3>ğŸ—£ï¸ Pronunciation Guide for Your Words</h3>
        <p style="font-size:0.82rem; color:#1e40af; margin-bottom:1rem;">Based on what you said this session â€” tips specifically for Gujarati speakers:</p>
        <div id="pronunciation-tips-list"></div>
      </div>
      <div class="feedback-section">
        <h3>âœï¸ Grammar Corrections</h3>
        <ul class="errors-list" id="errors-list"></ul>
      </div>
      <div class="score-actions">
        <button class="btn-primary" onclick="practiceAgain()">ğŸ”„ Practice Again</button>
        <button class="btn-secondary" onclick="goToDashboard()">â† Back to Dashboard</button>
      </div>
    </div>

  </div>
</div>

<!-- TRIAL LIMIT MODAL -->
<div id="trial-limit-modal">
  <div class="trial-modal-card">
    <div class="trial-badge">âœ¨ Free Trial Ended</div>
    <h2>Enjoying it so far? ğŸ“</h2>
    <p>You've used your 2 free AI practice conversations. Buy the course to practise more â€” unlock <strong>unlimited conversations</strong>, full exam scores, and daily practice!</p>
    <a href="/payment.html" class="trial-modal-btn">ğŸ›’ Buy the Course to Practise More</a>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, getDoc, updateDoc, increment, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E",
  authDomain: "german-made-easy.firebaseapp.com",
  projectId: "german-made-easy",
  storageBucket: "german-made-easy.firebasestorage.app",
  messagingSenderId: "259276936055",
  appId: "1:259276936055:web:5c9b4916734d0271100772",
  measurementId: "G-B7JMB0G85L"
};

const PROXY_URL = 'https://ai-proxy.jeetupadhyay1204.workers.dev';
const MAX_TRIAL_CONVERSATIONS = 2;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let userProfile = null;
let isPaidStudent = false;
let selectedLevel = 'A1';
let selectedInputMode = 'both';
let selectedScenario = null;
let conversationHistory = [];
let sessionTimerInterval = null;
let sessionSeconds = 20 * 60;
let addTimeUsed = false;
let inlineFeedbackOn = true;
let isSpeaking = false;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let grammarErrors = [];
let wordsUsed = new Set();
let pronunciationNotes = [];
let lastLowConfidenceWords = [];

// â”€â”€ iOS Safari TTS unlock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Must be called inside a user gesture (tap) before AI speaks
let audioUnlocked = false;
function unlockAudio() {
  if (audioUnlocked || !window.speechSynthesis) return;
  const silent = new SpeechSynthesisUtterance('');
  silent.volume = 0;
  window.speechSynthesis.speak(silent);
  audioUnlocked = true;
}

// â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async (user) => {
  if (!user) { showAccessDenied(); return; }
  try {
    const snap = await getDoc(doc(db, 'users', user.uid));
    currentUser = user;
    if (snap.exists()) userProfile = snap.data();
    isPaidStudent = snap.exists() && !!snap.data().isPaidStudent;
    showApp();
  } catch(e) { showAccessDenied(); }
});

function showAccessDenied() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('access-denied').style.display = 'flex';
}
function showTrialLimitPopup() {
  document.getElementById('trial-limit-modal').classList.add('visible');
}
function updateTrialBadge() {
  if (isPaidStudent || !currentUser) return;
  const used = parseInt(localStorage.getItem(`aiTrialCount_${currentUser.uid}`) || '0', 10);
  const remaining = Math.max(0, MAX_TRIAL_CONVERSATIONS - used);
  document.getElementById('trial-counter-wrap').style.display = 'block';
  document.getElementById('trial-counter-text').textContent =
    remaining > 0 ? `ğŸ Free trial: ${remaining} conversation${remaining !== 1 ? 's' : ''} remaining` : 'ğŸ”’ Free trial used â€” buy the course to continue';
}
function showApp() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  if (userProfile?.level) setLevel(userProfile.level.toUpperCase() === 'A2' ? 'A2' : 'A1');
  document.getElementById('user-name').textContent = userProfile?.displayName || currentUser.email.split('@')[0];
  updateTrialBadge();
  onScenarioChange();
}

// â”€â”€ Setup controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setLevel = (l) => {
  selectedLevel = l;
  document.querySelectorAll('.level-tab').forEach(t => t.classList.toggle('active', t.textContent.startsWith(l)));
  document.getElementById('level-badge').textContent = l;
};
window.setInputMode = (m) => {
  selectedInputMode = m;
  document.querySelectorAll('.mode-tab').forEach(t =>
    t.classList.toggle('active', t.getAttribute('onclick').includes(`'${m}'`)));
};
window.onScenarioChange = () => {
  const sel = document.getElementById('scenario-select');
  document.getElementById('scenario-desc').textContent = sel.options[sel.selectedIndex].dataset.desc || '';
};

// â”€â”€ Start session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startSession = async () => {
  if (!isPaidStudent) {
    const trialKey = `aiTrialCount_${currentUser.uid}`;
    const trialCount = parseInt(localStorage.getItem(trialKey) || '0', 10);
    if (trialCount >= MAX_TRIAL_CONVERSATIONS) { showTrialLimitPopup(); return; }
    localStorage.setItem(trialKey, String(trialCount + 1));
  }

  unlockAudio(); // â† iOS fix: unlock TTS on this user tap

  const sel = document.getElementById('scenario-select');
  const opt = sel.options[sel.selectedIndex];
  selectedScenario = { id: sel.value, title: opt.text, level: opt.dataset.level, role: opt.dataset.role, emoji: opt.dataset.emoji, desc: opt.dataset.desc };

  document.getElementById('setup-panel').style.display = 'none';
  document.getElementById('session-panel').style.display = 'block';
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent = `${selectedScenario.level} Â· ${selectedScenario.role} Â· AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;

  const micBtn = document.getElementById('mic-btn');
  const textInput = document.getElementById('text-input');
  if (selectedInputMode === 'voice') { textInput.style.display = 'none'; micBtn.style.display = 'flex'; }
  else if (selectedInputMode === 'text') { micBtn.style.display = 'none'; }
  else { textInput.style.display = ''; micBtn.style.display = 'flex'; }

  conversationHistory = [];
  grammarErrors = [];
  wordsUsed = new Set();
  pronunciationNotes = [];
  lastLowConfidenceWords = [];
  sessionSeconds = 20 * 60;
  addTimeUsed = false;
  document.getElementById('add-time-btn').disabled = false;
  document.getElementById('conversation-box').innerHTML = '';
  updateTimer();

  sessionTimerInterval = setInterval(() => { sessionSeconds--; updateTimer(); if (sessionSeconds <= 0) endSession(); }, 1000);
  await sendAIMessage(null, true);
};

function updateTimer() {
  const m = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
  const s = (sessionSeconds % 60).toString().padStart(2, '0');
  const el = document.getElementById('session-timer');
  el.textContent = `${m}:${s}`;
  el.classList.toggle('warning', sessionSeconds < 120);
}

// â”€â”€ Send typed message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.sendMessage = async () => {
  const inp = document.getElementById('text-input');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';

  text.toLowerCase().split(/\s+/).forEach(w => {
    const c = w.replace(/[^a-zÃ¤Ã¶Ã¼ÃŸ]/gi, '');
    if (c.length > 2) wordsUsed.add(c);
  });

  appendMessage('user', text);

  // Attach pronunciation flags invisibly if Deepgram flagged any words
  const lowConfWords = [...lastLowConfidenceWords];
  lastLowConfidenceWords = [];

  let messageContent = text;
  if (lowConfWords.length > 0) {
    const flagList = lowConfWords.map(w => `"${w.word}" (${w.confidence}% confident)`).join(', ');
    messageContent = `${text}\n\n[PRONUNCIATION_FLAGS: Deepgram had low confidence on: ${flagList}. Note likely pronunciation issues for these words in your feedback field only. Do not mention this in your German reply.]`;
  }

  conversationHistory.push({ role: 'user', content: messageContent });
  await sendAIMessage(text);
};

// â”€â”€ MIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleMic = async () => {
  unlockAudio(); // â† iOS fix: also unlock on mic tap

  if (isSpeaking) { toast('â³ Wait for AI to finish speaking...'); return; }
  if (isRecording) { mediaRecorder.stop(); return; }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      isRecording = false;
      setMicState('processing');
      const audioBlob = new Blob(audioChunks, { type: mimeType });
      await transcribeWithDeeogram(audioBlob);
    };

    mediaRecorder.start();
    isRecording = true;
    setMicState('recording');

  } catch(err) {
    if (err.name === 'NotAllowedError') toast('ğŸ™ï¸ Microphone permission denied.');
    else toast('Mic error: ' + err.message);
  }
};

// â”€â”€ Transcribe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function transcribeWithDeeogram(audioBlob) {
  try {
    const arrayBuffer = await audioBlob.arrayBuffer();
    const res = await fetch(`${PROXY_URL}/transcribe`, {
      method: 'POST',
      headers: { 'Content-Type': audioBlob.type, 'Authorization': `Bearer ${await currentUser.getIdToken()}` },
      body: arrayBuffer
    });

    if (!res.ok) throw new Error('Transcription failed: ' + res.status);
    const data = await res.json();
    const transcript = (data.transcript || '').trim();
    setMicState('idle');

    if (!transcript) { toast('ğŸ¤” No speech detected â€” try speaking closer to mic.'); return; }

    lastLowConfidenceWords = data.lowConfidenceWords || [];
    document.getElementById('text-input').value = transcript;

    if (lastLowConfidenceWords.length > 0) {
      toast(`âœ… Heard: "${transcript}" Â· âš ï¸ Unclear: ${lastLowConfidenceWords.map(w => w.word).join(', ')}`);
    } else {
      toast(`âœ… Heard: "${transcript}"`);
    }

    await window.sendMessage();
  } catch(err) {
    setMicState('idle');
    toast('Transcription error: ' + err.message);
    console.error(err);
  }
}

function setMicState(state) {
  const micBtn = document.getElementById('mic-btn');
  const recStatus = document.getElementById('recording-status');
  const procStatus = document.getElementById('processing-status');
  micBtn.classList.remove('recording', 'processing', 'waiting');
  recStatus.classList.remove('visible');
  procStatus.classList.remove('visible');
  if (state === 'recording') { micBtn.textContent = 'â¹ï¸'; micBtn.classList.add('recording'); recStatus.classList.add('visible'); }
  else if (state === 'processing') { micBtn.textContent = 'â³'; micBtn.classList.add('processing'); procStatus.classList.add('visible'); }
  else if (state === 'waiting') { micBtn.textContent = 'ğŸ™ï¸'; micBtn.classList.add('waiting'); }
  else { micBtn.textContent = 'ğŸ™ï¸'; }
}

// â”€â”€ AI Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAIMessage(userDisplayText, isOpening = false) {
  showThinking();
  const messages = isOpening ? [{ role: 'user', content: 'START_CONVERSATION' }] : [...conversationHistory];

  try {
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await currentUser.getIdToken()}` },
      body: JSON.stringify({ systemPrompt: buildSystemPrompt(isOpening), messages, userId: currentUser.uid })
    });
    if (!res.ok) throw new Error('Proxy error ' + res.status);
    const data = await res.json();
    removeThinking();

    let parsed;
    try { const m = (data.reply || '').match(/\{[\s\S]*\}/); parsed = m ? JSON.parse(m[0]) : { reply: data.reply || '', feedback: null }; }
    catch { parsed = { reply: data.reply || '', feedback: null }; }

    const aiText = parsed.reply || data.reply || '';
    conversationHistory.push({ role: 'assistant', content: aiText });
    appendMessage('ai', aiText, parsed.feedback);

    if (parsed.feedback?.error && userDisplayText) {
      grammarErrors.push({ original: userDisplayText, corrected: parsed.feedback.corrected, note: parsed.feedback.note });
    }
    if (parsed.feedback?.pronunciationWord && parsed.feedback?.pronunciationNote) {
      pronunciationNotes.push({ word: parsed.feedback.pronunciationWord, note: parsed.feedback.pronunciationNote });
    }

    await speakText(aiText);

  } catch(err) {
    removeThinking();
    appendMessage('ai', 'Entschuldigung! Bitte versuche es nochmal. ğŸ™');
    setAISpeaking(false);
    console.error(err);
  }
}

function buildSystemPrompt(isOpening) {
  const { level, role, title, desc } = selectedScenario;
  return `You are an AI German language partner for ${level} learners, playing the role of a ${role} in a "${title}" scenario.

SCENARIO: ${desc}

RULES:
- Stay in character as the ${role}. ALWAYS reply in German at ${level} level.
- Keep sentences short and clear.
- If the user speaks English, gently nudge them back to German in character.
- Put ALL feedback in the feedback JSON field only, never in your German reply.

PRONUNCIATION RULE:
- If the user message contains [PRONUNCIATION_FLAGS], those words were unclear to speech recognition â€” the student likely mispronounced them.
- Add "pronunciationWord" (the most important flagged word) and "pronunciationNote" (one simple tip for Gujarati speakers) to your feedback.
- Example: 'mÃ¶chte' â€” say "MÅ’CH-teh", not "mok-teh". The ch is a soft throat sound, not a hard K.
- Only comment on ONE word per response. NEVER mention pronunciation inside your German reply.

RESPONSE FORMAT â€” always valid JSON:
{
  "reply": "<your in-character German response>",
  "feedback": ${inlineFeedbackOn ? `{
    "error": true/false,
    "corrected": "<corrected version or null>",
    "note": "<brief English grammar tip>",
    "praise": "<optional short praise>",
    "pronunciationWord": "<the flagged word or null>",
    "pronunciationNote": "<one sentence tip for Gujarati speakers or null>"
  }` : 'null'}
}

${isOpening ? 'Opening line: greet the student in character to start the scenario.' : ''}
Keep the conversation natural. Ask follow-up questions.`;
}

// â”€â”€ TTS â€” iOS Safari fixed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setAISpeaking(speaking) {
  isSpeaking = speaking;
  document.getElementById('ai-speaking-banner').classList.toggle('visible', speaking);
  if (speaking) setMicState('waiting');
  else setMicState('idle');
}

function speakText(text) {
  return new Promise((resolve) => {
    if (!window.speechSynthesis) { resolve(); return; }

    // iOS Safari fix: cancel first, then wait before speaking
    window.speechSynthesis.cancel();
    setAISpeaking(true);

    const utt = new SpeechSynthesisUtterance(text);
    utt.lang = 'de-DE';
    utt.rate = 0.9;
    utt.pitch = 1.05;

    const doSpeak = () => {
      const voices = window.speechSynthesis.getVoices();
      // Prefer premium neural voices â€” avoid compact (robotic) ones
      const germanVoice =
        voices.find(v => v.lang.startsWith('de') && v.name.includes('Anna')) ||
        voices.find(v => v.lang.startsWith('de') && v.name.includes('Markus')) ||
        voices.find(v => v.lang.startsWith('de') && v.name.includes('Helena')) ||
        voices.find(v => v.lang.startsWith('de') && !v.name.toLowerCase().includes('compact')) ||
        voices.find(v => v.lang.startsWith('de'));
      if (germanVoice) utt.voice = germanVoice;

      utt.onend = () => { setAISpeaking(false); resolve(); };
      utt.onerror = () => { setAISpeaking(false); resolve(); };
      window.speechSynthesis.speak(utt);

      // Failsafe timeout â€” iOS sometimes doesn't fire onend
      const estimatedMs = Math.max(3000, text.length * 70);
      setTimeout(() => { setAISpeaking(false); resolve(); }, estimatedMs);
    };

    // iOS needs a small delay after cancel() before speaking again
    setTimeout(() => {
      if (window.speechSynthesis.getVoices().length > 0) doSpeak();
      else { window.speechSynthesis.onvoiceschanged = doSpeak; }
    }, 150);
  });
}

// â”€â”€ UI helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(who, text, feedback) {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  const avatar = who === 'ai' ? (selectedScenario?.emoji || 'ğŸ¤–') : 'ğŸ‘¤';

  let fb = '';
  if (feedback && inlineFeedbackOn) {
    if (feedback.error && feedback.corrected) {
      fb += `<div class="feedback-inline">âœï¸ <strong>Korrektur:</strong> ${escHtml(feedback.corrected)} â€” <em>${escHtml(feedback.note || '')}</em></div>`;
    } else if (feedback.praise) {
      fb += `<div class="feedback-inline">âœ… ${escHtml(feedback.praise)}</div>`;
    }
    if (feedback.pronunciationWord && feedback.pronunciationNote) {
      fb += `<div class="feedback-pronunciation">ğŸ—£ï¸ <strong>${escHtml(feedback.pronunciationWord)}:</strong> ${escHtml(feedback.pronunciationNote)}</div>`;
    }
  }

  div.innerHTML = `<div class="msg-avatar">${avatar}</div><div><div class="msg-bubble">${escHtml(text)}</div>${fb}<div class="msg-time">${now}</div></div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showThinking() {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = 'msg ai'; div.id = 'thinking-indicator';
  div.innerHTML = `<div class="msg-avatar">${selectedScenario?.emoji || 'ğŸ¤–'}</div><div class="msg-bubble"><div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div></div>`;
  box.appendChild(div); box.scrollTop = box.scrollHeight;
}
function removeThinking() { document.getElementById('thinking-indicator')?.remove(); }
function escHtml(t) { return (t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'); }
function toast(msg, dur = 3500) {
  const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t); setTimeout(() => t.remove(), dur);
}

// â”€â”€ Session controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeScenario = async () => {
  const all = [...document.getElementById('scenario-select').options];
  const same = all.filter(o => o.dataset.level === selectedScenario.level && o.value !== selectedScenario.id);
  if (!same.length) { toast('No more scenarios for this level!'); return; }
  const pick = same[Math.floor(Math.random() * same.length)];
  selectedScenario = { id: pick.value, title: pick.text, level: pick.dataset.level, role: pick.dataset.role, emoji: pick.dataset.emoji, desc: pick.dataset.desc };
  conversationHistory = []; pronunciationNotes = []; lastLowConfidenceWords = [];
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent = `${selectedScenario.level} Â· ${selectedScenario.role} Â· AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;
  document.getElementById('conversation-box').innerHTML = '';
  toast(`ğŸ”„ New scenario: ${selectedScenario.title}`);
  await sendAIMessage(null, true);
};

window.addTime = () => {
  if (addTimeUsed) { toast('You can only add time once.'); return; }
  sessionSeconds += 10 * 60; addTimeUsed = true;
  document.getElementById('add-time-btn').disabled = true;
  toast('â±ï¸ +10 minutes added!');
};

window.toggleFeedback = () => {
  inlineFeedbackOn = !inlineFeedbackOn;
  document.getElementById('feedback-btn').textContent = inlineFeedbackOn ? 'ğŸ’¡ Toggle Feedback' : 'ğŸ’¡ Feedback Off';
  toast(inlineFeedbackOn ? 'ğŸ’¡ Feedback ON' : 'ğŸ”• Feedback OFF');
};

// â”€â”€ End session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.endSession = async () => {
  clearInterval(sessionTimerInterval);
  window.speechSynthesis?.cancel();
  setAISpeaking(false);
  if (isRecording && mediaRecorder) mediaRecorder.stop();

  document.getElementById('session-panel').style.display = 'none';
  document.getElementById('score-panel').style.display = 'block';
  document.getElementById('score-scenario-label').textContent = `${selectedScenario.title} Â· ${selectedScenario.level} Â· AI Partner`;

  const ep = buildEvaluationPrompt();
  try {
    const res = await fetch(PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await currentUser.getIdToken()}` },
      body: JSON.stringify({ systemPrompt: ep.system, messages: ep.messages, userId: currentUser.uid, maxTokens: 1000 })
    });
    const data = await res.json();
    let eval_ = {};
    try { const m = (data.reply || '').match(/\{[\s\S]*\}/); eval_ = m ? JSON.parse(m[0]) : {}; } catch {}
    displayScore(eval_);
    await saveSession(eval_);
  } catch(e) { console.error(e); displayScore({}); }
};

function buildEvaluationPrompt() {
  const transcript = conversationHistory.map(m => `${m.role === 'user' ? 'Student' : 'AI'}: ${m.content}`).join('\n');
  const wordList = [...wordsUsed].slice(0, 20).join(', ');
  const pronNotesText = pronunciationNotes.length > 0
    ? pronunciationNotes.map(n => `${n.word}: ${n.note}`).join('; ')
    : 'none collected';
  return {
    system: `You are a Goethe/TELC German exam evaluator for ${selectedScenario.level} level.
Evaluate the student's German. Reply ONLY with valid JSON:
{
  "overall":<0-100>,"vocabulary":<0-100>,"grammar":<0-100>,"fluency":<0-100>,"taskCompletion":<0-100>,
  "vocabComment":"<1 sentence>","grammarComment":"<1 sentence>","fluencyComment":"<1 sentence>","taskComment":"<1 sentence>",
  "overallFeedback":"<3-4 sentences constructive English feedback>",
  "topErrors":[{"original":"","corrected":"","note":""}],
  "pronunciationTips":[{"word":"","wrongWay":"<how Gujarati speakers typically say it>","rightWay":"<simple English phonetics>","gujaratiNote":"<Gujarati-specific tip>"}]
}
Real-time pronunciation issues already noted this session: ${pronNotesText}
Focus pronunciationTips on these words the student actually used: ${wordList}. Give 3-5 tips most relevant for Gujarati mother-tongue speakers (e.g. Wâ†’V sound, Zâ†’TS, Ã¤, Ã¼, ch, final -er not rolled).`,
    messages: [{ role: 'user', content: `Transcript:\n\n${transcript}\n\nPlease evaluate.` }]
  };
}

function displayScore(e) {
  const o = e.overall ?? 65, v = e.vocabulary ?? 60, g = e.grammar ?? 60, f = e.fluency ?? 60, t = e.taskCompletion ?? 60;
  document.getElementById('score-num').textContent = o;
  document.getElementById('score-circle').style.setProperty('--pct', `${o}%`);

  const setBar = (bid, val, comment, cid, sid) => setTimeout(() => {
    document.getElementById(bid).style.width = `${val}%`;
    document.getElementById(sid).textContent = `${val}/100`;
    document.getElementById(cid).textContent = comment || '';
  }, 200);
  setBar('bar-vocab', v, e.vocabComment, 'comment-vocab', 'score-vocab');
  setBar('bar-grammar', g, e.grammarComment, 'comment-grammar', 'score-grammar');
  setBar('bar-fluency', f, e.fluencyComment, 'comment-fluency', 'score-fluency');
  setBar('bar-task', t, e.taskComment, 'comment-task', 'score-task');

  document.getElementById('overall-feedback-text').textContent = e.overallFeedback || 'Great effort! Keep practising every day.';

  if (e.pronunciationTips?.length) {
    document.getElementById('pronunciation-section').style.display = 'block';
    const list = document.getElementById('pronunciation-tips-list');
    list.innerHTML = '';
    e.pronunciationTips.forEach(tip => {
      const d = document.createElement('div'); d.className = 'pronunciation-tip';
      d.innerHTML = `<div style="margin-bottom:0.3rem"><span class="word">${escHtml(tip.word)}</span></div>
<div>âŒ Often said as: <span style="color:var(--red);font-family:'DM Mono',monospace">${escHtml(tip.wrongWay || 'â€”')}</span></div>
<div>âœ… Should sound like: <span style="color:var(--forest);font-style:italic">${escHtml(tip.rightWay || 'â€”')}</span></div>
${tip.gujaratiNote ? `<span class="gujarati-note">ğŸ’¡ ${escHtml(tip.gujaratiNote)}</span>` : ''}`;
      list.appendChild(d);
    });
  }

  const allErr = [...grammarErrors, ...(e.topErrors || [])];
  const errList = document.getElementById('errors-list');
  errList.innerHTML = '';
  if (!allErr.length) { errList.innerHTML = '<li>No major errors â€” excellent! ğŸ‰</li>'; }
  else allErr.slice(0, 6).forEach(err => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="err-orig">${escHtml(err.original || '')}</span> â†’ <span class="err-correct">${escHtml(err.corrected || '')}</span><br><small>${escHtml(err.note || '')}</small>`;
    errList.appendChild(li);
  });
}

async function saveSession(eval_) {
  try {
    await updateDoc(doc(db, 'users', currentUser.uid), { aiSessionsCompleted: increment(1), totalPoints: increment(30), lastAiSession: serverTimestamp() });
    const { addDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await addDoc(collection(db, 'aiSessions'), { userId: currentUser.uid, scenario: selectedScenario.id, level: selectedScenario.level, score: eval_.overall ?? 0, timestamp: serverTimestamp() });
  } catch(e) { console.error(e); }
}

window.practiceAgain = () => { document.getElementById('score-panel').style.display = 'none'; document.getElementById('setup-panel').style.display = 'block'; updateTrialBadge(); };
window.goToDashboard = () => { window.location.href = '/dashboard.html'; };
</script>
</body>
</html>
