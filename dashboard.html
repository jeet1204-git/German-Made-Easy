<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - German Made Easy</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        .sprechen-card-active { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); border: 2px solid #FF6B35; }
        .sprechen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sprechen-icon { font-size: 48px; }
        .sprechen-badge { display: flex; align-items: center; gap: 8px; background: #10b981; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; }
        .badge-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
        .sprechen-card-active h3 { font-size: 24px; font-weight: 700; color: #1A1A2E; margin-bottom: 12px; }
        .sprechen-description { color: #666; font-size: 16px; line-height: 1.6; margin-bottom: 30px; }
        .sprechen-features { display: grid; gap: 20px; margin-bottom: 30px; }
        .feature-item { display: flex; gap: 15px; align-items: flex-start; }
        .feature-icon { font-size: 28px; flex-shrink: 0; }
        .feature-text { flex: 1; }
        .feature-text strong { font-size: 16px; font-weight: 700; color: #1A1A2E; display: block; margin-bottom: 4px; }
        .feature-text p { font-size: 14px; color: #666; margin: 0; }
        .sprechen-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: #f8f8f8; border-radius: 12px; padding: 20px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: 900; color: #FF6B35; margin-bottom: 5px; }
        .stat-label { font-size: 13px; color: #666; font-weight: 600; }
        .btn-practice-now { width: 100%; padding: 18px; background: linear-gradient(135deg, #FF6B35, #004E89); color: white; border: none; border-radius: 12px; font-size: 18px; font-family: 'Outfit', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-practice-now:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,107,53,0.4); }
        .sprechen-note { text-align: center; color: #666; font-size: 14px; margin-top: 20px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: #f5f5f5; min-height: 100vh; overflow-x: hidden; }
        nav { background: white; padding: 20px 40px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-container { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: 900; background: linear-gradient(135deg, #FF6B35, #004E89); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .user-info { display: flex; gap: 20px; align-items: center; }
        .user-email { font-weight: 600; color: #1A1A2E; }
        .btn-logout { padding: 10px 25px; border-radius: 25px; font-weight: 600; background: #FF6B35; color: white; border: none; cursor: pointer; transition: all 0.3s; }
        .btn-logout:hover { background: #004E89; }
        .btn-leaderboard { padding: 10px 25px; border-radius: 25px; font-weight: 600; background: white; color: #FF6B35; border: 2px solid #FF6B35; cursor: pointer; text-decoration: none; transition: all 0.3s; display: inline-block; }
        .btn-leaderboard:hover { background: #FF6B35; color: white; }
        .dashboard-container { max-width: 1400px; margin: 40px auto; padding: 0 40px; }
        .welcome-header { margin-bottom: 36px; }
        .welcome-header h1 { font-size: 36px; color: #1A1A2E; margin-bottom: 16px; }
        .stat-chips { display: flex; gap: 12px; flex-wrap: wrap; }
        .stat-chip { display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px; border-radius: 50px; font-size: 14px; font-weight: 600; background: #FFF3ED; color: #FF6B35; border: 1px solid rgba(255,107,53,0.2); }
        .section-heading { font-size: 24px; font-weight: 700; color: #1A1A2E; margin-bottom: 20px; }
        .courses-section { margin-bottom: 40px; }
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .course-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); transition: all 0.3s; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.12); }
        .course-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .course-level { font-size: 36px; font-weight: 900; color: #FF6B35; }
        .access-badge { background: #10b981; color: white; padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .course-title { font-size: 24px; font-weight: 700; margin-bottom: 15px; color: #1A1A2E; }
        .course-description { color: #666; margin-bottom: 20px; line-height: 1.6; }
        .course-stats { display: flex; gap: 16px; margin-bottom: 20px; }
        .course-stat { display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 600; color: #1A1A2E; background: #f8f8f8; padding: 8px 14px; border-radius: 10px; }
        .course-progress { margin-bottom: 20px; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #666; }
        .progress-bar { height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #FF6B35, #004E89); border-radius: 10px; transition: width 0.5s ease; }
        .btn-access { width: 100%; padding: 14px; background: linear-gradient(135deg, #FF6B35, #004E89); color: white; border: none; border-radius: 12px; font-size: 16px; font-family: 'Outfit', sans-serif; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-access:hover { transform: scale(1.02); box-shadow: 0 5px 20px rgba(255,107,53,0.4); }
        .empty-state { text-align: center; padding: 80px 20px; background: white; border-radius: 20px; }
        .empty-state h3 { font-size: 28px; margin-bottom: 15px; color: #1A1A2E; }
        .empty-state p { font-size: 18px; color: #666; margin-bottom: 30px; }
        .btn-browse { padding: 16px 40px; background: #FF6B35; color: white; text-decoration: none; border-radius: 50px; font-weight: 700; display: inline-block; transition: all 0.3s; }
        .btn-browse:hover { background: #004E89; transform: translateY(-2px); }
        .leaderboard-section { margin-bottom: 40px; }
        .leaderboard-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .leaderboard-list { list-style: none; }
        .leaderboard-row { display: flex; align-items: center; padding: 14px 16px; border-radius: 12px; margin-bottom: 8px; transition: background 0.2s; }
        .leaderboard-row:last-child { margin-bottom: 0; }
        .leaderboard-row:nth-child(odd) { background: #fafafa; }
        .leaderboard-row.current-user { background: #FFF3ED; border: 2px solid #FF6B35; }
        .lb-rank { font-size: 18px; font-weight: 800; color: #1A1A2E; width: 36px; text-align: center; flex-shrink: 0; }
        .lb-rank.gold { color: #f59e0b; }
        .lb-rank.silver { color: #9ca3af; }
        .lb-rank.bronze { color: #cd7f32; }
        .lb-name { flex: 1; font-weight: 600; color: #1A1A2E; margin-left: 12px; }
        .lb-score { font-weight: 700; color: #FF6B35; margin-right: 16px; flex-shrink: 0; }
        .lb-streak { font-size: 13px; color: #666; flex-shrink: 0; }
        .leaderboard-note { font-size: 13px; color: #999; margin-top: 16px; text-align: center; }
        .leaderboard-empty { text-align: center; padding: 30px; color: #666; font-size: 16px; }
        .sprechen-section { margin-bottom: 40px; }
        .loading-screen { display: flex; align-items: center; justify-content: center; min-height: 400px; }
        .loading-spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #FF6B35; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            nav { padding: 12px 16px; }
            .nav-container { flex-wrap: wrap; gap: 8px; }
            .logo { font-size: 18px; }
            .user-info { flex-wrap: wrap; gap: 8px; width: 100%; }
            .user-email { width: 100%; text-align: center; font-size: 13px; }
            .btn-leaderboard, .btn-logout { flex: 1; text-align: center; padding: 8px 12px; font-size: 13px; }
            .dashboard-container { padding: 0 16px; margin: 20px auto; }
            .welcome-header h1 { font-size: 26px; }
            .stat-chips { gap: 8px; }
            .stat-chip { font-size: 13px; padding: 6px 14px; }
            .courses-grid { grid-template-columns: 1fr; }
            .course-stats { flex-wrap: wrap; gap: 8px; }
            .leaderboard-row { padding: 12px; }
            .lb-score { margin-right: 8px; }
            .sprechen-card-active { padding: 30px 20px; }
            .sprechen-stats { grid-template-columns: 1fr; }
        }
        .ai-partner-banner { display: none; background: linear-gradient(135deg, #1A1A2E 0%, #004E89 100%); border-radius: 16px; padding: 22px 26px; margin: 0 0 28px 0; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap; box-shadow: 0 8px 30px rgba(0,78,137,0.25); border: 1.5px solid rgba(255,210,63,0.2); }
        .ai-partner-banner.visible { display: flex; }
        .ai-banner-left { display: flex; align-items: center; gap: 14px; }
        .ai-banner-icon { font-size: 1.9rem; background: rgba(255,210,63,0.15); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ai-banner-text h4 { color: #FFD23F; font-size: 0.93rem; font-weight: 800; margin-bottom: 2px; }
        .ai-banner-text p { color: rgba(255,255,255,0.8); font-size: 0.8rem; line-height: 1.4; margin: 0; }
        .btn-ai-partner { display: inline-flex; align-items: center; gap: 7px; padding: 10px 20px; background: #FFD23F; color: #1A1A2E; font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 0.88rem; border: none; border-radius: 9px; cursor: pointer; transition: all 0.25s; white-space: nowrap; box-shadow: 0 4px 14px rgba(255,210,63,0.4); text-decoration: none; }
        .btn-ai-partner:hover { background: #fff; transform: translateY(-2px); }
        button, a { touch-action: manipulation; }
    </style>
</head>
<body>
<nav>
    <div class="nav-container">
        <a href="index.html" class="logo" style="text-decoration:none;">German Made Easy</a>
        <div class="user-info">
            <span class="user-email" id="userEmail">Loading...</span>
            <a href="leaderboard.html" class="btn-leaderboard">üèÜ Leaderboard</a>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>
</nav>

<div class="ai-partner-banner" id="aiPartnerBanner">
    <div class="ai-banner-left">
        <div class="ai-banner-icon">ü§ñ</div>
        <div class="ai-banner-text">
            <h4>üá©üá™ AI Practice Partner ‚Äî Your Exclusive Benefit</h4>
            <p>Practise German anytime with AI. Real Goethe/TELC scenarios ‚Ä¢ Instant feedback ‚Ä¢ Score report.</p>
        </div>
    </div>
    <a href="ai-partner.html" class="btn-ai-partner">Start Practising ‚Üí</a>
</div>

<div class="dashboard-container" id="dashboardContent">
    <div class="loading-screen"><div class="loading-spinner"></div></div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { getFirestore, doc, getDoc, updateDoc, setDoc, serverTimestamp, collection, query, orderBy, limit, getDocs, where, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
    apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E",
    authDomain: "german-made-easy.firebaseapp.com",
    projectId: "german-made-easy",
    storageBucket: "german-made-easy.firebasestorage.app",
    messagingSenderId: "259276936055",
    appId: "1:259276936055:web:5c9b4916734d0271100772",
    measurementId: "G-B7JMB0G85L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.logout = async function() {
    try { await signOut(auth); window.location.href = 'index.html'; } catch(e) { alert('Error logging out. Please try again.'); }
};
window.startSprechenBuddy = function() { window.location.href = 'sprechen-buddy.html'; };

function getFirstName(n) { return (n || '').split(' ')[0] || 'Student'; }
function deriveLevel(courses) {
    if (!courses || !courses.length) return 'A1';
    for (const c of courses) { if (c.includes('A2')) return 'A2'; if (c.includes('A1')) return 'A1'; }
    return 'A1';
}
function getCourseUrl(name) {
    if (name.includes('A2')) return 'course-a2.html';
    if (name.includes('A1')) return 'course-a1.html';
    return '#';
}
function escapeHtml(str) { const d = document.createElement('div'); d.appendChild(document.createTextNode(String(str||''))); return d.innerHTML; }

function getWeekId() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const days = Math.floor((now - start) / 86400000);
    const week = Math.ceil((days + start.getDay() + 1) / 7);
    return now.getFullYear() + '-W' + String(week).padStart(2, '0');
}

function calculateBadge(streakDays, totalScore, joinedAt) {
    if (streakDays >= 14) return 'üî• On Fire';
    if (streakDays >= 7) return '‚ö° Consistent';
    if (totalScore >= 200) return 'üöÄ Rising Star';
    if (joinedAt) {
        const d = joinedAt.toDate ? joinedAt.toDate() : new Date(joinedAt);
        if ((Date.now() - d) / 86400000 <= 7) return 'üå± New Learner';
    }
    return 'üìö Learning';
}

// ‚îÄ‚îÄ POINTS PER LOGIN: 5 pts, cap at 1 per day ‚îÄ‚îÄ
const DAILY_LOGIN_POINTS = 5;

onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'login.html'; return; }
    document.getElementById('userEmail').textContent = user.email;

    try {
        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        let userData = userSnap.exists() ? userSnap.data() : {};

        if (userData.isPaidStudent) document.getElementById('aiPartnerBanner')?.classList.add('visible');

        // ‚îÄ‚îÄ DERIVE LEVEL ‚îÄ‚îÄ
        const enrolledCourses = userData.enrolledCourses || [];
        const userLevel = userData.level || deriveLevel(enrolledCourses);

        // ‚îÄ‚îÄ STREAK & SCORE CALCULATION ‚îÄ‚îÄ
        // totalScore and weeklyScore are CUMULATIVE ‚Äî we never recalculate from scratch.
        // We only ADD points for today's login if we haven't already today.
        const now = new Date();
        let streakDays = userData.streakDays || 1;
        let totalScore = userData.totalScore || 0;
        let weeklyScore = userData.weeklyScore || 0;
        let todayAlreadyCounted = false;

        if (userData.lastActive) {
            const lastActive = userData.lastActive.toDate ? userData.lastActive.toDate() : new Date(userData.lastActive);
            const diffHours = (now - lastActive) / 3600000;

            if (diffHours < 24) {
                // Same day ‚Äî don't add points or change streak
                todayAlreadyCounted = true;
            } else if (diffHours < 48) {
                // Next day ‚Äî increment streak
                streakDays = (userData.streakDays || 1) + 1;
            } else {
                // Missed a day ‚Äî reset streak
                streakDays = 1;
            }
        }

        // Add daily login points only once per day
        if (!todayAlreadyCounted) {
            totalScore += DAILY_LOGIN_POINTS;
            weeklyScore += DAILY_LOGIN_POINTS;
        }

        // ‚îÄ‚îÄ WEEKLY RESET: if last reset was before this week's Monday, reset weeklyScore ‚îÄ‚îÄ
        if (userData.weeklyResetDate) {
            const lastMonday = (() => {
                const d = new Date(); const day = d.getDay(); d.setDate(d.getDate() - (day === 0 ? 6 : day - 1)); d.setHours(0,0,0,0); return d;
            })();
            const resetDate = userData.weeklyResetDate.toDate ? userData.weeklyResetDate.toDate() : new Date(userData.weeklyResetDate);
            if (resetDate < lastMonday) {
                weeklyScore = todayAlreadyCounted ? 0 : DAILY_LOGIN_POINTS; // start fresh for new week
            }
        }

        const firstName = getFirstName(userData.name || user.displayName);
        const badge = calculateBadge(streakDays, totalScore, userData.joinedAt);

        // ‚îÄ‚îÄ RENDER NOW with real data ‚îÄ‚îÄ
        await renderDashboard({ firstName, streakDays, totalScore, weeklyScore, level: userLevel, enrolledCourses, userId: user.uid, sessionsCompleted: userData.sessionsCompleted || 0 });

        // ‚îÄ‚îÄ WRITE BACK to Firestore (background) ‚îÄ‚îÄ
        const updates = {
            level: userLevel,
            totalScore,
            weeklyScore,
            streakDays,
            lastActive: serverTimestamp(),
            badge
        };
        if (!userData.joinedAt) updates.joinedAt = serverTimestamp();
        if (!userData.weeklyResetDate) updates.weeklyResetDate = serverTimestamp();

        // If it's a new week, reset the weeklyResetDate
        if (userData.weeklyResetDate) {
            const lastMonday = (() => { const d = new Date(); const day = d.getDay(); d.setDate(d.getDate() - (day === 0 ? 6 : day - 1)); d.setHours(0,0,0,0); return d; })();
            const resetDate = userData.weeklyResetDate.toDate ? userData.weeklyResetDate.toDate() : new Date(userData.weeklyResetDate);
            if (resetDate < lastMonday) updates.weeklyResetDate = serverTimestamp();
        }

        try { await updateDoc(userRef, updates); } catch(e) { console.error('User update error:', e); }

        // ‚îÄ‚îÄ WRITE LEADERBOARD: all-time ‚îÄ‚îÄ
        try {
            await setDoc(doc(db, 'leaderboard', user.uid), {
                name: firstName,
                level: userLevel,
                totalScore,
                streakDays,
                badge,
                lastUpdated: serverTimestamp()
            }, { merge: true });
        } catch(e) { console.error('Leaderboard write error:', e); }

        // ‚îÄ‚îÄ WRITE LEADERBOARD: weekly ‚îÄ‚îÄ
        // Path: leaderboard_weekly/{weekId}/scores/{userId}
        // This matches what leaderboard.html queries
        const weekId = getWeekId();
        try {
            await setDoc(doc(db, 'leaderboard_weekly', weekId, 'scores', user.uid), {
                name: firstName,
                level: userLevel,
                totalScore: weeklyScore,
                streakDays,
                badge,
                lastUpdated: serverTimestamp()
            }, { merge: true });
        } catch(e) { console.error('Weekly leaderboard write error:', e); }

    } catch(error) {
        console.error('Dashboard error:', error);
        document.getElementById('dashboardContent').innerHTML =
            '<div class="empty-state"><h3>Something went wrong</h3><p>Please refresh the page.</p></div>';
    }
});

async function renderDashboard(data) {
    const container = document.getElementById('dashboardContent');

    let html =
        '<div class="welcome-header">' +
            '<h1>Welcome back, ' + escapeHtml(data.firstName) + '! üëã</h1>' +
            '<div class="stat-chips">' +
                '<span class="stat-chip">üî• ' + data.streakDays + ' day streak</span>' +
                '<span class="stat-chip">‚≠ê ' + data.totalScore + ' total points</span>' +
                '<span class="stat-chip">üìÖ ' + data.weeklyScore + ' this week</span>' +
                '<span class="stat-chip">üéì Level ' + escapeHtml(data.level) + '</span>' +
            '</div>' +
        '</div>';

    html += '<div class="courses-section"><h2 class="section-heading">My Courses</h2>';

    if (!data.enrolledCourses.length) {
        html += '<div class="empty-state"><h3>No courses yet</h3><p>Start your German learning journey!</p><a href="index.html#courses" class="btn-browse">Browse Courses</a></div>';
    } else {
        html += '<div class="courses-grid">';
        for (const courseName of data.enrolledCourses) {
            const courseLevel = courseName.includes('A2') ? 'A2' : courseName.includes('A1') ? 'A1' : '';
            html +=
                '<div class="course-card">' +
                    '<div class="course-header"><div class="course-level">' + escapeHtml(courseLevel) + '</div><div class="access-badge">Active</div></div>' +
                    '<div class="course-title">' + escapeHtml(courseName) + '</div>' +
                    '<div class="course-description">Access all video lessons, practice materials, and exam preparation resources.</div>' +
                    '<div class="course-stats"><div class="course-stat">üî• ' + data.streakDays + ' day streak</div><div class="course-stat">‚≠ê ' + data.totalScore + ' pts</div></div>' +
                    '<div class="course-progress"><div class="progress-label"><span>Progress</span><span>Videos coming soon</span></div><div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div></div>' +
                    '<button class="btn-access" onclick="window.location.href=\'' + getCourseUrl(courseName) + '\'">Access Course ‚Üí</button>' +
                '</div>';
        }
        html += '</div>';
    }
    html += '</div>';

    html +=
        '<div class="leaderboard-section">' +
            '<h2 class="section-heading">üèÜ Leaderboard ‚Äî ' + escapeHtml(data.level) + ' Students</h2>' +
            '<div class="leaderboard-card"><div id="leaderboardContent"><div style="text-align:center;padding:20px;color:#999;">Loading leaderboard...</div></div></div>' +
        '</div>';

    html +=
        '<div class="sprechen-section">' +
            '<h2 class="section-heading">üó£Ô∏è Sprechen Buddy</h2>' +
            '<div class="sprechen-card-active">' +
                '<div class="sprechen-header"><div class="sprechen-icon">üë•</div><div class="sprechen-badge"><span class="badge-dot"></span><span id="onlineCount">0</span> students online</div></div>' +
                '<h3>Practice Speaking with Real Students</h3>' +
                '<p class="sprechen-description">Get matched with another <span id="userLevelDisplay">' + escapeHtml(data.level) + '</span> student for a structured speaking practice session. Exam-focused and FREE!</p>' +
                '<div class="sprechen-features">' +
                    '<div class="feature-item"><span class="feature-icon">üéØ</span><div class="feature-text"><strong>Real Exam Scenarios</strong><p>Practice actual Goethe/TELC speaking tasks</p></div></div>' +
                    '<div class="feature-item"><span class="feature-icon">üîí</span><div class="feature-text"><strong>100% Anonymous</strong><p>No personal details shared, ever</p></div></div>' +
                    '<div class="feature-item"><span class="feature-icon">‚≠ê</span><div class="feature-text"><strong>Earn Points & Feedback</strong><p>Get evaluated and improve your score</p></div></div>' +
                '</div>' +
                '<div class="sprechen-stats">' +
                    '<div class="stat-box"><div class="stat-number" id="userSessionsCompleted">' + data.sessionsCompleted + '</div><div class="stat-label">Sessions Completed</div></div>' +
                    '<div class="stat-box"><div class="stat-number" id="avgWaitTime">45s</div><div class="stat-label">Avg Wait Time</div></div>' +
                '</div>' +
                '<button class="btn-practice-now" onclick="startSprechenBuddy()">üé§ Find Practice Partner</button>' +
                '<p class="sprechen-note">üí° <strong>Tip:</strong> Most students are online between 6 PM - 10 PM IST</p>' +
            '</div>' +
        '</div>';

    container.innerHTML = html;
    await loadLeaderboard(data.level, data.userId);
}

async function loadLeaderboard(level, userId) {
    const el = document.getElementById('leaderboardContent');
    try {
        const snap = await getDocs(query(collection(db, 'leaderboard'), where('level', '==', level), orderBy('totalScore', 'desc'), limit(10)));

        if (snap.empty) {
            el.innerHTML = '<div class="leaderboard-empty">Be one of the first to claim the top spot! üöÄ</div><p class="leaderboard-note">Rankings update every time students log in</p>';
            return;
        }

        let html = '<ul class="leaderboard-list">';
        let rank = 0;
        snap.forEach(d => {
            rank++;
            const e = d.data();
            const isMe = d.id === userId;
            const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
            html +=
                '<li class="leaderboard-row' + (isMe ? ' current-user' : '') + '">' +
                    '<span class="lb-rank ' + rankClass + '">#' + rank + '</span>' +
                    '<span class="lb-name">' + escapeHtml(e.name || 'Student') + (isMe ? ' (You)' : '') + '</span>' +
                    '<span class="lb-score">‚≠ê ' + (e.totalScore || 0) + '</span>' +
                    '<span class="lb-streak">üî• ' + (e.streakDays || 0) + 'd</span>' +
                '</li>';
        });
        html += '</ul><p class="leaderboard-note">Rankings update every time students log in</p>';
        el.innerHTML = html;
    } catch(e) {
        console.error('Leaderboard load error:', e);
        el.innerHTML = '<div class="leaderboard-empty">Leaderboard loading. Check back soon!</div>';
    }
}
</script>
</body>
</html>
