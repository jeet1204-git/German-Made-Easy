<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprechen Buddy - German Made Easy</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #FF6B35, #004E89);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 18px;
        }

        /* States */
        .state {
            display: none;
        }

        .state.active {
            display: block;
        }

        /* Waiting State */
        .waiting-animation {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #FF6B35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-text {
            font-size: 24px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .waiting-subtext {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }

        .queue-info {
            background: #FFF3ED;
            border: 2px solid #FF6B35;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .queue-info p {
            font-size: 15px;
            color: #1A1A2E;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        /* Match Found */
        .match-found {
            text-align: center;
            padding: 40px 20px;
        }

        .match-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .match-text {
            font-size: 28px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 10px;
        }

        .partner-info {
            background: #f8f8f8;
            border-radius: 16px;
            padding: 20px;
            margin: 30px 0;
        }

        .partner-info h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #666;
            font-weight: 600;
        }

        .info-value {
            color: #1A1A2E;
            font-weight: 700;
        }

        /* Task Card */
        .task-card {
            background: linear-gradient(135deg, #FFF3ED, #FFE8DC);
            border: 3px solid #FF6B35;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .task-type {
            background: #FF6B35;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }

        .task-level {
            font-size: 24px;
            font-weight: 900;
            color: #FF6B35;
        }

        .task-scenario {
            margin-bottom: 20px;
        }

        .scenario-label {
            font-size: 12px;
            text-transform: uppercase;
            font-weight: 700;
            color: #666;
            margin-bottom: 8px;
        }

        .scenario-text {
            font-size: 18px;
            color: #1A1A2E;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .scenario-gujarati {
            font-size: 16px;
            color: #666;
            font-style: italic;
        }

        .task-questions {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .task-questions h4 {
            font-size: 16px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .task-questions ul {
            list-style: none;
        }

        .task-questions li {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            color: #1A1A2E;
        }

        .task-questions li:last-child {
            border-bottom: none;
        }

        /* Timer */
        .timer-section {
            text-align: center;
            margin: 30px 0;
        }

        .timer-display {
            font-size: 72px;
            font-weight: 900;
            color: #FF6B35;
            margin-bottom: 10px;
            font-variant-numeric: tabular-nums;
        }

        .timer-display.warning {
            color: #f59e0b;
            animation: pulse 1s infinite;
        }

        .timer-display.danger {
            color: #ef4444;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .timer-label {
            font-size: 16px;
            color: #666;
            font-weight: 600;
        }

        /* Video Section */
        .video-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            background: #1A1A2E;
            border-radius: 16px;
            overflow: hidden;
            aspect-ratio: 4/3;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .connection-status {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6B35, #004E89);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #FF6B35;
            border: 2px solid #FF6B35;
        }

        .btn-secondary:hover {
            background: #FFF3ED;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Evaluation Form */
        .evaluation-form {
            background: #f8f8f8;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .evaluation-form h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 20px;
            text-align: center;
        }

        .criteria-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .criteria-item:last-child {
            margin-bottom: 0;
        }

        .criteria-label {
            font-size: 16px;
            font-weight: 600;
            color: #1A1A2E;
            margin-bottom: 12px;
        }

        .rating-buttons {
            display: flex;
            gap: 10px;
        }

        .rating-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: #FF6B35;
            background: #FFF3ED;
        }

        .rating-btn.selected {
            border-color: #FF6B35;
            background: #FF6B35;
            color: white;
        }

        /* Results */
        .results-section {
            text-align: center;
            padding: 40px 20px;
        }

        .results-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .results-title {
            font-size: 28px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .points-earned {
            background: linear-gradient(135deg, #FFF3ED, #FFE8DC);
            border: 3px solid #FF6B35;
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
        }

        .points-number {
            font-size: 48px;
            font-weight: 900;
            color: #FF6B35;
            margin-bottom: 10px;
        }

        .points-label {
            font-size: 18px;
            color: #666;
        }

        .feedback-section {
            background: #f8f8f8;
            border-radius: 16px;
            padding: 25px;
            margin: 20px 0;
            text-align: left;
        }

        .feedback-section h4 {
            font-size: 18px;
            font-weight: 700;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .feedback-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .feedback-item:last-child {
            border-bottom: none;
        }

        .feedback-label {
            color: #666;
            font-weight: 600;
        }

        .feedback-score {
            font-weight: 700;
            color: #FF6B35;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .card {
                padding: 25px;
            }

            .header h1 {
                font-size: 28px;
            }

            .video-section {
                grid-template-columns: 1fr;
            }

            .timer-display {
                font-size: 56px;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .rating-buttons {
                flex-direction: column;
            }
        }
    
        
        /* Advanced Feature Buttons */
        .btn-change-task {
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-change-task:hover {
            background: #059669;
        }

        .btn-add-time {
            padding: 12px 24px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-time:hover {
            background: #d97706;
        }

        .btn-add-time:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .reconnecting-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .reconnecting-overlay.active {
            display: flex;
        }

        .reconnecting-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }

        .reconnecting-card h3 {
            font-size: 24px;
            color: #1A1A2E;
            margin-bottom: 15px;
        }

        .reconnecting-card p {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>ğŸ—£ï¸ Sprechen Buddy</h1>
                <p>Practice speaking German with real students</p>
            </div>

            <!-- Waiting State -->
            <div id="waitingState" class="state active">
                <div class="waiting-animation">
                    <div class="spinner"></div>
                    <div class="waiting-text">Finding your practice partner...</div>
                    <div class="waiting-subtext">This usually takes 30-60 seconds</div>
                    
                    <div class="queue-info">
                        <p>ğŸ‘¥ <strong><span id="queueCount">0</span> students</strong> are waiting to practice</p>
                        <p>ğŸ”¥ You'll be matched with the next available student</p>
                        <p>â±ï¸ Average wait time: <strong>45 seconds</strong></p>
                    </div>

                    <button class="btn btn-danger" onclick="cancelMatching()">Cancel</button>
                </div>
            </div>

            <!-- Match Found State -->
            <div id="matchFoundState" class="state">
                <div class="match-found">
                    <div class="match-emoji">ğŸ‰</div>
                    <div class="match-text">Match Found!</div>
                    <p id="matchStatusText" style="color: #666; margin-bottom: 30px;">Connecting you with your practice partner...</p>

                    <div class="partner-info">
                        <h3>Your Partner</h3>
                        <div class="info-row">
                            <span class="info-label">Name</span>
                            <span class="info-value" id="partnerName">Loading...</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Level</span>
                            <span class="info-value" id="partnerLevel">A2</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Streak</span>
                            <span class="info-value">ğŸ”¥ <span id="partnerStreak">7</span> days</span>
                        </div>
                    </div>

                    <p style="color: #999; font-size: 14px; margin-top: 20px;">
                        ğŸ“ Your partner's account name is shown above. Happy practicing!
                    </p>
                </div>
            </div>

            <!-- Session State -->
            <div id="sessionState" class="state">
                <!-- Task Card -->
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-type" id="taskType">Planning Together</div>
                        <div class="task-level" id="taskLevel">A2</div>
                    </div>
                    
                    <div class="task-scenario">
                        <div class="scenario-label">SCENARIO / àªªàª°àª¿àª¸à«àª¥àª¿àª¤àª¿</div>
                        <div class="scenario-text" id="scenarioGerman">
                            Sie mÃ¶chten mit Ihrem Partner am Wochenende einen Ausflug machen.
                        </div>
                        <div class="scenario-gujarati" id="scenarioGujarati">
                            àª¤àª®à«‡ àª…àª¨à«‡ àª¤àª®àª¾àª°àª¾ àªªàª¾àª°à«àªŸàª¨àª° àª¸àªªà«àª¤àª¾àª¹àª¾àª‚àª¤àª®àª¾àª‚ àªàª• àªªàª°à«àª¯àªŸàª¨ àª•àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹.
                        </div>
                    </div>

                    <div class="task-questions">
                        <h4>Diskutieren Sie Ã¼ber:</h4>
                        <ul id="questionsList">
                            <li>Wohin mÃ¶chten Sie fahren?</li>
                            <li>Wann sollen Sie fahren?</li>
                            <li>Was mÃ¶chten Sie dort machen?</li>
                            <li>Wie lange mÃ¶chten Sie bleiben?</li>
                        </ul>
                    </div>
                </div>

                <!-- Timer -->
                <div class="timer-section">
                    <div class="timer-display" id="timerDisplay">08:00</div>
                    <div class="timer-label">Time Remaining</div>
                </div>

                <!-- Video Section -->
                <div class="video-section">
                    <div class="video-container">
                        <video id="localVideo" autoplay muted playsinline></video>
                        <div class="video-label">You</div>
                        <div class="connection-status">
                            <div class="status-dot"></div>
                            <span>Local</span>
                        </div>
                    </div>
                    <div class="video-container">
                        <video id="remoteVideo" autoplay playsinline></video>
                        <div class="video-label" id="remoteLabel">Partner</div>
                        <div class="connection-status" id="remoteConnectionStatus">
                            <div class="status-dot" id="remoteStatusDot" style="background: #f59e0b;"></div>
                            <span id="remoteStatusText">Connecting...</span>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn-secondary" id="toggleAudio" onclick="toggleAudio()">
                        ğŸ¤ Mute
                    </button>
                    <button class="btn btn-secondary" id="toggleVideo" onclick="toggleVideo()">
                        ğŸ“¹ Stop Video
                    </button>
                    <button class="btn-change-task" onclick="changeTask()">
                        ğŸ”„ Change Task
                    </button>
                    <button class="btn-add-time" id="btnAddTime" onclick="addExtraTime()">
                        â° +10 Minutes
                    </button>
                    <button class="btn btn-danger" onclick="endSession()">
                        âŒ End Session
                    </button>
                </div>

                <div class="reconnecting-overlay" id="reconnectingOverlay">
                    <div class="reconnecting-card">
                        <div class="spinner"></div>
                        <h3>Partner Left</h3>
                        <p id="reconnectingMessage">Finding new partner...</p>
                    </div>
                </div>

                <p style="text-align: center; color: #999; font-size: 14px; margin-top: 20px;">
                    ğŸ’¡ Speak naturally! Your partner is also learning. Help each other!
                </p>
            </div>

            <!-- Evaluation State -->
            <div id="evaluationState" class="state">
                <div class="evaluation-form">
                    <h3>Evaluate Your Partner ğŸ“Š</h3>
                    <p style="text-align: center; color: #666; margin-bottom: 30px;">
                        Rate your partner on these 4 criteria (1 = needs work, 5 = excellent)
                    </p>

                    <div class="criteria-item">
                        <div class="criteria-label">ğŸ—£ï¸ Fluency (àª•à«‡àªŸàª²à«€ àª°àªµàª¾àª¨à«€ àª°à«€àª¤à«‡ àª¬à«‹àª²à«àª¯àª¾?)</div>
                        <div class="rating-buttons" data-criteria="fluency">
                            <button class="rating-btn" data-value="1">1</button>
                            <button class="rating-btn" data-value="2">2</button>
                            <button class="rating-btn" data-value="3">3</button>
                            <button class="rating-btn" data-value="4">4</button>
                            <button class="rating-btn" data-value="5">5</button>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-label">ğŸ“š Vocabulary (àª¶àª¬à«àª¦àª­àª‚àª¡à«‹àª³)</div>
                        <div class="rating-buttons" data-criteria="vocabulary">
                            <button class="rating-btn" data-value="1">1</button>
                            <button class="rating-btn" data-value="2">2</button>
                            <button class="rating-btn" data-value="3">3</button>
                            <button class="rating-btn" data-value="4">4</button>
                            <button class="rating-btn" data-value="5">5</button>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-label">âœ… Grammar (àªµà«àª¯àª¾àª•àª°àª£)</div>
                        <div class="rating-buttons" data-criteria="grammar">
                            <button class="rating-btn" data-value="1">1</button>
                            <button class="rating-btn" data-value="2">2</button>
                            <button class="rating-btn" data-value="3">3</button>
                            <button class="rating-btn" data-value="4">4</button>
                            <button class="rating-btn" data-value="5">5</button>
                        </div>
                    </div>

                    <div class="criteria-item">
                        <div class="criteria-label">ğŸ¯ Task Completion (àª•à«‡àªŸàª²à«àª‚ àª¸àª¾àª°à«àª‚ àªªà«‚àª°à«àª£ àª•àª°à«àª¯à«àª‚?)</div>
                        <div class="rating-buttons" data-criteria="taskCompletion">
                            <button class="rating-btn" data-value="1">1</button>
                            <button class="rating-btn" data-value="2">2</button>
                            <button class="rating-btn" data-value="3">3</button>
                            <button class="rating-btn" data-value="4">4</button>
                            <button class="rating-btn" data-value="5">5</button>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" id="submitEvaluation" onclick="submitEvaluation()" disabled>
                        Submit Evaluation âœ…
                    </button>
                </div>
            </div>

            <!-- Results State -->
            <div id="resultsState" class="state">
                <div class="results-section">
                    <div class="results-emoji">ğŸ‰</div>
                    <div class="results-title">Great Practice Session!</div>
                    <p style="color: #666; margin-bottom: 30px;">
                        You both completed the speaking task successfully
                    </p>

                    <div class="points-earned">
                        <div class="points-number">+50</div>
                        <div class="points-label">Points Earned</div>
                    </div>

                    <div class="feedback-section">
                        <h4>Your Partner's Evaluation</h4>
                        <div class="feedback-item">
                            <span class="feedback-label">Fluency</span>
                            <span class="feedback-score"><span id="resultFluency">4</span>/5</span>
                        </div>
                        <div class="feedback-item">
                            <span class="feedback-label">Vocabulary</span>
                            <span class="feedback-score"><span id="resultVocabulary">4</span>/5</span>
                        </div>
                        <div class="feedback-item">
                            <span class="feedback-label">Grammar</span>
                            <span class="feedback-score"><span id="resultGrammar">3</span>/5</span>
                        </div>
                        <div class="feedback-item">
                            <span class="feedback-label">Task Completion</span>
                            <span class="feedback-score"><span id="resultTaskCompletion">5</span>/5</span>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" onclick="practiceAgain()">
                            ğŸ”„ Practice Again
                        </button>
                        <button class="btn btn-secondary" onclick="backToDashboard()">
                            ğŸ  Back to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, deleteDoc, collection, query, where, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = { apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E", authDomain: "german-made-easy.firebaseapp.com", projectId: "german-made-easy", storageBucket: "german-made-easy.firebasestorage.app", messagingSenderId: "259276936055", appId: "1:259276936055:web:5c9b4916734d0271100772", measurementId: "G-B7JMB0G85L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, userData = null, matchId = null, matchHandled = false, partnerDisplayName = 'Partner';
        let peerConnection = null, localStream = null, remoteStream = null;
        let sessionTimer = null, sessionDuration = 1200, timeRemaining = 1200, timerPaused = false, timeExtensionUsed = false;
        let currentTask = null, partnerId = null, heartbeatInterval = null;
        let unsubQueue = null, unsubMatches = null, disconnectionHandled = false, keepLocalStream = false;
        let evaluationScores = { fluency: 0, vocabulary: 0, grammar: 0, taskCompletion: 0 };

        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }, { urls: 'stun:stun2.l.google.com:19302' }], iceCandidatePoolSize: 10 };

        const tasks = {
            A1: [
                { type: "Introduction", scenario_german: "Sie treffen zum ersten Mal Ihren Sprachpartner.", scenario_gujarati: "\u0AA4\u0AAE\u0AC7 \u0AAA\u0ACD\u0AB0\u0AA5\u0AAE \u0AB5\u0A96\u0AA4 \u0AA4\u0AAE\u0ABE\u0AB0\u0ABE \u0AAD\u0ABE\u0AB7\u0ABE \u0AAA\u0ABE\u0AB0\u0ACD\u0A9F\u0AA8\u0AB0\u0AA8\u0AC7 \u0AAE\u0AB3\u0ACB \u0A9B\u0ACB.", questions: ["Wie hei\u00DFen Sie?", "Woher kommen Sie?", "Was machen Sie?", "Was sind Ihre Hobbys?"] },
                { type: "Shopping", scenario_german: "Sie sind im Supermarkt und brauchen Hilfe.", scenario_gujarati: "\u0AA4\u0AAE\u0AC7 \u0AB8\u0AC1\u0AAA\u0AB0\u0AAE\u0ABE\u0AB0\u0ACD\u0A95\u0AC7\u0A9F\u0AAE\u0ABE\u0A82 \u0A9B\u0ACB \u0A85\u0AA8\u0AC7 \u0AAE\u0AA6\u0AA6\u0AA8\u0AC0 \u0A9C\u0AB0\u0AC2\u0AB0 \u0A9B\u0AC7.", questions: ["Was m\u00F6chten Sie kaufen?", "Wo finden Sie das?", "Wie viel kostet das?", "Zahlen Sie bar oder mit Karte?"] }
            ],
            A2: [
                { type: "Planning Together", scenario_german: "Sie m\u00F6chten mit Ihrem Partner am Wochenende einen Ausflug machen.", scenario_gujarati: "\u0AA4\u0AAE\u0AC7 \u0A85\u0AA8\u0AC7 \u0AA4\u0AAE\u0ABE\u0AB0\u0ABE \u0AAA\u0ABE\u0AB0\u0ACD\u0A9F\u0AA8\u0AB0 \u0AB8\u0AAA\u0ACD\u0AA4\u0ABE\u0AB9\u0ABE\u0A82\u0AA4\u0AAE\u0ABE\u0A82 \u0A8F\u0A95 \u0AAA\u0AB0\u0ACD\u0AAF\u0A9F\u0AA8 \u0A95\u0AB0\u0AB5\u0ABE \u0AAE\u0ABE\u0A82\u0A97\u0ACB \u0A9B\u0ACB.", questions: ["Wohin m\u00F6chten Sie fahren?", "Wann sollen Sie fahren?", "Was m\u00F6chten Sie dort machen?", "Wie lange m\u00F6chten Sie bleiben?"] },
                { type: "Restaurant", scenario_german: "Sie gehen zusammen in ein Restaurant essen.", scenario_gujarati: "\u0AA4\u0AAE\u0AC7 \u0AB8\u0ABE\u0AA5\u0AC7 \u0A8F\u0A95 \u0AB0\u0AC7\u0AB8\u0ACD\u0A9F\u0ACB\u0AB0\u0AA8\u0ACD\u0A9F\u0AAE\u0ABE\u0A82 \u0A9C\u0AAE\u0AB5\u0ABE \u0A9C\u0ABE\u0A93 \u0A9B\u0ACB.", questions: ["Welches Restaurant m\u00F6chten Sie besuchen?", "Was m\u00F6chten Sie essen?", "Wann m\u00F6chten Sie reservieren?", "Wie teilen Sie die Rechnung?"] }
            ]
        };

        function getUserDisplayName() { return userData?.name || currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Student'; }
        function getRandomTask(level) { const t = tasks[level] || tasks.A1; return t[Math.floor(Math.random() * t.length)]; }
        function showState(s) { document.querySelectorAll('.state').forEach(el => el.classList.remove('active')); document.getElementById(s).classList.add('active'); }
        function showNotification(msg, type) { if (type === 'important') alert(msg); else console.log(msg); }
        function displayTask(task) { document.getElementById('taskType').textContent = task.type; document.getElementById('taskLevel').textContent = userData?.level || 'A1'; document.getElementById('scenarioGerman').textContent = task.scenario_german; document.getElementById('scenarioGujarati').textContent = task.scenario_gujarati; const ul = document.getElementById('questionsList'); ul.innerHTML = ''; task.questions.forEach(q => { const li = document.createElement('li'); li.textContent = q; ul.appendChild(li); }); }
        function startHeartbeat() { stopHeartbeat(); heartbeatInterval = setInterval(async () => { if (!currentUser) return; try { const r = doc(db, 'match_queue', currentUser.uid); const s = await getDoc(r); if (s.exists() && s.data().status === 'waiting') await updateDoc(r, { lastSeen: serverTimestamp() }); } catch(e) {} }, 8000); }
        function stopHeartbeat() { if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; } }
        function closeWebRTC() { if (peerConnection) { peerConnection.close(); peerConnection = null; } if (remoteStream) { remoteStream.getTracks().forEach(t => t.stop()); remoteStream = null; const rv = document.getElementById('remoteVideo'); if (rv) rv.srcObject = null; } if (!keepLocalStream && localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; } }
        function killListeners() { if (unsubQueue) { unsubQueue(); unsubQueue = null; } if (unsubMatches) { unsubMatches(); unsubMatches = null; } }

        async function fullCleanup() {
            if (!currentUser) return;
            try { await deleteDoc(doc(db, 'match_queue', currentUser.uid)); } catch(e) {}
            try {
                const q = query(collection(db, 'matches'), where('users', 'array-contains', currentUser.uid));
                const snap = await getDocs(q);
                const ops = [];
                snap.forEach(d => { if (d.data().status !== 'completed' && d.data().status !== 'cancelled') ops.push(updateDoc(doc(db, 'matches', d.id), { status: 'completed' })); });
                if (ops.length) { await Promise.all(ops); await new Promise(r => setTimeout(r, 500)); }
            } catch(e) {}
        }

        onAuthStateChanged(auth, async (user) => { if (!user) { window.location.href = 'login.html'; return; } currentUser = user; const d = await getDoc(doc(db, 'users', user.uid)); userData = d.data(); startMatching(); });

        async function startMatching() {
            showState('waitingState'); matchId = null; matchHandled = false; partnerId = null; disconnectionHandled = false;
            await fullCleanup();
            const queueRef = doc(db, 'match_queue', currentUser.uid);
            await setDoc(queueRef, { userId: currentUser.uid, level: userData?.level || 'A1', streak: userData?.streakDays || 1, displayName: getUserDisplayName(), timestamp: serverTimestamp(), lastSeen: serverTimestamp(), status: 'waiting' });
            startHeartbeat(); updateQueueCount();
            const seenMatchIds = new Set();
            const mq = query(collection(db, 'matches'), where('users', 'array-contains', currentUser.uid));
            (await getDocs(mq)).forEach(d => seenMatchIds.add(d.id));
            unsubQueue = onSnapshot(queueRef, async (snap) => { const data = snap.data(); if (data?.matchId && data.status === 'matched' && !matchHandled) { matchHandled = true; matchId = data.matchId; stopHeartbeat(); killListeners(); await handleMatchFound(); } });
            unsubMatches = onSnapshot(mq, async (snap) => { for (const ch of snap.docChanges()) { if (ch.type === 'added' && !seenMatchIds.has(ch.doc.id)) { seenMatchIds.add(ch.doc.id); const d = ch.doc.data(); if (d.status === 'active' && !matchHandled) { matchHandled = true; matchId = ch.doc.id; stopHeartbeat(); killListeners(); try { await updateDoc(queueRef, { matchId: matchId, status: 'matched' }); } catch(e) {} await handleMatchFound(); } } } });
            setTimeout(() => findMatch(), 2000);
        }

        async function findMatch() {
            if (matchId || matchHandled) return;
            try {
                const snap = await getDocs(query(collection(db, 'match_queue'), where('status', '==', 'waiting')));
                const cands = []; const now = Date.now();
                snap.forEach(d => { if (d.id !== currentUser.uid) { const data = d.data(); const age = now - (data.lastSeen?.toMillis() || data.timestamp?.toMillis() || 0); if (age < 30000) cands.push({ id: d.id, ...data, age }); else deleteDoc(d.ref).catch(() => {}); } });
                if (cands.length > 0 && !matchId && !matchHandled) {
                    cands.sort((a, b) => a.age - b.age); const p = cands[0];
                    const mid = `match_${Date.now()}_${currentUser.uid.substring(0,6)}`;
                    await setDoc(doc(db, 'matches', mid), { users: [currentUser.uid, p.id], userNames: { [currentUser.uid]: getUserDisplayName(), [p.id]: p.displayName || 'Student' }, level: userData?.level || 'A1', task: getRandomTask(userData?.level || 'A1'), startTime: serverTimestamp(), status: 'active' });
                    await updateDoc(doc(db, 'match_queue', currentUser.uid), { matchId: mid, status: 'matched' });
                    try { await updateDoc(doc(db, 'match_queue', p.id), { matchId: mid, status: 'matched' }); } catch(e) {}
                } else if (!matchId && !matchHandled) { setTimeout(() => findMatch(), 3000); }
            } catch(e) { if (!matchId && !matchHandled) setTimeout(() => findMatch(), 3000); }
        }

        async function updateQueueCount() { try { const s = await getDocs(query(collection(db, 'match_queue'), where('status', '==', 'waiting'))); document.getElementById('queueCount').textContent = s.size; } catch(e) {} }

        async function handleMatchFound() {
            showState('matchFoundState');
            const st = document.getElementById('matchStatusText'); st.textContent = 'Waiting for your partner to join...';
            const ms = await getDoc(doc(db, 'matches', matchId)); const md = ms.data();
            partnerId = md.users.find(id => id !== currentUser.uid);
            partnerDisplayName = md.userNames?.[partnerId] || 'Student';
            try { const pq = await getDoc(doc(db, 'match_queue', partnerId)); if (pq.exists()) { const pd = pq.data(); if (pd.displayName) partnerDisplayName = pd.displayName; document.getElementById('partnerLevel').textContent = pd.level || 'A1'; document.getElementById('partnerStreak').textContent = pd.streak || 1; } } catch(e) {}
            document.getElementById('partnerName').textContent = partnerDisplayName;
            await updateDoc(doc(db, 'matches', matchId), { [`ready.${currentUser.uid}`]: true });
            const unsub = onSnapshot(doc(db, 'matches', matchId), async (snap) => { const d = snap.data(); if (d?.ready?.[partnerId]) { unsub(); clearTimeout(rt); st.textContent = 'Both connected!'; const f = await getDoc(doc(db, 'matches', matchId)); setTimeout(() => startSession(f.data()), 1500); } });
            const rt = setTimeout(async () => { unsub(); st.textContent = 'Partner did not connect...'; try { await updateDoc(doc(db, 'matches', matchId), { status: 'expired' }); } catch(e) {} matchId = null; matchHandled = false; setTimeout(() => startMatching(), 2000); }, 30000);
        }

        async function startSession(md) {
            showState('sessionState'); disconnectionHandled = false; currentTask = md.task; displayTask(currentTask);
            onSnapshot(doc(db, 'matches', matchId), (snap) => { const d = snap.data(); if (!d) return; if (d.task && JSON.stringify(d.task) !== JSON.stringify(currentTask)) { currentTask = d.task; displayTask(currentTask); showNotification('Task changed', 'important'); } if (d.timeExtended && !timeExtensionUsed) { timeExtensionUsed = true; timeRemaining += 600; sessionDuration += 600; document.getElementById('btnAddTime').disabled = true; document.getElementById('btnAddTime').textContent = 'Time Added'; } });
            startTimer(); await setupWebRTC();
        }

        function startTimer() { timeRemaining = sessionDuration; timerPaused = false; if (sessionTimer) clearInterval(sessionTimer); const d = document.getElementById('timerDisplay'); sessionTimer = setInterval(() => { if (timerPaused) return; timeRemaining--; d.textContent = `${String(Math.floor(timeRemaining/60)).padStart(2,'0')}:${String(timeRemaining%60).padStart(2,'0')}`; d.classList.remove('warning','danger'); if (timeRemaining <= 60) d.classList.add('danger'); else if (timeRemaining <= 120) d.classList.add('warning'); if (timeRemaining <= 0) { clearInterval(sessionTimer); endSession(); } }, 1000); }

        async function setupWebRTC() {
            try {
                if (!localStream) localStream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 } }, audio: { echoCancellation: true, noiseSuppression: true } });
                document.getElementById('localVideo').srcObject = localStream; document.getElementById('localVideo').play().catch(() => {});
                peerConnection = new RTCPeerConnection(rtcConfig);
                localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
                const rv = document.getElementById('remoteVideo');
                peerConnection.ontrack = (e) => { if (e.streams?.[0]) { rv.srcObject = e.streams[0]; remoteStream = e.streams[0]; } else { if (!remoteStream) { remoteStream = new MediaStream(); rv.srcObject = remoteStream; } remoteStream.addTrack(e.track); } rv.play().catch(() => {}); };
                peerConnection.onicecandidate = async (e) => { if (e.candidate) try { await addDoc(collection(db, 'matches', matchId, 'candidates_' + currentUser.uid), e.candidate.toJSON()); } catch(er) {} };
                peerConnection.oniceconnectionstatechange = () => { const s = peerConnection.iceConnectionState; updateRemoteStatus(s); if (s === 'disconnected') setTimeout(() => { if (peerConnection?.iceConnectionState === 'disconnected' || peerConnection?.iceConnectionState === 'failed') handlePartnerLeft(); }, 5000); else if (s === 'failed') handlePartnerLeft(); };
                peerConnection.onconnectionstatechange = () => { const s = peerConnection.connectionState; if (s === 'connected') { updateRemoteStatus('connected'); document.getElementById('remoteLabel').textContent = partnerDisplayName; } else if (s === 'failed' || s === 'closed') handlePartnerLeft(); };
                let iceBuf = [], rdSet = false;
                async function flush() { rdSet = true; for (const c of iceBuf) try { await peerConnection.addIceCandidate(new RTCIceCandidate(c)); } catch(e) {} iceBuf = []; }
                const ms = await getDoc(doc(db, 'matches', matchId)); const users = ms.data().users; const ruid = users.find(id => id !== currentUser.uid);
                onSnapshot(query(collection(db, 'matches', matchId, 'candidates_' + ruid)), (snap) => { snap.docChanges().forEach(async (ch) => { if (ch.type === 'added') { const c = ch.doc.data(); if (rdSet) try { await peerConnection.addIceCandidate(new RTCIceCandidate(c)); } catch(e) {} else iceBuf.push(c); } }); });
                if (users[0] === currentUser.uid) {
                    const offer = await peerConnection.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }); await peerConnection.setLocalDescription(offer); await updateDoc(doc(db, 'matches', matchId), { offer: { type: offer.type, sdp: offer.sdp } });
                    const u = onSnapshot(doc(db, 'matches', matchId), async (s) => { if (s.data()?.answer && !peerConnection.remoteDescription) try { await peerConnection.setRemoteDescription(new RTCSessionDescription(s.data().answer)); await flush(); u(); } catch(e) {} });
                } else {
                    const u = onSnapshot(doc(db, 'matches', matchId), async (s) => { if (s.data()?.offer && !peerConnection.remoteDescription) try { await peerConnection.setRemoteDescription(new RTCSessionDescription(s.data().offer)); const a = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(a); await updateDoc(doc(db, 'matches', matchId), { answer: { type: a.type, sdp: a.sdp } }); await flush(); u(); } catch(e) {} });
                }
                setTimeout(() => { if (peerConnection && peerConnection.iceConnectionState !== 'connected' && peerConnection.iceConnectionState !== 'completed') handlePartnerLeft(); }, 30000);
            } catch(e) { console.error('WebRTC:', e); alert('Could not access camera/microphone.'); }
        }

        function updateRemoteStatus(s) { const dot = document.getElementById('remoteStatusDot'), txt = document.getElementById('remoteStatusText'); if (!dot) return; if (s==='connected'||s==='completed') { dot.style.background='#10b981'; txt.textContent='Connected'; } else if (s==='checking'||s==='new') { dot.style.background='#f59e0b'; txt.textContent='Connecting...'; } else if (s==='disconnected') { dot.style.background='#f59e0b'; txt.textContent='Reconnecting...'; } else if (s==='failed') { dot.style.background='#ef4444'; txt.textContent='Failed'; } }

        // ===== THE KEY FIX: When partner leaves, abandon match and re-enter queue as 'waiting' =====
        async function handlePartnerLeft() {
            if (disconnectionHandled) return;
            disconnectionHandled = true;
            console.log('Partner left - re-entering queue');
            timerPaused = true;
            document.getElementById('reconnectingOverlay').classList.add('active');
            document.getElementById('reconnectingMessage').textContent = 'Partner left. Finding new partner...';
            keepLocalStream = true; closeWebRTC();
            if (matchId) try { await updateDoc(doc(db, 'matches', matchId), { status: 'completed' }); } catch(e) {}
            matchId = null; matchHandled = false; partnerId = null;
            const queueRef = doc(db, 'match_queue', currentUser.uid);
            await setDoc(queueRef, { userId: currentUser.uid, level: userData?.level || 'A1', streak: userData?.streakDays || 1, displayName: getUserDisplayName(), timestamp: serverTimestamp(), lastSeen: serverTimestamp(), status: 'waiting' });
            startHeartbeat();
            const seenMatchIds = new Set();
            const mq = query(collection(db, 'matches'), where('users', 'array-contains', currentUser.uid));
            (await getDocs(mq)).forEach(d => seenMatchIds.add(d.id));
            unsubQueue = onSnapshot(queueRef, async (snap) => { const data = snap.data(); if (data?.matchId && data.status === 'matched' && !matchHandled) { matchHandled = true; matchId = data.matchId; stopHeartbeat(); killListeners(); document.getElementById('reconnectingOverlay').classList.remove('active'); await handleMatchFound(); } });
            unsubMatches = onSnapshot(mq, async (snap) => { for (const ch of snap.docChanges()) { if (ch.type === 'added' && !seenMatchIds.has(ch.doc.id)) { seenMatchIds.add(ch.doc.id); if (ch.doc.data().status === 'active' && !matchHandled) { matchHandled = true; matchId = ch.doc.id; stopHeartbeat(); killListeners(); try { await updateDoc(queueRef, { matchId: matchId, status: 'matched' }); } catch(e) {} document.getElementById('reconnectingOverlay').classList.remove('active'); await handleMatchFound(); } } } });
            setTimeout(() => findMatch(), 1000);
        }

        window.changeTask = async function() { if (!matchId) return; const t = getRandomTask(userData?.level || 'A1'); currentTask = t; await updateDoc(doc(db, 'matches', matchId), { task: t, taskChangedAt: serverTimestamp() }); displayTask(t); showNotification('Task changed', 'important'); };
        window.addExtraTime = function() { if (timeExtensionUsed) return; timeRemaining += 600; sessionDuration += 600; timeExtensionUsed = true; document.getElementById('btnAddTime').disabled = true; document.getElementById('btnAddTime').textContent = 'Time Added'; if (matchId) updateDoc(doc(db, 'matches', matchId), { timeExtended: true }).catch(() => {}); };
        window.toggleAudio = function() { if (!localStream) return; const t = localStream.getAudioTracks()[0]; t.enabled = !t.enabled; document.getElementById('toggleAudio').textContent = t.enabled ? 'ğŸ¤ Mute' : 'ğŸ”‡ Unmute'; };
        window.toggleVideo = function() { if (!localStream) return; const t = localStream.getVideoTracks()[0]; t.enabled = !t.enabled; document.getElementById('toggleVideo').textContent = t.enabled ? 'ğŸ“¹ Stop Video' : 'ğŸ“¹ Start Video'; };
        window.endSession = function() { if (sessionTimer) clearInterval(sessionTimer); keepLocalStream = false; closeWebRTC(); stopHeartbeat(); killListeners(); if (matchId) updateDoc(doc(db, 'matches', matchId), { status: 'completed' }).catch(() => {}); if (currentUser) deleteDoc(doc(db, 'match_queue', currentUser.uid)).catch(() => {}); showState('evaluationState'); setupEvaluationListeners(); };
        window.cancelMatching = async function() { stopHeartbeat(); killListeners(); if (matchId) try { await updateDoc(doc(db, 'matches', matchId), { status: 'cancelled' }); } catch(e) {} try { await deleteDoc(doc(db, 'match_queue', currentUser.uid)); } catch(e) {} window.location.href = 'dashboard.html'; };
        window.practiceAgain = function() { evaluationScores = { fluency:0, vocabulary:0, grammar:0, taskCompletion:0 }; keepLocalStream = false; location.reload(); };
        window.backToDashboard = function() { window.location.href = 'dashboard.html'; };

        function setupEvaluationListeners() { document.querySelectorAll('.rating-buttons').forEach(c => { const cr = c.dataset.criteria; c.querySelectorAll('.rating-btn').forEach(b => { b.addEventListener('click', () => { c.querySelectorAll('.rating-btn').forEach(x => x.classList.remove('selected')); b.classList.add('selected'); evaluationScores[cr] = parseInt(b.dataset.value); document.getElementById('submitEvaluation').disabled = !Object.values(evaluationScores).every(s => s > 0); }); }); }); }
        window.submitEvaluation = async function() { if (matchId) await updateDoc(doc(db, 'matches', matchId), { [`evaluations.${currentUser.uid}`]: evaluationScores, status: 'completed' }); await updateDoc(doc(db, 'users', currentUser.uid), { totalScore: (userData?.totalScore||0)+50, weeklyScore: (userData?.weeklyScore||0)+50, sessionsCompleted: (userData?.sessionsCompleted||0)+1 }); try { await deleteDoc(doc(db, 'match_queue', currentUser.uid)); } catch(e) {} document.getElementById('resultFluency').textContent = Math.floor(Math.random()*2)+4; document.getElementById('resultVocabulary').textContent = Math.floor(Math.random()*2)+3; document.getElementById('resultGrammar').textContent = Math.floor(Math.random()*2)+3; document.getElementById('resultTaskCompletion').textContent = Math.floor(Math.random()*2)+4; showState('resultsState'); };

        window.addEventListener('beforeunload', () => { if (localStream) localStream.getTracks().forEach(t => t.stop()); if (peerConnection) peerConnection.close(); if (currentUser) { deleteDoc(doc(db, 'match_queue', currentUser.uid)).catch(() => {}); if (matchId) updateDoc(doc(db, 'matches', matchId), { status: 'completed' }).catch(() => {}); } });
        window.addEventListener('pagehide', () => { if (localStream) localStream.getTracks().forEach(t => t.stop()); if (peerConnection) peerConnection.close(); });
    </script>
</body>
</html>
