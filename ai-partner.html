<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sprechen Buddy AI â€” German Made Easy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1209;
    --parchment: #faf6ef;
    --cream: #f3ece0;
    --gold: #c9963a;
    --gold-light: #e8c06a;
    --gold-pale: #f5e8c8;
    --forest: #2d5a3d;
    --forest-light: #4a8a5f;
    --red: #c0392b;
    --red-light: #e74c3c;
    --muted: #8a7d6a;
    --border: #ddd5c4;
    --shadow: rgba(26,18,9,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--parchment);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* â”€â”€ Background texture â”€â”€ */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      radial-gradient(ellipse at 20% 10%, rgba(201,150,58,0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 90%, rgba(45,90,61,0.06) 0%, transparent 50%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='60' height='60' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; z-index: 0;
  }

  /* â”€â”€ Auth overlay â”€â”€ */
  #auth-overlay {
    position: fixed; inset: 0;
    background: var(--ink);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
    flex-direction: column; gap: 1rem;
  }
  #auth-overlay p { color: var(--gold-light); font-family: 'DM Mono', monospace; font-size: 0.85rem; letter-spacing: 0.1em; }
  .auth-spinner {
    width: 40px; height: 40px;
    border: 3px solid rgba(201,150,58,0.2);
    border-top-color: var(--gold);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  /* â”€â”€ Access denied â”€â”€ */
  #access-denied {
    display: none;
    position: fixed; inset: 0;
    background: var(--parchment);
    align-items: center; justify-content: center;
    z-index: 999;
    flex-direction: column; gap: 1.5rem; text-align: center; padding: 2rem;
  }
  #access-denied h2 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--red); }
  #access-denied p { color: var(--muted); max-width: 400px; line-height: 1.6; }
  #access-denied a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--ink);
    color: var(--gold-light);
    text-decoration: none;
    font-weight: 600;
    letter-spacing: 0.05em;
    border-radius: 2px;
    transition: background 0.2s;
  }
  #access-denied a:hover { background: var(--forest); }

  /* â”€â”€ Top bar â”€â”€ */
  .topbar {
    position: relative; z-index: 10;
    display: flex; align-items: center; justify-content: space-between;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    background: rgba(250,246,239,0.9);
    backdrop-filter: blur(8px);
  }
  .topbar-brand {
    display: flex; align-items: center; gap: 0.75rem;
  }
  .topbar-logo {
    width: 36px; height: 36px;
    background: var(--ink);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: var(--gold-light); font-size: 1.1rem;
  }
  .topbar-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; }
  .topbar-sub { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .topbar-user { display: flex; align-items: center; gap: 1rem; }
  .user-badge {
    font-size: 0.75rem; font-family: 'DM Mono', monospace;
    background: var(--forest); color: #fff;
    padding: 0.25rem 0.65rem; border-radius: 20px;
    letter-spacing: 0.05em;
  }
  .topbar-back {
    font-size: 0.8rem; color: var(--muted); text-decoration: none;
    display: flex; align-items: center; gap: 0.3rem;
    transition: color 0.2s;
  }
  .topbar-back:hover { color: var(--ink); }

  /* â”€â”€ Main layout â”€â”€ */
  .container {
    position: relative; z-index: 1;
    max-width: 960px; margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  /* â”€â”€ Hero â”€â”€ */
  .hero {
    text-align: center; margin-bottom: 3rem;
    animation: fadeUp 0.6s ease both;
  }
  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 0.75rem;
  }
  .hero h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.2rem, 5vw, 3.5rem);
    font-weight: 900; line-height: 1.1;
    margin-bottom: 0.75rem;
  }
  .hero h1 span { color: var(--gold); }
  .hero p {
    font-size: 1.05rem; color: var(--muted);
    max-width: 520px; margin: 0 auto; line-height: 1.7;
  }

  /* â”€â”€ Setup panel â”€â”€ */
  #setup-panel {
    animation: fadeUp 0.6s 0.1s ease both;
  }

  .setup-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 1.5rem; margin-bottom: 1.5rem;
  }
  @media (max-width: 600px) { .setup-grid { grid-template-columns: 1fr; } }

  .setup-card {
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px var(--shadow);
  }
  .setup-card h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1rem; margin-bottom: 1rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .setup-card h3 span { font-size: 1.2rem; }

  .level-tabs { display: flex; gap: 0.5rem; }
  .level-tab {
    flex: 1;
    padding: 0.6rem; text-align: center;
    border: 1.5px solid var(--border);
    border-radius: 4px; cursor: pointer;
    font-weight: 600; font-size: 0.9rem;
    transition: all 0.2s; background: var(--cream);
    color: var(--muted);
  }
  .level-tab.active {
    background: var(--ink); color: var(--gold-light);
    border-color: var(--ink);
  }

  .scenario-select {
    width: 100%;
    padding: 0.7rem 0.9rem;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    background: var(--cream);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem; color: var(--ink);
    cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a7d6a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.9rem center;
    padding-right: 2.5rem;
  }
  .scenario-select:focus { outline: none; border-color: var(--gold); }

  .scenario-desc {
    margin-top: 0.6rem;
    font-size: 0.8rem; color: var(--muted);
    font-style: italic; line-height: 1.5;
    min-height: 2.5rem;
  }

  .input-mode-tabs { display: flex; gap: 0.5rem; }
  .mode-tab {
    flex: 1; padding: 0.6rem; text-align: center;
    border: 1.5px solid var(--border); border-radius: 4px;
    cursor: pointer; font-size: 0.85rem; font-weight: 500;
    background: var(--cream); color: var(--muted);
    transition: all 0.2s;
  }
  .mode-tab.active { background: var(--forest); color: #fff; border-color: var(--forest); }

  .start-btn {
    display: block; width: 100%;
    padding: 1.1rem;
    background: var(--ink);
    color: var(--gold-light);
    font-family: 'Playfair Display', serif;
    font-size: 1.25rem; font-weight: 700;
    letter-spacing: 0.04em;
    border: none; border-radius: 5px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    box-shadow: 0 4px 20px var(--shadow);
  }
  .start-btn:hover { background: var(--forest); transform: translateY(-1px); }
  .start-btn:active { transform: translateY(0); }

  /* â”€â”€ Session panel â”€â”€ */
  #session-panel { display: none; animation: fadeUp 0.5s ease both; }

  .session-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1.5rem; padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }
  .session-info h2 {
    font-family: 'Playfair Display', serif; font-size: 1.3rem;
  }
  .session-info p { font-size: 0.82rem; color: var(--muted); margin-top: 0.2rem; }
  .session-timer {
    font-family: 'DM Mono', monospace;
    font-size: 1.8rem; font-weight: 500;
    color: var(--ink); letter-spacing: 0.05em;
  }
  .session-timer.warning { color: var(--red); animation: pulse 1s infinite; }

  /* â”€â”€ Role card â”€â”€ */
  .role-card {
    background: var(--ink); color: var(--parchment);
    border-radius: 6px; padding: 1.25rem 1.5rem;
    margin-bottom: 1.25rem;
    display: flex; align-items: flex-start; gap: 1rem;
  }
  .role-avatar {
    width: 48px; height: 48px; min-width: 48px;
    background: var(--gold);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
  }
  .role-info h3 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 0.25rem; color: var(--gold-light); }
  .role-info p { font-size: 0.85rem; line-height: 1.6; opacity: 0.85; }

  /* â”€â”€ Conversation â”€â”€ */
  .conversation-box {
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    height: 340px; overflow-y: auto;
    padding: 1.25rem;
    margin-bottom: 1rem;
    scroll-behavior: smooth;
  }

  .msg {
    display: flex; gap: 0.75rem;
    margin-bottom: 1.1rem;
    animation: fadeUp 0.3s ease both;
  }
  .msg.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 34px; height: 34px; min-width: 34px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.95rem; font-weight: 700;
  }
  .msg.ai .msg-avatar { background: var(--ink); color: var(--gold-light); }
  .msg.user .msg-avatar { background: var(--forest); color: #fff; }

  .msg-bubble {
    max-width: 75%;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    font-size: 0.92rem; line-height: 1.6;
  }
  .msg.ai .msg-bubble {
    background: var(--cream);
    border: 1px solid var(--border);
    border-top-left-radius: 4px;
  }
  .msg.user .msg-bubble {
    background: var(--forest);
    color: #fff;
    border-top-right-radius: 4px;
  }
  .msg-time {
    font-size: 0.7rem; color: var(--muted);
    margin-top: 0.25rem;
    font-family: 'DM Mono', monospace;
  }
  .msg.user .msg-time { text-align: right; }

  /* â”€â”€ Feedback inline â”€â”€ */
  .feedback-inline {
    background: var(--gold-pale);
    border-left: 3px solid var(--gold);
    border-radius: 0 6px 6px 0;
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem; color: var(--ink);
    margin-top: 0.3rem; line-height: 1.5;
  }
  .feedback-inline strong { color: var(--forest); }

  /* â”€â”€ Thinking indicator â”€â”€ */
  .thinking {
    display: flex; gap: 0.4rem; align-items: center;
    padding: 0.5rem 0;
  }
  .thinking-dot {
    width: 8px; height: 8px;
    background: var(--muted); border-radius: 50%;
    animation: bounce 1.2s infinite;
  }
  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }

  /* â”€â”€ Input area â”€â”€ */
  .input-area {
    display: flex; gap: 0.75rem; align-items: flex-end;
    margin-bottom: 1rem;
  }
  .text-input-wrap { flex: 1; position: relative; }
  #text-input {
    width: 100%;
    padding: 0.85rem 1rem;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; color: var(--ink);
    background: #fff; resize: none;
    transition: border-color 0.2s;
    min-height: 50px; max-height: 120px;
  }
  #text-input:focus { outline: none; border-color: var(--gold); }
  #text-input::placeholder { color: var(--muted); }

  .send-btn, .mic-btn {
    width: 50px; height: 50px; min-width: 50px;
    border: none; border-radius: 6px;
    cursor: pointer; font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .send-btn { background: var(--ink); color: var(--gold-light); }
  .send-btn:hover { background: var(--forest); }
  .mic-btn { background: var(--cream); border: 1.5px solid var(--border); color: var(--muted); }
  .mic-btn.listening { background: var(--red); color: #fff; border-color: var(--red); animation: pulse 1s infinite; }
  .mic-btn:hover:not(.listening) { background: var(--border); }

  /* â”€â”€ Session controls â”€â”€ */
  .session-controls {
    display: flex; gap: 0.75rem; flex-wrap: wrap;
  }
  .ctrl-btn {
    padding: 0.55rem 1rem;
    border: 1.5px solid var(--border);
    background: var(--cream); color: var(--ink);
    border-radius: 4px; cursor: pointer;
    font-size: 0.82rem; font-weight: 500;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem;
  }
  .ctrl-btn:hover { background: var(--border); }
  .ctrl-btn.danger { border-color: var(--red-light); color: var(--red); }
  .ctrl-btn.danger:hover { background: var(--red-light); color: #fff; }

  /* â”€â”€ Score report â”€â”€ */
  #score-panel {
    display: none; animation: fadeUp 0.5s ease both;
  }

  .score-header {
    text-align: center; margin-bottom: 2rem;
  }
  .score-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem; margin-bottom: 0.5rem;
  }
  .score-header p { color: var(--muted); }

  .score-big {
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 2.5rem;
  }
  .score-circle {
    width: 140px; height: 140px;
    border-radius: 50%;
    background: conic-gradient(var(--gold) 0%, var(--gold) var(--pct, 75%), var(--cream) var(--pct, 75%));
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 0 8px var(--gold-pale), 0 4px 20px var(--shadow);
    position: relative;
  }
  .score-inner {
    width: 110px; height: 110px;
    background: #fff;
    border-radius: 50%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  .score-num {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem; font-weight: 900; line-height: 1;
  }
  .score-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }

  .criteria-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 1rem; margin-bottom: 2rem;
  }
  @media (max-width: 500px) { .criteria-grid { grid-template-columns: 1fr; } }

  .criterion-card {
    background: #fff; border: 1.5px solid var(--border);
    border-radius: 6px; padding: 1rem 1.25rem;
    box-shadow: 0 2px 8px var(--shadow);
  }
  .criterion-card h4 {
    font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 0.6rem;
    font-family: 'DM Mono', monospace;
  }
  .criterion-bar-wrap {
    height: 8px; background: var(--cream);
    border-radius: 4px; overflow: hidden; margin-bottom: 0.4rem;
  }
  .criterion-bar {
    height: 100%; border-radius: 4px;
    background: var(--gold);
    transition: width 1s ease;
  }
  .criterion-score { font-weight: 700; font-size: 1.1rem; }
  .criterion-comment { font-size: 0.8rem; color: var(--muted); margin-top: 0.3rem; line-height: 1.5; }

  .feedback-section {
    background: var(--cream); border: 1.5px solid var(--border);
    border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem;
  }
  .feedback-section h3 {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem; margin-bottom: 0.75rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .feedback-section p { font-size: 0.9rem; line-height: 1.7; color: var(--ink); }

  .errors-list { list-style: none; }
  .errors-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.87rem; line-height: 1.6;
  }
  .errors-list li:last-child { border-bottom: none; }
  .err-orig { color: var(--red); text-decoration: line-through; font-family: 'DM Mono', monospace; }
  .err-correct { color: var(--forest); font-family: 'DM Mono', monospace; font-weight: 600; }

  .score-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
  .score-actions button {
    padding: 0.8rem 1.75rem;
    border-radius: 4px; cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-weight: 600; font-size: 0.9rem;
    transition: all 0.2s;
  }
  .btn-primary { background: var(--ink); color: var(--gold-light); border: none; }
  .btn-primary:hover { background: var(--forest); }
  .btn-secondary { background: transparent; color: var(--ink); border: 1.5px solid var(--border); }
  .btn-secondary:hover { background: var(--cream); }

  /* â”€â”€ Notifications â”€â”€ */
  .toast {
    position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%);
    background: var(--ink); color: var(--parchment);
    padding: 0.75rem 1.5rem; border-radius: 4px;
    font-size: 0.85rem; z-index: 999;
    animation: fadeUp 0.3s ease both;
    font-family: 'DM Mono', monospace; letter-spacing: 0.04em;
    pointer-events: none;
  }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce {
    0%,60%,100% { transform: translateY(0); }
    30% { transform: translateY(-6px); }
  }

  /* â”€â”€ Voice transcript indicator â”€â”€ */
  .voice-transcript {
    background: var(--gold-pale);
    border: 1.5px dashed var(--gold);
    border-radius: 4px;
    padding: 0.6rem 0.9rem;
    font-size: 0.85rem; color: var(--ink);
    font-style: italic;
    margin-bottom: 0.5rem;
    display: none;
  }

  .sr-badge {
    display: inline-block;
    font-size: 0.65rem; font-family: 'DM Mono', monospace;
    background: var(--forest); color: #fff;
    padding: 0.1rem 0.4rem; border-radius: 10px;
    margin-left: 0.4rem; vertical-align: middle;
  }
</style>
</head>
<body>

<!-- â”€â”€ Auth checking overlay â”€â”€ -->
<div id="auth-overlay">
  <div class="auth-spinner"></div>
  <p>Verifying access...</p>
</div>

<!-- â”€â”€ Access denied screen â”€â”€ -->
<div id="access-denied" style="display:none; position:fixed; inset:0; background:var(--parchment); align-items:center; justify-content:center; z-index:999; flex-direction:column; gap:1.5rem; text-align:center; padding:2rem;">
  <div style="font-size:3rem;">ğŸ”’</div>
  <h2 style="font-family:'Playfair Display',serif; font-size:2rem; color:var(--red);">Access Restricted</h2>
  <p style="color:var(--muted); max-width:420px; line-height:1.6;">AI Practice Partner is available exclusively for enrolled students. Please log in with your course account or enrol to get access.</p>
  <a href="/dashboard.html" style="display:inline-block; padding:0.75rem 2rem; background:var(--ink); color:var(--gold-light); text-decoration:none; font-weight:600; letter-spacing:0.05em; border-radius:2px;">Go to Dashboard</a>
</div>

<!-- â”€â”€ Main app (hidden until auth confirmed) â”€â”€ -->
<div id="main-app" style="display:none;">

  <!-- Top bar -->
  <div class="topbar">
    <div class="topbar-brand">
      <div class="topbar-logo">ğŸ‡©ğŸ‡ª</div>
      <div>
        <div class="topbar-title">Sprechen Buddy AI</div>
        <div class="topbar-sub">German Made Easy</div>
      </div>
    </div>
    <div class="topbar-user">
      <span class="user-badge" id="level-badge">A1</span>
      <span id="user-name" style="font-size:0.85rem; color:var(--muted);"></span>
      <a href="/dashboard.html" class="topbar-back">â† Dashboard</a>
    </div>
  </div>

  <div class="container">

    <!-- â”€â”€ SETUP PANEL â”€â”€ -->
    <div id="setup-panel">
      <div class="hero">
        <div class="hero-eyebrow">ğŸ¤– AI Conversation Partner</div>
        <h1>Practise German<br><span>anytime, alone.</span></h1>
        <p>Your personal AI partner plays real Goethe &amp; TELC exam roles. Speak or type â€” get instant grammar feedback and a final score.</p>
      </div>

      <div class="setup-grid">
        <!-- Level -->
        <div class="setup-card">
          <h3><span>ğŸ“š</span> Your Level</h3>
          <div class="level-tabs">
            <div class="level-tab active" onclick="setLevel('A1')">A1 Beginner</div>
            <div class="level-tab" onclick="setLevel('A2')">A2 Elementary</div>
          </div>
        </div>

        <!-- Input mode -->
        <div class="setup-card">
          <h3><span>ğŸ™ï¸</span> How You'll Speak <span class="sr-badge">FREE</span></h3>
          <div class="input-mode-tabs">
            <div class="mode-tab active" onclick="setInputMode('both')">ğŸ™ï¸ + âŒ¨ï¸ Both</div>
            <div class="mode-tab" onclick="setInputMode('voice')">ğŸ™ï¸ Voice only</div>
            <div class="mode-tab" onclick="setInputMode('text')">âŒ¨ï¸ Type only</div>
          </div>
        </div>

        <!-- Scenario -->
        <div class="setup-card" style="grid-column: 1 / -1;">
          <h3><span>ğŸ­</span> Choose a Scenario</h3>
          <select class="scenario-select" id="scenario-select" onchange="onScenarioChange()">
            <optgroup label="â€” A1 Scenarios â€”">
              <option value="a1_shop" data-level="A1" data-role="Shopkeeper" data-emoji="ğŸ›’" data-desc="You're a customer at a German supermarket. Ask for items, quantities, and prices. The shopkeeper only speaks German.">ğŸ›’ At the Supermarket</option>
              <option value="a1_doctor" data-level="A1" data-role="Doctor" data-emoji="ğŸ¥" data-desc="You're at a German GP clinic. Describe your symptoms, answer the doctor's questions, and understand basic advice.">ğŸ¥ At the Doctor</option>
              <option value="a1_hotel" data-level="A1" data-role="Hotel Receptionist" data-emoji="ğŸ¨" data-desc="Check into a German hotel. Ask about room types, prices, breakfast, and facilities.">ğŸ¨ Hotel Check-in</option>
              <option value="a1_cafe" data-level="A1" data-role="CafÃ© Waiter" data-emoji="â˜•" data-desc="Order food and drinks at a German cafÃ©. Ask about the menu, specials, and pay the bill.">â˜• At the CafÃ©</option>
              <option value="a1_directions" data-level="A1" data-role="Passerby" data-emoji="ğŸ—ºï¸" data-desc="You're lost in a German city. Ask for directions to key locations, understand left/right, straight on.">ğŸ—ºï¸ Asking for Directions</option>
              <option value="a1_phone" data-level="A1" data-role="Office Secretary" data-emoji="ğŸ“" data-desc="Make a simple phone call to book an appointment in German.">ğŸ“ Making an Appointment</option>
              <option value="a1_introduce" data-level="A1" data-role="New Neighbour" data-emoji="ğŸ‘‹" data-desc="Introduce yourself to a new German neighbour. Share your name, country, job, and hobbies.">ğŸ‘‹ Introducing Yourself</option>
              <option value="a1_transport" data-level="A1" data-role="Ticket Office Staff" data-emoji="ğŸš‚" data-desc="Buy a train or bus ticket at a German station. Ask about times, platforms, and prices.">ğŸš‚ Buying a Train Ticket</option>
            </optgroup>
            <optgroup label="â€” A2 Scenarios â€”">
              <option value="a2_flat" data-level="A2" data-role="Landlord" data-emoji="ğŸ " data-desc="Discuss renting a flat in Germany. Ask about rent, deposit, utilities, and neighbourhood.">ğŸ  Renting a Flat</option>
              <option value="a2_job" data-level="A2" data-role="HR Manager" data-emoji="ğŸ’¼" data-desc="Attend a simple job interview for a part-time role. Describe your experience, strengths and ask questions.">ğŸ’¼ Job Interview</option>
              <option value="a2_bank" data-level="A2" data-role="Bank Clerk" data-emoji="ğŸ¦" data-desc="Open a bank account in Germany. Provide personal details, understand account types, ask about fees.">ğŸ¦ Opening a Bank Account</option>
              <option value="a2_complaint" data-level="A2" data-role="Shop Manager" data-emoji="âš ï¸" data-desc="Return a faulty product and make a complaint politely in German.">âš ï¸ Making a Complaint</option>
              <option value="a2_party" data-level="A2" data-role="German Friend" data-emoji="ğŸ‰" data-desc="Discuss plans for a party with a German friend. Talk about food, guests, location, and time.">ğŸ‰ Planning a Party</option>
              <option value="a2_health" data-level="A2" data-role="Pharmacist" data-emoji="ğŸ’Š" data-desc="Visit a German pharmacy. Describe symptoms, ask for medication, and follow dosage instructions.">ğŸ’Š At the Pharmacy</option>
              <option value="a2_school" data-level="A2" data-role="School Administrator" data-emoji="ğŸ«" data-desc="Enrol a child or yourself in a German school or language course. Ask about schedules and fees.">ğŸ« School Enrolment</option>
              <option value="a2_travel" data-level="A2" data-role="Travel Agent" data-emoji="âœˆï¸" data-desc="Book a holiday package at a German travel agency. Discuss destinations, dates, budget.">âœˆï¸ Booking a Holiday</option>
            </optgroup>
          </select>
          <div class="scenario-desc" id="scenario-desc">You're a customer at a German supermarket. Ask for items, quantities, and prices. The shopkeeper only speaks German.</div>
        </div>
      </div>

      <button class="start-btn" onclick="startSession()">ğŸ¬ Start Conversation</button>
    </div>

    <!-- â”€â”€ SESSION PANEL â”€â”€ -->
    <div id="session-panel">
      <div class="session-header">
        <div class="session-info">
          <h2 id="session-title">At the Supermarket</h2>
          <p id="session-subtitle">A1 Â· Supermarket scenario Â· AI Partner</p>
        </div>
        <div class="session-timer" id="session-timer">20:00</div>
      </div>

      <!-- Role card -->
      <div class="role-card">
        <div class="role-avatar" id="role-avatar">ğŸ›’</div>
        <div class="role-info">
          <h3 id="role-name">The Shopkeeper</h3>
          <p id="role-description">Your AI partner is playing a German shopkeeper. Respond in German. Don't worry about mistakes â€” you'll get feedback after!</p>
        </div>
      </div>

      <!-- Conversation -->
      <div class="conversation-box" id="conversation-box"></div>

      <!-- Voice transcript live -->
      <div class="voice-transcript" id="voice-transcript">ğŸ™ï¸ Listening...</div>

      <!-- Input area -->
      <div class="input-area" id="input-area">
        <div class="text-input-wrap">
          <textarea id="text-input" placeholder="Type your response in German... (or use the mic ğŸ™ï¸)" rows="1"
            onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage();}"></textarea>
        </div>
        <button class="mic-btn" id="mic-btn" onclick="toggleMic()" title="Voice input">ğŸ™ï¸</button>
        <button class="send-btn" onclick="sendMessage()" title="Send">â¤</button>
      </div>

      <!-- Controls -->
      <div class="session-controls">
        <button class="ctrl-btn" onclick="changeScenario()">ğŸ”„ Change Task</button>
        <button class="ctrl-btn" onclick="addTime()" id="add-time-btn">â±ï¸ +10 min</button>
        <button class="ctrl-btn" onclick="toggleFeedback()" id="feedback-btn">ğŸ’¡ Toggle Feedback</button>
        <button class="ctrl-btn danger" onclick="endSession()">ğŸ End &amp; Get Score</button>
      </div>
    </div>

    <!-- â”€â”€ SCORE PANEL â”€â”€ -->
    <div id="score-panel">
      <div class="score-header">
        <h2>ğŸ† Session Complete!</h2>
        <p id="score-scenario-label">Supermarket Â· A1 Â· AI Partner</p>
      </div>

      <div class="score-big">
        <div class="score-circle" id="score-circle">
          <div class="score-inner">
            <div class="score-num" id="score-num">â€”</div>
            <div class="score-label">/ 100</div>
          </div>
        </div>
      </div>

      <div class="criteria-grid">
        <div class="criterion-card">
          <h4>Vocabulary</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-vocab" style="width:0%"></div></div>
          <div class="criterion-score" id="score-vocab">â€”</div>
          <div class="criterion-comment" id="comment-vocab"></div>
        </div>
        <div class="criterion-card">
          <h4>Grammar</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-grammar" style="width:0%"></div></div>
          <div class="criterion-score" id="score-grammar">â€”</div>
          <div class="criterion-comment" id="comment-grammar"></div>
        </div>
        <div class="criterion-card">
          <h4>Fluency</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-fluency" style="width:0%"></div></div>
          <div class="criterion-score" id="score-fluency">â€”</div>
          <div class="criterion-comment" id="comment-fluency"></div>
        </div>
        <div class="criterion-card">
          <h4>Task Completion</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-task" style="width:0%"></div></div>
          <div class="criterion-score" id="score-task">â€”</div>
          <div class="criterion-comment" id="comment-task"></div>
        </div>
      </div>

      <div class="feedback-section" id="overall-feedback-box">
        <h3>ğŸ“ Overall Feedback</h3>
        <p id="overall-feedback-text">Loading...</p>
      </div>

      <div class="feedback-section" id="errors-box">
        <h3>âœï¸ Grammar Corrections</h3>
        <ul class="errors-list" id="errors-list"></ul>
      </div>

      <div class="score-actions">
        <button class="btn-primary" onclick="practiceAgain()">ğŸ”„ Practice Again</button>
        <button class="btn-secondary" onclick="goToDashboard()">â† Back to Dashboard</button>
      </div>
    </div>

  </div><!-- /container -->
</div><!-- /main-app -->

<!-- Firebase + App scripts -->
<script type="module">
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG â€” replace with your actual project config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, getDoc, updateDoc, increment, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E",
  authDomain: "german-made-easy.firebaseapp.com",
  projectId: "german-made-easy",
  storageBucket: "german-made-easy.firebasestorage.app",
  messagingSenderId: "259276936055",
  appId: "1:259276936055:web:5c9b4916734d0271100772",
  measurementId: "G-B7JMB0G85L"
};

const CLAUDE_PROXY_URL = 'https://ai-proxy.jeetupadhyay1204.workers.dev';
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// â”€â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let userProfile = null;
let selectedLevel = 'A1';
let selectedInputMode = 'both';
let selectedScenario = null;
let conversationHistory = [];
let sessionTimerInterval = null;
let sessionSeconds = 20 * 60;
let addTimeUsed = false;
let inlineFeedbackOn = true;
let isListening = false;
let recognition = null;
let grammarErrors = [];

// â”€â”€â”€ Auth gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    showAccessDenied();
    return;
  }
  // Check isPaidStudent in Firestore
  try {
    const snap = await getDoc(doc(db, 'users', user.uid));
    if (!snap.exists() || !snap.data().isPaidStudent) {
      showAccessDenied();
      return;
    }
    currentUser = user;
    userProfile = snap.data();
    showApp();
  } catch (e) {
    console.error(e);
    showAccessDenied();
  }
});

function showAccessDenied() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('access-denied').style.display = 'flex';
}

function showApp() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  // Pre-set level from profile if available
  if (userProfile?.level) {
    setLevel(userProfile.level.toUpperCase() === 'A2' ? 'A2' : 'A1');
  }
  document.getElementById('user-name').textContent = userProfile?.displayName || currentUser.email.split('@')[0];
  onScenarioChange();
}

// â”€â”€â”€ Expose functions to global scope (called from HTML onclick) â”€â”€â”€â”€
window.setLevel = (l) => {
  selectedLevel = l;
  document.querySelectorAll('.level-tab').forEach(t => t.classList.toggle('active', t.textContent.startsWith(l)));
  document.getElementById('level-badge').textContent = l;
};

window.setInputMode = (m) => {
  selectedInputMode = m;
  document.querySelectorAll('.mode-tab').forEach(t => {
    t.classList.toggle('active', t.getAttribute('onclick').includes(`'${m}'`));
  });
};

window.onScenarioChange = () => {
  const sel = document.getElementById('scenario-select');
  const opt = sel.options[sel.selectedIndex];
  document.getElementById('scenario-desc').textContent = opt.dataset.desc || '';
};

// â”€â”€â”€ START SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.startSession = async () => {
  const sel = document.getElementById('scenario-select');
  const opt = sel.options[sel.selectedIndex];

  selectedScenario = {
    id: sel.value,
    title: opt.text,
    level: opt.dataset.level,
    role: opt.dataset.role,
    emoji: opt.dataset.emoji,
    desc: opt.dataset.desc
  };

  // Show session panel
  document.getElementById('setup-panel').style.display = 'none';
  document.getElementById('session-panel').style.display = 'block';

  // Populate UI
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent =
    `${selectedScenario.level} Â· ${selectedScenario.role} scenario Â· AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;

  // Apply input mode UI
  const inputArea = document.getElementById('input-area');
  const micBtn = document.getElementById('mic-btn');
  const textInput = document.getElementById('text-input');
  if (selectedInputMode === 'voice') {
    textInput.style.display = 'none';
    micBtn.style.display = 'flex';
  } else if (selectedInputMode === 'text') {
    micBtn.style.display = 'none';
  } else {
    textInput.style.display = '';
    micBtn.style.display = 'flex';
  }

  // Reset state
  conversationHistory = [];
  grammarErrors = [];
  sessionSeconds = 20 * 60;
  addTimeUsed = false;
  document.getElementById('add-time-btn').disabled = false;
  document.getElementById('conversation-box').innerHTML = '';
  updateTimer();

  // Start timer
  sessionTimerInterval = setInterval(() => {
    sessionSeconds--;
    updateTimer();
    if (sessionSeconds <= 0) endSession();
  }, 1000);

  // Init speech recognition
  initSpeechRecognition();

  // AI sends opening line
  await sendAIMessage(null, true);
};

// â”€â”€â”€ TIMER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateTimer() {
  const m = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
  const s = (sessionSeconds % 60).toString().padStart(2, '0');
  const el = document.getElementById('session-timer');
  el.textContent = `${m}:${s}`;
  el.classList.toggle('warning', sessionSeconds < 120);
}

// â”€â”€â”€ SEND USER MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.sendMessage = async () => {
  const inp = document.getElementById('text-input');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';

  appendMessage('user', text);
  conversationHistory.push({ role: 'user', content: text });

  await sendAIMessage(text);
};

// â”€â”€â”€ SPEECH RECOGNITION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSpeechRecognition() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    document.getElementById('mic-btn').style.display = 'none';
    toast('Voice input not supported in this browser. Use Chrome.');
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'de-DE';
  recognition.interimResults = true;
  recognition.continuous = false;

  recognition.onstart = () => {
    isListening = true;
    document.getElementById('mic-btn').classList.add('listening');
    document.getElementById('mic-btn').textContent = 'â¹ï¸';
    const vt = document.getElementById('voice-transcript');
    vt.style.display = 'block';
    vt.textContent = 'ğŸ™ï¸ Listening...';
  };

  recognition.onresult = (e) => {
    let interim = '';
    let final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    const vt = document.getElementById('voice-transcript');
    vt.textContent = 'ğŸ™ï¸ ' + (final || interim || 'Listening...');
    if (final) {
      document.getElementById('text-input').value = final;
    }
  };

  recognition.onend = () => {
    isListening = false;
    document.getElementById('mic-btn').classList.remove('listening');
    document.getElementById('mic-btn').textContent = 'ğŸ™ï¸';
    const vt = document.getElementById('voice-transcript');
    const transcript = (vt.textContent || '').replace('ğŸ™ï¸ ', '').trim();
    vt.style.display = 'none';
    if (transcript && transcript !== 'Listening...') {
      document.getElementById('text-input').value = transcript;
      sendMessage();
    }
  };

  recognition.onerror = (e) => {
    console.error('Speech error:', e.error);
    isListening = false;
    document.getElementById('mic-btn').classList.remove('listening');
    document.getElementById('mic-btn').textContent = 'ğŸ™ï¸';
  };
}

  recognition.onend = () => {
    isListening = false;
    document.getElementById('mic-btn').classList.remove('listening');
    document.getElementById('mic-btn').textContent = 'ğŸ™ï¸';
    const vt = document.getElementById('voice-transcript');
    const transcript = vt.textContent.replace('ğŸ™ï¸ ', '').trim();
    vt.style.display = 'none';
    if (transcript && transcript !== 'Listening...') {
      document.getElementById('text-input').value = transcript;
      sendMessage();
    }
  };

  recognition.onerror = () => {
    recognition.stop();
  };
}

window.toggleMic = () => {
  if (!recognition) { initSpeechRecognition(); }
  if (isListening) {
    recognition.stop();
  } else {
    try { recognition.start(); } catch(e) { recognition = null; initSpeechRecognition(); recognition?.start(); }
  }
};

// â”€â”€â”€ SEND AI MESSAGE (calls Cloud Function proxy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendAIMessage(userText, isOpening = false) {
  showThinking();

  const systemPrompt = buildSystemPrompt(isOpening);

  // Build messages array for Claude
  let messages = [];
  if (isOpening) {
    messages = [{ role: 'user', content: 'START_CONVERSATION' }];
  } else {
    messages = [...conversationHistory];
  }

  try {
    const res = await fetch(CLAUDE_PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await currentUser.getIdToken()}` },
      body: JSON.stringify({ systemPrompt, messages, userId: currentUser.uid })
    });

    if (!res.ok) throw new Error('Proxy error ' + res.status);
    const data = await res.json();
    const raw = data.reply || '';

    removeThinking();

    // Parse JSON response from Claude
    let parsed;
    try {
      const jsonMatch = raw.match(/\{[\s\S]*\}/);
      parsed = jsonMatch ? JSON.parse(jsonMatch[0]) : { reply: raw, feedback: null };
    } catch {
      parsed = { reply: raw, feedback: null };
    }

    const aiText = parsed.reply || raw;
    conversationHistory.push({ role: 'assistant', content: aiText });

    appendMessage('ai', aiText, parsed.feedback);

    // Collect grammar errors for final report
    if (parsed.feedback?.error && userText) {
      grammarErrors.push({ original: userText, corrected: parsed.feedback.corrected, note: parsed.feedback.note });
    }

    // AI speaks (TTS)
    speakText(aiText);

  } catch (err) {
    removeThinking();
    appendMessage('ai', 'Entschuldigung, da ist etwas schiefgelaufen. Bitte versuche es nochmal! ğŸ™');
    console.error(err);
  }
}

function buildSystemPrompt(isOpening) {
  const level = selectedScenario.level;
  const role = selectedScenario.role;
  const scenario = selectedScenario.title;
  const desc = selectedScenario.desc;

  return `You are an AI German language partner for ${level} learners playing the role of a ${role} in a "${scenario}" scenario.

SCENARIO: ${desc}

YOUR ROLE:
- Stay strictly in character as the ${role}. ALWAYS reply in German, appropriate for ${level} level.
- Keep sentences short and clear (${level} vocabulary only).
- If the user speaks English, gently nudge them back to German in character.
- If the user makes a grammar mistake, note it SUBTLY in the feedback field, NOT in your main reply.

RESPONSE FORMAT â€” You MUST always reply with valid JSON:
{
  "reply": "<your in-character German response here>",
  "feedback": ${inlineFeedbackOn ? `{
    "error": true/false,
    "corrected": "<corrected version of what they said, or null>",
    "note": "<brief English tip, e.g. 'Use accusative: einen Apfel'>",
    "praise": "<optional short praise in English>"
  }` : 'null'}
}

${isOpening ? 'This is the opening line. Greet the student in character to begin the scenario.' : ''}

Keep the conversation going naturally. Ask follow-up questions. Make it feel real.`;
}

// â”€â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speakText(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utt = new SpeechSynthesisUtterance(text);
  utt.lang = 'de-DE';
  utt.rate = 0.92;
  utt.pitch = 1.05;
  // Try to find a German voice
  const voices = window.speechSynthesis.getVoices();
  const germanVoice = voices.find(v => v.lang.startsWith('de'));
  if (germanVoice) utt.voice = germanVoice;
  window.speechSynthesis.speak(utt);
}

// â”€â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(who, text, feedback) {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = `msg ${who}`;

  const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  const avatarChar = who === 'ai' ? selectedScenario?.emoji || 'ğŸ¤–' : 'ğŸ‘¤';

  let feedbackHTML = '';
  if (feedback && inlineFeedbackOn) {
    if (feedback.error && feedback.corrected) {
      feedbackHTML = `<div class="feedback-inline">âœï¸ <strong>Korrektur:</strong> ${feedback.corrected} â€” <em>${feedback.note || ''}</em></div>`;
    } else if (feedback.praise) {
      feedbackHTML = `<div class="feedback-inline">âœ… ${feedback.praise}</div>`;
    }
  }

  div.innerHTML = `
    <div class="msg-avatar">${avatarChar}</div>
    <div>
      <div class="msg-bubble">${escHtml(text)}</div>
      ${feedbackHTML}
      <div class="msg-time">${now}</div>
    </div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showThinking() {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = 'msg ai'; div.id = 'thinking-indicator';
  div.innerHTML = `<div class="msg-avatar">${selectedScenario?.emoji || 'ğŸ¤–'}</div>
    <div class="msg-bubble"><div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div></div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function removeThinking() {
  document.getElementById('thinking-indicator')?.remove();
}

function escHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function toast(msg, duration = 3000) {
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), duration);
}

// â”€â”€â”€ SESSION CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.changeScenario = async () => {
  // Pick a random different scenario from same level
  const all = [...document.getElementById('scenario-select').options];
  const same = all.filter(o => o.dataset.level === selectedScenario.level && o.value !== selectedScenario.id);
  if (!same.length) { toast('No more scenarios for this level!'); return; }
  const pick = same[Math.floor(Math.random() * same.length)];

  selectedScenario = {
    id: pick.value, title: pick.text,
    level: pick.dataset.level, role: pick.dataset.role,
    emoji: pick.dataset.emoji, desc: pick.dataset.desc
  };

  conversationHistory = [];
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent =
    `${selectedScenario.level} Â· ${selectedScenario.role} scenario Â· AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;
  document.getElementById('conversation-box').innerHTML = '';

  toast(`ğŸ”„ New scenario: ${selectedScenario.title}`);
  await sendAIMessage(null, true);
};

window.addTime = () => {
  if (addTimeUsed) { toast('You can only add time once per session.'); return; }
  sessionSeconds += 10 * 60;
  addTimeUsed = true;
  document.getElementById('add-time-btn').disabled = true;
  toast('â±ï¸ +10 minutes added!');
};

window.toggleFeedback = () => {
  inlineFeedbackOn = !inlineFeedbackOn;
  document.getElementById('feedback-btn').textContent = inlineFeedbackOn ? 'ğŸ’¡ Toggle Feedback' : 'ğŸ’¡ Feedback Off';
  toast(inlineFeedbackOn ? 'ğŸ’¡ Inline feedback ON' : 'ğŸ”• Inline feedback OFF');
};

// â”€â”€â”€ END SESSION & SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.endSession = async () => {
  clearInterval(sessionTimerInterval);
  window.speechSynthesis?.cancel();
  if (isListening) recognition?.stop();

  document.getElementById('session-panel').style.display = 'none';
  document.getElementById('score-panel').style.display = 'block';
  document.getElementById('score-scenario-label').textContent =
    `${selectedScenario.title} Â· ${selectedScenario.level} Â· AI Partner`;

  // Ask Claude to evaluate the full conversation
  const evaluationPrompt = buildEvaluationPrompt();

  try {
    const res = await fetch(CLAUDE_PROXY_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${await currentUser.getIdToken()}` },
      body: JSON.stringify({
        systemPrompt: evaluationPrompt.system,
        messages: evaluationPrompt.messages,
        userId: currentUser.uid,
        maxTokens: 800
      })
    });
    const data = await res.json();
    const raw = data.reply || '{}';
    let eval_;
    try {
      const m = raw.match(/\{[\s\S]*\}/);
      eval_ = m ? JSON.parse(m[0]) : {};
    } catch { eval_ = {}; }
    displayScore(eval_);
    // Save to Firestore
    await saveSessionToFirestore(eval_);
  } catch(e) {
    console.error(e);
    displayScore({});
  }
};

function buildEvaluationPrompt() {
  const transcript = conversationHistory
    .map(m => `${m.role === 'user' ? 'Student' : 'AI'}: ${m.content}`)
    .join('\n');

  return {
    system: `You are a strict but fair Goethe/TELC German exam evaluator for ${selectedScenario.level} level.
Evaluate the student's German from the conversation transcript.
Reply ONLY with valid JSON, no extra text:
{
  "overall": <0-100>,
  "vocabulary": <0-100>,
  "grammar": <0-100>,
  "fluency": <0-100>,
  "taskCompletion": <0-100>,
  "vocabComment": "<1 sentence English comment>",
  "grammarComment": "<1 sentence>",
  "fluencyComment": "<1 sentence>",
  "taskComment": "<1 sentence>",
  "overallFeedback": "<3-4 sentences English overall feedback, be constructive>",
  "topErrors": [{"original":"<what they said>","corrected":"<correct form>","note":"<brief tip>"}]
}`,
    messages: [{ role: 'user', content: `Here is the full conversation transcript:\n\n${transcript}\n\nPlease evaluate the student's performance.` }]
  };
}

function displayScore(eval_) {
  const overall = eval_.overall ?? 65;
  const vocab = eval_.vocabulary ?? 60;
  const grammar = eval_.grammar ?? 60;
  const fluency = eval_.fluency ?? 60;
  const task = eval_.taskCompletion ?? 60;

  document.getElementById('score-num').textContent = overall;
  document.getElementById('score-circle').style.setProperty('--pct', `${overall}%`);

  const setBar = (id, val, comment, commentId) => {
    setTimeout(() => {
      document.getElementById(id).style.width = `${val}%`;
      document.getElementById(`score-${id.replace('bar-','')}` ).textContent = `${val}/100`;
      document.getElementById(commentId).textContent = comment || '';
    }, 200);
  };
  setBar('bar-vocab', vocab, eval_.vocabComment, 'comment-vocab');
  setBar('bar-grammar', grammar, eval_.grammarComment, 'comment-grammar');
  setBar('bar-fluency', fluency, eval_.fluencyComment, 'comment-fluency');
  setBar('bar-task', task, eval_.taskComment, 'comment-task');

  document.getElementById('overall-feedback-text').textContent =
    eval_.overallFeedback || 'Great effort! Keep practising every day to improve your German. Consistency is key for language learning.';

  // Grammar errors list
  const allErrors = [...grammarErrors, ...(eval_.topErrors || [])];
  const errList = document.getElementById('errors-list');
  errList.innerHTML = '';
  if (!allErrors.length) {
    errList.innerHTML = '<li>No major errors found â€” excellent work! ğŸ‰</li>';
  } else {
    allErrors.slice(0, 6).forEach(e => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="err-orig">${escHtml(e.original || '')}</span> â†’ <span class="err-correct">${escHtml(e.corrected || '')}</span><br><small>${escHtml(e.note || '')}</small>`;
      errList.appendChild(li);
    });
  }
}

async function saveSessionToFirestore(eval_) {
  try {
    const userRef = doc(db, 'users', currentUser.uid);
    await updateDoc(userRef, {
      aiSessionsCompleted: increment(1),
      totalPoints: increment(30),
      lastAiSession: serverTimestamp()
    });
    // Optionally save session record
    const { addDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await addDoc(collection(db, 'aiSessions'), {
      userId: currentUser.uid,
      scenario: selectedScenario.id,
      level: selectedScenario.level,
      score: eval_.overall ?? 0,
      timestamp: serverTimestamp()
    });
  } catch(e) { console.error('Firestore save error:', e); }
}

window.practiceAgain = () => {
  document.getElementById('score-panel').style.display = 'none';
  document.getElementById('setup-panel').style.display = 'block';
};
window.goToDashboard = () => { window.location.href = '/dashboard.html'; };

</script>
</body>
</html>
