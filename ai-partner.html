<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aura ‚Äî German Made Easy</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #1a1209;
    --parchment: #faf6ef;
    --cream: #f3ece0;
    --gold: #c9963a;
    --gold-light: #e8c06a;
    --gold-pale: #f5e8c8;
    --forest: #2d5a3d;
    --forest-light: #4a8a5f;
    --red: #c0392b;
    --red-light: #e74c3c;
    --muted: #8a7d6a;
    --border: #ddd5c4;
    --shadow: rgba(26,18,9,0.12);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--parchment); color: var(--ink); min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0;
    background-image: radial-gradient(ellipse at 20% 10%, rgba(201,150,58,0.06) 0%, transparent 50%), radial-gradient(ellipse at 80% 90%, rgba(45,90,61,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }
  #auth-overlay { position: fixed; inset: 0; background: var(--ink); display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; gap: 1rem; }
  #auth-overlay p { color: var(--gold-light); font-family: 'DM Mono', monospace; font-size: 0.85rem; letter-spacing: 0.1em; }
  .auth-spinner { width: 40px; height: 40px; border: 3px solid rgba(201,150,58,0.2); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  #access-denied { display: none; position: fixed; inset: 0; background: var(--parchment); align-items: center; justify-content: center; z-index: 999; flex-direction: column; gap: 1.5rem; text-align: center; padding: 2rem; }
  #access-denied h2 { font-family: 'Playfair Display', serif; font-size: 2rem; color: var(--red); }
  #access-denied p { color: var(--muted); max-width: 400px; line-height: 1.6; }
  #access-denied a { display: inline-block; padding: 0.75rem 2rem; background: var(--ink); color: var(--gold-light); text-decoration: none; font-weight: 600; border-radius: 2px; }
  #trial-limit-modal { display: none; position: fixed; inset: 0; background: rgba(26,18,9,0.72); align-items: center; justify-content: center; z-index: 1000; padding: 1.5rem; }
  #trial-limit-modal.visible { display: flex; }
  .trial-modal-card { background: var(--parchment); border-radius: 8px; padding: 2.5rem 2rem; max-width: 440px; width: 100%; text-align: center; box-shadow: 0 8px 40px rgba(26,18,9,0.35); animation: fadeUp 0.4s ease both; }
  .trial-badge { display: inline-block; background: var(--gold-pale); color: var(--gold); font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; padding: 0.3rem 0.85rem; border-radius: 20px; margin-bottom: 1.25rem; }
  .trial-modal-card h2 { font-family: 'Playfair Display', serif; font-size: 1.75rem; color: var(--ink); margin-bottom: 0.75rem; }
  .trial-modal-card p { color: var(--muted); line-height: 1.65; margin-bottom: 1.75rem; max-width: 360px; margin-left: auto; margin-right: auto; }
  .trial-modal-btn { display: inline-block; padding: 0.85rem 2.25rem; background: var(--ink); color: var(--gold-light); text-decoration: none; font-weight: 700; font-family: 'Playfair Display', serif; font-size: 1.05rem; border-radius: 4px; transition: background 0.2s; }
  .trial-modal-btn:hover { background: var(--forest); }
  .trial-counter-badge { display: inline-block; font-family: 'DM Mono', monospace; font-size: 0.72rem; color: var(--muted); background: var(--cream); border: 1px solid var(--border); border-radius: 20px; padding: 0.2rem 0.7rem; }
  #trial-counter-wrap { display: none; text-align: center; margin-bottom: 0.75rem; }
  .topbar { position: relative; z-index: 10; display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; border-bottom: 1px solid var(--border); background: rgba(250,246,239,0.9); backdrop-filter: blur(8px); }
  .topbar-brand { display: flex; align-items: center; gap: 0.75rem; }
  .topbar-logo { width: 36px; height: 36px; background: var(--ink); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--gold-light); font-size: 1.1rem; }
  .topbar-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 700; }
  .topbar-sub { font-size: 0.75rem; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; }
  .topbar-user { display: flex; align-items: center; gap: 1rem; }
  .user-badge { font-size: 0.75rem; font-family: 'DM Mono', monospace; background: var(--forest); color: #fff; padding: 0.25rem 0.65rem; border-radius: 20px; }
  .topbar-back { font-size: 0.8rem; color: var(--muted); text-decoration: none; transition: color 0.2s; }
  .topbar-back:hover { color: var(--ink); }
  .container { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; padding: 2rem 1.5rem 4rem; }
  .hero { text-align: center; margin-bottom: 3rem; animation: fadeUp 0.6s ease both; }
  .hero-eyebrow { font-family: 'DM Mono', monospace; font-size: 0.7rem; letter-spacing: 0.18em; text-transform: uppercase; color: var(--gold); margin-bottom: 0.75rem; }
  .hero h1 { font-family: 'Playfair Display', serif; font-size: clamp(2.2rem, 5vw, 3.5rem); font-weight: 900; line-height: 1.1; margin-bottom: 0.75rem; }
  .hero h1 span { color: var(--gold); }
  .hero p { font-size: 1.05rem; color: var(--muted); max-width: 520px; margin: 0 auto; line-height: 1.7; }
  #setup-panel { animation: fadeUp 0.6s 0.1s ease both; }
  .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
  @media (max-width: 600px) { .setup-grid { grid-template-columns: 1fr; } }
  .setup-card { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; padding: 1.5rem; box-shadow: 0 2px 12px var(--shadow); }
  .setup-card h3 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
  .level-tabs { display: flex; gap: 0.5rem; }
  .level-tab { flex: 1; padding: 0.6rem; text-align: center; border: 1.5px solid var(--border); border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; background: var(--cream); color: var(--muted); }
  .level-tab.active { background: var(--ink); color: var(--gold-light); border-color: var(--ink); }
  .scenario-select { width: 100%; padding: 0.7rem 0.9rem; border: 1.5px solid var(--border); border-radius: 4px; background: var(--cream); font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a7d6a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.9rem center; padding-right: 2.5rem; }
  .scenario-select:focus { outline: none; border-color: var(--gold); }
  .scenario-desc { margin-top: 0.6rem; font-size: 0.8rem; color: var(--muted); font-style: italic; line-height: 1.5; min-height: 2.5rem; }
  .input-mode-tabs { display: flex; gap: 0.5rem; }
  .mode-tab { flex: 1; padding: 0.6rem; text-align: center; border: 1.5px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 0.85rem; font-weight: 500; background: var(--cream); color: var(--muted); transition: all 0.2s; }
  .mode-tab.active { background: var(--forest); color: #fff; border-color: var(--forest); }
  .start-btn { display: block; width: 100%; padding: 1.1rem; background: var(--ink); color: var(--gold-light); font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700; border: none; border-radius: 5px; cursor: pointer; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 20px var(--shadow); }
  .start-btn:hover { background: var(--forest); transform: translateY(-1px); }
  #session-panel { display: none; animation: fadeUp 0.5s ease both; }
  .session-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
  .session-info h2 { font-family: 'Playfair Display', serif; font-size: 1.3rem; }
  .session-info p { font-size: 0.82rem; color: var(--muted); margin-top: 0.2rem; }
  .session-timer { font-family: 'DM Mono', monospace; font-size: 1.8rem; font-weight: 500; color: var(--ink); letter-spacing: 0.05em; }
  .session-timer.warning { color: var(--red); animation: pulse 1s infinite; }
  .role-card { background: var(--ink); color: var(--parchment); border-radius: 6px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem; display: flex; align-items: flex-start; gap: 1rem; }
  .role-avatar { width: 48px; height: 48px; min-width: 48px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
  .role-info h3 { font-family: 'Playfair Display', serif; font-size: 1rem; margin-bottom: 0.25rem; color: var(--gold-light); }
  .role-info p { font-size: 0.85rem; line-height: 1.6; opacity: 0.85; }
  .ai-speaking-banner { display: none; align-items: center; gap: 0.6rem; background: var(--ink); color: var(--gold-light); padding: 0.6rem 1rem; border-radius: 4px; font-size: 0.82rem; font-family: 'DM Mono', monospace; margin-bottom: 0.75rem; }
  .ai-speaking-banner.visible { display: flex; }
  .speaking-wave { display: flex; gap: 3px; align-items: center; }
  .speaking-wave span { display: inline-block; width: 3px; background: var(--gold); border-radius: 2px; animation: wave 0.8s infinite; }
  .speaking-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
  .speaking-wave span:nth-child(2) { height: 14px; animation-delay: 0.1s; }
  .speaking-wave span:nth-child(3) { height: 10px; animation-delay: 0.2s; }
  .speaking-wave span:nth-child(4) { height: 16px; animation-delay: 0.15s; }
  .speaking-wave span:nth-child(5) { height: 8px; animation-delay: 0.05s; }
  @keyframes wave { 0%, 100% { transform: scaleY(0.5); } 50% { transform: scaleY(1); } }
  .recording-status { display: none; align-items: center; gap: 0.75rem; background: #fff0f0; border: 1.5px solid var(--red-light); border-radius: 4px; padding: 0.6rem 1rem; margin-bottom: 0.75rem; font-size: 0.85rem; color: var(--red); font-family: 'DM Mono', monospace; }
  .recording-status.visible { display: flex; }
  .rec-dot { width: 10px; height: 10px; background: var(--red); border-radius: 50%; animation: pulse 1s infinite; flex-shrink: 0; }
  .processing-status { display: none; align-items: center; gap: 0.75rem; background: #f0f7ff; border: 1.5px solid #93c5fd; border-radius: 4px; padding: 0.6rem 1rem; margin-bottom: 0.75rem; font-size: 0.85rem; color: #1d4ed8; font-family: 'DM Mono', monospace; }
  .processing-status.visible { display: flex; }
  .conversation-box { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; height: 340px; overflow-y: auto; padding: 1.25rem; margin-bottom: 1rem; scroll-behavior: smooth; }
  .msg { display: flex; gap: 0.75rem; margin-bottom: 1.1rem; animation: fadeUp 0.3s ease both; }
  .msg.user { flex-direction: row-reverse; }
  .msg-avatar { width: 34px; height: 34px; min-width: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: 700; }
  .msg.ai .msg-avatar { background: var(--ink); color: var(--gold-light); }
  .msg.user .msg-avatar { background: var(--forest); color: #fff; }
  .msg-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.92rem; line-height: 1.6; }
  .msg.ai .msg-bubble { background: var(--cream); border: 1px solid var(--border); border-top-left-radius: 4px; }
  .msg.user .msg-bubble { background: var(--forest); color: #fff; border-top-right-radius: 4px; }
  .msg-time { font-size: 0.7rem; color: var(--muted); margin-top: 0.25rem; font-family: 'DM Mono', monospace; }
  .msg.user .msg-time { text-align: right; }
  .feedback-inline { background: var(--gold-pale); border-left: 3px solid var(--gold); border-radius: 0 6px 6px 0; padding: 0.5rem 0.75rem; font-size: 0.8rem; color: var(--ink); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-inline strong { color: var(--forest); }
  .feedback-pronunciation { background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 0 6px 6px 0; padding: 0.5rem 0.75rem; font-size: 0.8rem; color: var(--ink); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-pronunciation strong { color: #1d4ed8; }
  .thinking { display: flex; gap: 0.4rem; align-items: center; padding: 0.5rem 0; }
  .thinking-dot { width: 8px; height: 8px; background: var(--muted); border-radius: 50%; animation: bounce 1.2s infinite; }
  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
  .input-area { display: flex; gap: 0.75rem; align-items: flex-end; margin-bottom: 1rem; }
  .text-input-wrap { flex: 1; }
  #text-input { width: 100%; padding: 0.85rem 1rem; border: 1.5px solid var(--border); border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; color: var(--ink); background: #fff; resize: none; transition: border-color 0.2s; min-height: 50px; max-height: 120px; }
  #text-input:focus { outline: none; border-color: var(--gold); }
  #text-input::placeholder { color: var(--muted); }
  .send-btn, .mic-btn { width: 50px; height: 50px; min-width: 50px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .send-btn { background: var(--ink); color: var(--gold-light); }
  .send-btn:hover { background: var(--forest); }
  .mic-btn { background: var(--cream); border: 1.5px solid var(--border); color: var(--muted); }
  .mic-btn.recording { background: var(--red); color: #fff; border-color: var(--red); }
  .mic-btn.processing { background: #3b82f6; color: #fff; border-color: #3b82f6; cursor: wait; }
  .mic-btn.waiting { background: #9ca3af; color: #fff; border-color: #9ca3af; cursor: not-allowed; }
  .mic-btn:hover:not(.recording):not(.processing):not(.waiting) { background: var(--border); }
  .session-controls { display: flex; gap: 0.75rem; flex-wrap: wrap; }
  .ctrl-btn { padding: 0.55rem 1rem; border: 1.5px solid var(--border); background: var(--cream); color: var(--ink); border-radius: 4px; cursor: pointer; font-size: 0.82rem; font-weight: 500; font-family: 'DM Sans', sans-serif; transition: all 0.2s; display: flex; align-items: center; gap: 0.4rem; }
  .ctrl-btn:hover { background: var(--border); }
  .ctrl-btn.danger { border-color: var(--red-light); color: var(--red); }
  .ctrl-btn.danger:hover { background: var(--red-light); color: #fff; }
  #score-panel { display: none; animation: fadeUp 0.5s ease both; }
  .score-header { text-align: center; margin-bottom: 2rem; }
  .score-header h2 { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 0.5rem; }
  .score-header p { color: var(--muted); }
  .score-big { display: flex; align-items: center; justify-content: center; margin-bottom: 2.5rem; }
  .score-circle { width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--gold) 0%, var(--gold) var(--pct, 75%), var(--cream) var(--pct, 75%)); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 8px var(--gold-pale), 0 4px 20px var(--shadow); }
  .score-inner { width: 110px; height: 110px; background: #fff; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .score-num { font-family: 'Playfair Display', serif; font-size: 2.2rem; font-weight: 900; line-height: 1; }
  .score-label { font-size: 0.7rem; color: var(--muted); letter-spacing: 0.1em; text-transform: uppercase; }
  .criteria-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem; }
  @media (max-width: 500px) { .criteria-grid { grid-template-columns: 1fr; } }
  .criterion-card { background: #fff; border: 1.5px solid var(--border); border-radius: 6px; padding: 1rem 1.25rem; box-shadow: 0 2px 8px var(--shadow); }
  .criterion-card h4 { font-size: 0.8rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); margin-bottom: 0.6rem; font-family: 'DM Mono', monospace; }
  .criterion-bar-wrap { height: 8px; background: var(--cream); border-radius: 4px; overflow: hidden; margin-bottom: 0.4rem; }
  .criterion-bar { height: 100%; border-radius: 4px; background: var(--gold); transition: width 1s ease; }
  .criterion-score { font-weight: 700; font-size: 1.1rem; }
  .criterion-comment { font-size: 0.8rem; color: var(--muted); margin-top: 0.3rem; line-height: 1.5; }
  .feedback-section { background: var(--cream); border: 1.5px solid var(--border); border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem; }
  .feedback-section h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 0.75rem; }
  .feedback-section p { font-size: 0.9rem; line-height: 1.7; }
  .pronunciation-section { background: #eff6ff; border: 1.5px solid #bfdbfe; border-radius: 6px; padding: 1.5rem; margin-bottom: 2rem; }
  .pronunciation-section h3 { font-family: 'Playfair Display', serif; font-size: 1.1rem; margin-bottom: 1rem; color: #1e40af; }
  .pronunciation-tip { background: #fff; border: 1px solid #bfdbfe; border-radius: 6px; padding: 0.75rem 1rem; margin-bottom: 0.6rem; font-size: 0.85rem; line-height: 1.6; }
  .pronunciation-tip .word { font-family: 'DM Mono', monospace; font-weight: 600; color: #1d4ed8; }
  .pronunciation-tip .gujarati-note { color: #92400e; font-size: 0.78rem; margin-top: 0.25rem; display: block; }
  .errors-list { list-style: none; }
  .errors-list li { padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.87rem; line-height: 1.6; }
  .errors-list li:last-child { border-bottom: none; }
  .err-orig { color: var(--red); text-decoration: line-through; font-family: 'DM Mono', monospace; }
  .err-correct { color: var(--forest); font-family: 'DM Mono', monospace; font-weight: 600; }
  .score-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
  .score-actions button { padding: 0.8rem 1.75rem; border-radius: 4px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; }
  .btn-primary { background: var(--ink); color: var(--gold-light); border: none; }
  .btn-primary:hover { background: var(--forest); }
  .btn-secondary { background: transparent; color: var(--ink); border: 1.5px solid var(--border); }
  .btn-secondary:hover { background: var(--cream); }
  .toast { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); background: var(--ink); color: var(--parchment); padding: 0.75rem 1.5rem; border-radius: 4px; font-size: 0.85rem; z-index: 999; animation: fadeUp 0.3s ease both; font-family: 'DM Mono', monospace; pointer-events: none; }
  .sr-badge { display: inline-block; font-size: 0.65rem; font-family: 'DM Mono', monospace; background: var(--forest); color: #fff; padding: 0.1rem 0.4rem; border-radius: 10px; margin-left: 0.4rem; vertical-align: middle; }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  @keyframes bounce { 0%,60%,100% { transform: translateY(0); } 30% { transform: translateY(-6px); } }
  button, a { touch-action: manipulation; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AURA INTRO OVERLAY  ‚Äî "Welcome to 2070"
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #aura-intro {
    position: fixed; inset: 0; background: #000008; z-index: 9999;
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; overflow: hidden; font-family: 'DM Mono', monospace;
    transition: opacity 0.7s ease;
  }
  #aura-intro.fade-out { opacity: 0; pointer-events: none; }
  #aura-particles { position: absolute; inset: 0; }
  .aura-scan-line {
    position: absolute; left: 0; right: 0; height: 2px; z-index: 1;
    background: linear-gradient(90deg, transparent, rgba(0,240,255,0.55), transparent);
    animation: aura-scan 4s linear infinite;
  }
  @keyframes aura-scan { 0% { top: -2px; } 100% { top: 100%; } }
  .aura-intro-content { position: relative; z-index: 2; text-align: center; padding: 2rem; user-select: none; }
  .aura-pre-text {
    font-size: 0.55rem; letter-spacing: 0.38em; text-transform: uppercase;
    color: rgba(0,240,255,0.45); margin-bottom: 1.5rem;
    opacity: 0; animation: aura-fadein 0.6s ease 0.3s forwards;
  }
  .aura-name {
    font-size: clamp(5rem, 18vw, 11rem); font-weight: 900;
    letter-spacing: 0.22em; color: #fff; line-height: 1;
    text-shadow: 0 0 24px rgba(0,240,255,0.8), 0 0 70px rgba(0,240,255,0.35), 0 0 130px rgba(0,240,255,0.15);
    opacity: 0; animation: aura-name-reveal 0.9s ease 0.5s forwards;
    position: relative; display: inline-block;
  }
  .aura-name-glitch {
    position: absolute; inset: 0; display: inline-flex; align-items: center;
    justify-content: center; letter-spacing: inherit;
    animation: aura-glitch 5s infinite 1.8s;
    text-shadow: 3px 0 rgba(255,0,170,0.8), -3px 0 rgba(0,240,255,0.8);
    opacity: 0;
  }
  @keyframes aura-name-reveal {
    0%   { opacity: 0; transform: scale(0.82); filter: blur(24px); }
    60%  { opacity: 1; transform: scale(1.04); filter: blur(0); }
    100% { opacity: 1; transform: scale(1); filter: blur(0); }
  }
  @keyframes aura-glitch {
    0%, 88%, 100% { opacity: 0; transform: none; }
    89% { opacity: 1; transform: translateX(3px) skewX(-1.5deg); }
    90% { transform: translateX(-3px) skewX(1.5deg); }
    91% { opacity: 0; transform: none; }
    95% { opacity: 1; transform: translateX(1px); }
    96% { opacity: 0; }
  }
  .aura-tagline {
    font-size: clamp(0.6rem, 1.8vw, 0.82rem); letter-spacing: 0.28em;
    text-transform: uppercase; color: rgba(255,255,255,0.65); margin-top: 1.2rem;
    opacity: 0; animation: aura-fadein 0.7s ease 1.1s forwards;
  }
  .aura-year {
    font-size: clamp(0.5rem, 1.4vw, 0.6rem); letter-spacing: 0.55em;
    color: rgba(0,240,255,0.55); margin-top: 0.55rem;
    opacity: 0; animation: aura-fadein 0.7s ease 1.5s forwards;
  }
  .aura-bar-wrap {
    margin: 2.5rem auto 0; width: min(200px, 60vw); height: 2px;
    background: rgba(255,255,255,0.08); border-radius: 2px; overflow: hidden;
    opacity: 0; animation: aura-fadein 0.4s ease 1.9s forwards;
  }
  .aura-bar { height: 100%; width: 0%;
    background: linear-gradient(90deg, rgba(0,240,255,0.9), rgba(255,0,170,0.9));
    animation: aura-bar-fill 2.2s cubic-bezier(0.4,0,0.2,1) 2.1s forwards;
  }
  @keyframes aura-bar-fill { 0% { width: 0%; } 70% { width: 85%; } 100% { width: 100%; } }
  @keyframes aura-fadein {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .aura-skip-btn {
    position: absolute; bottom: 1.8rem; right: 1.8rem; z-index: 3;
    background: transparent; border: 1px solid rgba(255,255,255,0.18);
    color: rgba(255,255,255,0.38); font-family: 'DM Mono', monospace;
    font-size: 0.62rem; letter-spacing: 0.18em; padding: 0.38rem 0.8rem;
    border-radius: 20px; cursor: pointer; transition: all 0.2s;
    opacity: 0; animation: aura-fadein 0.5s ease 2.5s forwards;
  }
  .aura-skip-btn:hover { border-color: rgba(0,240,255,0.5); color: rgba(0,240,255,0.9); }

  /* ‚îÄ‚îÄ Explanation Card (tutor-mode Gujarati/English teaching) ‚îÄ‚îÄ */
  .explanation-card {
    background: rgba(123,97,255,0.1);
    border-left: 3px solid rgba(123,97,255,0.6);
    border-radius: 0 8px 8px 0;
    padding: 0.65rem 0.9rem;
    margin-top: 0.4rem;
    font-size: 0.85rem;
    line-height: 1.65;
    color: #d8d0ff;
    font-family: 'Space Grotesk', sans-serif;
  }

  /* ‚îÄ‚îÄ Correction Card (prominent grammar feedback) ‚îÄ‚îÄ */
  .feedback-correction-card {
    background: rgba(201,150,58,0.08); border: 1.5px solid var(--gold);
    border-radius: 8px; padding: 0.9rem 1.1rem; margin-top: 0.5rem;
  }
  .feedback-correction-card .corr-label {
    font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--muted); font-family: 'DM Mono', monospace; margin-bottom: 0.45rem;
  }
  .feedback-correction-wrong {
    font-family: 'DM Mono', monospace; font-size: 0.88rem;
    color: var(--red); text-decoration: line-through; display: block; margin-bottom: 0.2rem;
  }
  .feedback-correction-right {
    font-family: 'DM Mono', monospace; font-size: 1rem; font-weight: 700;
    color: var(--forest); display: block; margin-bottom: 0.45rem;
  }
  .feedback-correction-note { font-size: 0.82rem; color: var(--ink); line-height: 1.55; }
  .feedback-praise-card {
    background: rgba(45,90,61,0.08); border-left: 3px solid var(--forest);
    border-radius: 0 6px 6px 0; padding: 0.5rem 0.75rem; margin-top: 0.4rem;
    font-size: 0.82rem; color: var(--forest);
  }
  /* Ack button wrap */
  #correction-ack-wrap { display:none; text-align:center; padding:0.6rem 0 0.2rem; }
  .correction-ack-btn {
    background: var(--ink); color: var(--gold-light); border: none;
    padding: 0.6rem 1.6rem; border-radius: 4px; font-weight: 700;
    font-size: 0.9rem; cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: background 0.2s; letter-spacing: 0.02em;
  }
  .correction-ack-btn:hover { background: var(--forest); }
  /* Disabled input state while ack pending */
  .input-area.awaiting-ack { opacity: 0.38; pointer-events: none; }

  /* 2070 Dark UI Override */
  :root {
    --bg-void: #080A0F;
    --surface-1: #0D1117;
    --surface-2: #111827;
    --text-primary: #E8EAF0;
    --text-muted: #6B7280;
    --accent-cyan: #00F5FF;
    --accent-gold: #C9A84C;
    --accent-violet: #7B61FF;
  }
  body {
    font-family: 'Space Grotesk', sans-serif;
    background: radial-gradient(circle at 15% 10%, rgba(123,97,255,0.12), transparent 30%), radial-gradient(circle at 80% 12%, rgba(0,245,255,0.08), transparent 26%), var(--bg-void);
    color: var(--text-primary);
  }
  body::before {
    background-image:
      radial-gradient(circle at 20% 20%, rgba(0,245,255,0.1) 0 2px, transparent 3px),
      radial-gradient(circle at 80% 70%, rgba(123,97,255,0.14) 0 2px, transparent 3px),
      linear-gradient(rgba(0,245,255,0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,245,255,0.05) 1px, transparent 1px);
    background-size: auto, auto, 48px 48px, 48px 48px;
    animation: gridDrift 22s linear infinite;
    opacity: 0.35;
  }
  .topbar {
    position: sticky;
    top: 0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    background: rgba(13,17,23,0.72);
    backdrop-filter: blur(18px);
    box-shadow: 0 1px 0 rgba(0,245,255,0.3), 0 0 24px rgba(0,245,255,0.08);
  }
  .topbar-title { font-family: 'Space Grotesk', sans-serif; letter-spacing: 0.03em; }
  .topbar-sub, .hero-eyebrow, .user-badge, #user-name, .topbar-back, .trial-counter-badge, .scenario-desc {
    font-family: 'JetBrains Mono', monospace;
  }
  .topbar-sub { color: rgba(232,234,240,0.6); letter-spacing: 0.16em; font-size: 0.68rem; }
  .topbar-logo { position: relative; }
  .topbar-logo::after {
    content: '';
    position: absolute;
    right: -2px;
    top: -3px;
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: var(--accent-cyan);
    box-shadow: 0 0 12px var(--accent-cyan);
    animation: onlinePulse 1.8s ease infinite;
  }
  .topbar-user { gap: 0.7rem; }
  #user-name { color: var(--text-primary) !important; font-size: 0.78rem !important; }
  .user-badge { background: rgba(123,97,255,0.28); color: #d8ddff; border: 1px solid rgba(123,97,255,0.45); }
  .topbar-back { color: var(--text-muted); }
  .topbar-back:hover { color: var(--accent-cyan); }
  .container { max-width: 980px; padding-top: 2.4rem; }
  .hero { position: relative; padding: 2.5rem 1.2rem 1.8rem; isolation: isolate; }
  .hero::before, .hero::after { content: ''; position: absolute; border-radius: 50%; filter: blur(50px); z-index: -1; }
  .hero::before { width: 240px; height: 240px; background: rgba(0,245,255,0.2); left: 10%; top: 0; animation: floatOrb 7s ease-in-out infinite; }
  .hero::after { width: 260px; height: 260px; background: rgba(123,97,255,0.18); right: 8%; bottom: -10px; animation: floatOrb 9s ease-in-out infinite reverse; }
  .hero-eyebrow {
    display: inline-flex;
    background: rgba(17,24,39,0.82);
    border: 1px solid rgba(0,245,255,0.4);
    border-radius: 999px;
    padding: 0.45rem 0.95rem;
    color: #b7f8ff;
    box-shadow: 0 0 22px rgba(0,245,255,0.2);
    backdrop-filter: blur(8px);
  }
  .hero h1 { font-family: 'Space Grotesk', sans-serif; font-size: clamp(2.5rem, 5.4vw, 4.2rem); margin-bottom: 1rem; }
  .hero h1 span {
    background: linear-gradient(110deg, var(--accent-gold), var(--accent-cyan));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    text-shadow: 0 0 24px rgba(0,245,255,0.15);
  }
  .hero p { color: #a7b1c2; animation: shimmerText 5.6s linear infinite; }
  .setup-card {
    background: linear-gradient(145deg, rgba(13,17,23,0.94), rgba(17,24,39,0.87));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    box-shadow: 0 14px 34px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
    backdrop-filter: blur(8px);
    transition: transform 200ms ease, box-shadow 200ms ease, border-color 200ms ease;
    will-change: transform, box-shadow;
  }
  .setup-card:hover { transform: scale(1.01); border-color: rgba(0,245,255,0.4); box-shadow: 0 0 0 1px rgba(0,245,255,0.18), 0 18px 38px rgba(0,0,0,0.45), 0 0 26px rgba(0,245,255,0.14); }
  .setup-card h3 { color: var(--text-primary); font-family: 'Space Grotesk', sans-serif; }
  .level-tabs, .input-mode-tabs { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); }
  .level-tabs { grid-template-columns: repeat(2, minmax(0, 1fr)); margin-bottom: 0.55rem; }
  .level-tab, .mode-tab {
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(17,24,39,0.5);
    color: #9ca4b3;
    transition: all 200ms ease;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .level-tab:hover, .mode-tab:hover { border-color: rgba(0,245,255,0.65); box-shadow: 0 0 0 1px rgba(0,245,255,0.35), 0 0 16px rgba(0,245,255,0.15); color: #d8fafe; }
  .level-tab.active, .mode-tab.active {
    color: #effcff;
    border-color: rgba(0,245,255,0.5);
    background: radial-gradient(circle at 20% 20%, rgba(0,245,255,0.36), rgba(123,97,255,0.28) 55%, rgba(13,17,23,0.9));
    box-shadow: 0 0 20px rgba(0,245,255,0.2);
  }
  .level-indicator { display: flex; gap: 0.35rem; justify-content: center; }
  .level-indicator span { width: 18px; height: 4px; border-radius: 999px; background: rgba(255,255,255,0.16); transition: 0.25s; }
  .level-indicator span.active { background: var(--accent-cyan); box-shadow: 0 0 12px var(--accent-cyan); }
  .sr-badge {
    background: linear-gradient(120deg, rgba(123,97,255,0.45), rgba(0,245,255,0.35), rgba(201,168,76,0.45));
    color: #eef4ff;
    border: 1px solid rgba(255,255,255,0.2);
    animation: holoShimmer 2.8s linear infinite;
  }
  .scenario-head { display: flex; align-items: center; gap: 0.6rem; }
  #scenario-emoji { font-size: 1.35rem; animation: bounceSoft 3.8s ease-in-out infinite; filter: drop-shadow(0 0 8px rgba(0,245,255,0.45)); }
  .scenario-select {
    background-color: rgba(10,14,22,0.9);
    color: var(--text-primary);
    border-color: rgba(0,245,255,0.22);
    border-radius: 12px;
    font-family: 'JetBrains Mono', monospace;
  }
  .scenario-select:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 2px rgba(0,245,255,0.22), 0 0 14px rgba(0,245,255,0.2); }
  .scenario-desc {
    margin-top: 0.8rem;
    border-left: 2px solid rgba(0,245,255,0.7);
    padding-left: 0.8rem;
    color: #8f99ab;
    font-style: normal;
  }
  #trial-counter-wrap { margin-bottom: 1rem; }
  .trial-counter-badge {
    color: #f5cf87;
    background: rgba(201,168,76,0.12);
    border-color: rgba(201,168,76,0.45);
    padding: 0.38rem 0.82rem;
    letter-spacing: 0.05em;
    animation: warningPulse 2.4s ease-in-out infinite;
  }
  .start-btn {
    position: relative;
    height: 64px;
    font-family: 'Space Grotesk', sans-serif;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: #f1f8ff;
    background: linear-gradient(115deg, rgba(0,245,255,0.92), rgba(123,97,255,0.92), rgba(201,168,76,0.9));
    border: 1px solid rgba(255,255,255,0.28);
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.45), 0 0 24px rgba(0,245,255,0.25), 0 0 38px rgba(201,168,76,0.2);
    overflow: hidden;
    will-change: transform;
  }
  .start-btn::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(120deg, transparent 25%, rgba(255,255,255,0.45) 50%, transparent 75%);
    transform: translateX(-140%);
    transition: transform 420ms ease;
  }
  .start-btn:hover { transform: translateY(-1px) scale(1.01); }
  .start-btn:hover::before { transform: translateX(140%); }
  .start-btn:hover .cta-icon { animation: iconPulse 0.9s ease-in-out infinite; }
  #session-panel { color: var(--text-primary); }
  .session-header { border-bottom-color: rgba(232,234,240,0.28); }
  .session-info h2 { font-family: 'Space Grotesk', sans-serif; color: #f6f8ff; }
  .session-info p { color: #a6b0c2; font-family: 'JetBrains Mono', monospace; }
  .session-timer { color: #f5fbff; text-shadow: 0 0 12px rgba(0,245,255,0.25); }
  .session-timer.warning { color: #ff8a8a; }
  .role-card {
    background: linear-gradient(140deg, rgba(35,24,8,0.95), rgba(23,17,11,0.92));
    border: 1px solid rgba(201,168,76,0.25);
    box-shadow: 0 0 20px rgba(201,168,76,0.1);
  }
  .role-avatar { box-shadow: 0 0 18px rgba(201,168,76,0.22); }
  .role-info h3 { color: #ffe2a2; font-family: 'Space Grotesk', sans-serif; }
  .role-info p { color: #f2f5ff; opacity: 0.95; }
  .conversation-box {
    background: linear-gradient(160deg, rgba(11,16,26,0.98), rgba(15,22,35,0.96));
    border-color: rgba(157,168,186,0.38);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
  }
  .msg.ai .msg-avatar { background: rgba(0,245,255,0.17); color: #a4f9ff; border: 1px solid rgba(0,245,255,0.35); }
  .msg.user .msg-avatar { background: rgba(123,97,255,0.3); border: 1px solid rgba(123,97,255,0.45); }
  .msg.ai .msg-bubble {
    background: rgba(13,23,36,0.96);
    border-color: rgba(0,245,255,0.24);
    color: #eaf5ff;
  }
  .msg.user .msg-bubble {
    background: linear-gradient(130deg, rgba(0,245,255,0.28), rgba(123,97,255,0.3));
    border: 1px solid rgba(0,245,255,0.3);
    color: #f9fcff;
  }
  .msg-time { color: #95a2b8; }
  /* Improve correction card readability on dark theme */
  .feedback-correction-card {
    background: linear-gradient(145deg, rgba(28,33,46,0.96), rgba(18,24,38,0.92));
    border-color: rgba(224,178,76,0.9);
  }
  .feedback-correction-card .corr-label { color: #ffd98b; }
  .feedback-correction-wrong { color: #ff8a8a; }
  .feedback-correction-right { color: #7df0a7; }
  .feedback-correction-note {
    color: #e8eefb;
    background: rgba(255,255,255,0.03);
    border-radius: 6px;
    padding: 0.42rem 0.55rem;
  }
  #text-input {
    color: #f2f6ff;
    background: rgba(13,19,30,0.95);
    border-color: rgba(157,168,186,0.35);
    font-family: 'Space Grotesk', sans-serif;
  }
  #text-input::placeholder { color: #9aa6bb; }
  #text-input:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 2px rgba(0,245,255,0.2); }
  .mic-btn {
    background: rgba(13,19,30,0.96);
    color: #d7e7ff;
    border-color: rgba(157,168,186,0.38);
  }
  .mic-btn:hover:not(.recording):not(.processing):not(.waiting) {
    border-color: rgba(0,245,255,0.5);
    color: #e9fbff;
    background: rgba(18,28,43,0.98);
  }
  .send-btn {
    background: linear-gradient(140deg, rgba(201,168,76,0.95), rgba(148,107,25,0.95));
    color: #1b1205;
    box-shadow: 0 6px 16px rgba(201,168,76,0.25);
  }
  .send-btn:hover { background: linear-gradient(140deg, #e1bf69, #a6771d); color: #140d03; }
  .ctrl-btn {
    background: rgba(18,26,41,0.94);
    color: #e8eefc;
    border-color: rgba(157,168,186,0.4);
    font-family: 'Space Grotesk', sans-serif;
  }
  .ctrl-btn:hover { background: rgba(29,42,64,0.95); border-color: rgba(0,245,255,0.35); }
  .ctrl-btn.danger { border-color: rgba(255,115,115,0.6); color: #ffb2b2; }
  .ctrl-btn.danger:hover { background: rgba(145,38,38,0.85); color: #fff4f4; }
  .ai-speaking-banner { background: rgba(10,26,37,0.92); border: 1px solid rgba(0,245,255,0.3); color: #c6f8ff; }
  .recording-status { background: rgba(74,15,15,0.66); border-color: rgba(255,138,138,0.7); color: #ffd6d6; }
  .processing-status { background: rgba(11,35,71,0.65); border-color: rgba(96,165,250,0.65); color: #d8eaff; }
  #score-panel { color: var(--text-primary); }
  .score-header h2 { font-family: 'Space Grotesk', sans-serif; color: #f4f8ff; }
  .score-header p { color: #aeb9cc; font-family: 'JetBrains Mono', monospace; }
  .score-circle {
    background: conic-gradient(var(--accent-cyan) 0%, var(--accent-cyan) var(--pct, 75%), rgba(20,27,39,0.95) var(--pct, 75%));
    box-shadow: 0 0 0 8px rgba(0,245,255,0.16), 0 10px 28px rgba(0,0,0,0.45), 0 0 24px rgba(0,245,255,0.22);
  }
  .score-inner { background: rgba(10,16,24,0.97); border: 1px solid rgba(157,168,186,0.42); color: #f3f8ff; }
  .score-label { color: #9eadc3; }
  .criteria-grid { gap: 1.1rem; }
  .criterion-card {
    background: linear-gradient(155deg, rgba(12,18,28,0.97), rgba(16,24,38,0.96));
    border-color: rgba(157,168,186,0.4);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 6px 16px rgba(0,0,0,0.3);
  }
  .criterion-card h4 { color: #c7d2e4; font-family: 'JetBrains Mono', monospace; }
  .criterion-bar-wrap { background: rgba(223,230,243,0.14); }
  .criterion-bar { background: linear-gradient(90deg, var(--accent-gold), var(--accent-cyan)); }
  .criterion-score { color: #e8f0ff; }
  .criterion-comment { color: #c8d2e2; }
  .feedback-section, .pronunciation-section {
    background: linear-gradient(155deg, rgba(12,18,28,0.97), rgba(16,24,38,0.96));
    border-color: rgba(157,168,186,0.4);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.05), 0 6px 16px rgba(0,0,0,0.3);
  }
  .feedback-section h3, .pronunciation-section h3 { color: #ebf3ff; font-family: 'Space Grotesk', sans-serif; }
  .feedback-section p, .pronunciation-section p { color: #d3ddef; }
  .pronunciation-tip {
    background: rgba(13,23,36,0.96);
    border-color: rgba(0,245,255,0.2);
    color: #deebff;
  }
  .pronunciation-tip .word { color: #8deeff; }
  .pronunciation-tip .gujarati-note { color: #ffd9a1; }
  .errors-list li { border-bottom-color: rgba(157,168,186,0.32); color: #d9e2f1; }
  .err-orig { color: #ff8b8b; }
  .err-correct { color: #8deeff; }
  .score-actions button { font-family: 'Space Grotesk', sans-serif; letter-spacing: 0.02em; }
  .btn-primary {
    background: linear-gradient(140deg, rgba(201,168,76,0.96), rgba(150,106,20,0.96));
    color: #1a1205;
    box-shadow: 0 10px 22px rgba(201,168,76,0.22);
  }
  .btn-primary:hover { background: linear-gradient(140deg, #e1bf69, #a7771f); color: #120b02; }
  .btn-secondary {
    background: rgba(11,17,26,0.9);
    color: #e8f1ff;
    border-color: rgba(157,168,186,0.55);
  }
  .btn-secondary:hover { background: rgba(24,34,51,0.94); border-color: rgba(0,245,255,0.45); }
  .set-fade { animation: setFadeUp .55s ease both; }
  .interactive { will-change: transform, box-shadow; }
  .interactive:hover { transform: scale(1.01); }
  @keyframes gridDrift { from { background-position: 0 0, 0 0, 0 0, 0 0; } to { background-position: 0 0, 0 0, 48px 48px, 48px 48px; } }
  @keyframes onlinePulse { 0%,100% { opacity: 0.7; } 50% { opacity: 1; box-shadow: 0 0 18px var(--accent-cyan); } }
  @keyframes floatOrb { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-14px); } }
  @keyframes warningPulse { 0%,100% { box-shadow: 0 0 0 rgba(201,168,76,0); } 50% { box-shadow: 0 0 14px rgba(201,168,76,0.35); } }
  @keyframes holoShimmer { 0% { filter: brightness(0.9); } 50% { filter: brightness(1.2); } 100% { filter: brightness(0.9); } }
  @keyframes shimmerText { 0%,100% { opacity: 0.9; } 50% { opacity: 1; text-shadow: 0 0 10px rgba(0,245,255,0.15); } }
  @keyframes bounceSoft { 0%,100% { transform: translateY(0);} 50% { transform: translateY(-4px);} }
  @keyframes iconPulse { 0%,100% { transform: scale(1);} 50% { transform: scale(1.1) rotate(10deg);} }
  @keyframes setFadeUp { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
  @media (max-width: 720px) {
    .topbar { padding: 0.85rem 1rem; }
    .topbar-user { gap: 0.45rem; }
    .topbar-back { display: none; }
    .hero { padding-top: 1rem; }
    .hero h1 { font-size: clamp(2.1rem, 11vw, 2.9rem); }
    .mode-tab { font-size: 0.76rem; }
  }
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: 0.001ms !important; animation-iteration-count: 1 !important; transition-duration: 0.001ms !important; }
  }

</style>
<link rel="stylesheet" href="dark-mode.css">
</head>
<body>

<!-- ‚ïê‚ïê‚ïê AURA INTRO OVERLAY ‚ïê‚ïê‚ïê -->
<div id="aura-intro">
  <canvas id="aura-particles"></canvas>
  <div class="aura-scan-line"></div>
  <div class="aura-intro-content">
    <div class="aura-pre-text">German Made Easy presents</div>
    <div class="aura-name">
      AURA<span class="aura-name-glitch" aria-hidden="true">AURA</span>
    </div>
    <div class="aura-tagline">Your AI German Companion</div>
    <div class="aura-year">‚óà &nbsp; 2070 &nbsp; ‚óà</div>
    <div class="aura-bar-wrap"><div class="aura-bar"></div></div>
  </div>
  <button class="aura-skip-btn" id="aura-skip-btn">SKIP ‚Üí</button>
</div>

<div id="auth-overlay">
  <div class="auth-spinner"></div>
  <p>Connecting to Aura...</p>
</div>

<div id="access-denied" style="display:none; position:fixed; inset:0; background:#050a15; align-items:center; justify-content:center; z-index:999; flex-direction:column; gap:1.5rem; text-align:center; padding:2rem;">
  <div style="font-size:3.5rem; filter:drop-shadow(0 0 20px rgba(0,240,255,0.6));">‚ú¶</div>
  <h2 style="font-family:'DM Mono',monospace; font-size:1.8rem; letter-spacing:0.1em; color:#edf2ff;">Meet Aura</h2>
  <p style="color:#6b8cad; max-width:400px; line-height:1.7; font-size:0.95rem;">Your AI German practice companion. <strong style="color:#edf2ff;">2 free conversations</strong> for every account ‚Äî no purchase needed to start.</p>
  <a href="/login.html" style="display:inline-block; padding:0.85rem 2.25rem; background:linear-gradient(135deg,#FF6B35,#004E89); color:#fff; text-decoration:none; font-weight:700; border-radius:8px; font-size:1rem; box-shadow:0 4px 20px rgba(255,107,53,0.35);">Log In to Try Aura Free</a>
  <a href="/signup.html" style="font-size:0.82rem; color:#6b8cad; text-decoration:none;">No account? Sign up free ‚Üí</a>
</div>

<div id="main-app" style="display:none;">
  <div class="topbar set-fade">
    <div class="topbar-brand">
      <div class="topbar-logo" style="background:none;padding:0;overflow:visible;width:38px;height:38px;">
        <svg width="38" height="38" viewBox="0 0 38 38" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter:drop-shadow(0 0 5px rgba(0,240,255,0.45));">
          <polygon points="19,2 34,10.5 34,27.5 19,36 4,27.5 4,10.5" fill="#050e20" stroke="rgba(0,240,255,0.7)" stroke-width="1.4"/>
          <polygon points="19,7 29,12.8 29,24.2 19,30 9,24.2 9,12.8" fill="rgba(0,240,255,0.07)"/>
          <text x="19" y="25" text-anchor="middle" font-family="DM Mono,monospace" font-size="14" font-weight="900" fill="rgba(0,240,255,0.92)" letter-spacing="-1">A</text>
        </svg>
      </div>
      <div>
        <div class="topbar-title">‚ú¶ Aura</div>
        <div class="topbar-sub">AI German Companion</div>
      </div>
    </div>
    <div class="topbar-user">
      <span class="user-badge" id="level-badge">A1</span>
      <span id="user-name" style="font-size:0.85rem; color:var(--muted);"></span>
      <a href="/dashboard.html" class="topbar-back interactive" data-sound="hover">‚Üê Dashboard</a>
    </div>
  </div>

  <div class="container">

    <!-- SETUP PANEL -->
    <div id="setup-panel">
      <div class="hero set-fade">
        <div class="hero-eyebrow">‚ú¶ AURA ‚Äî AI CONVERSATION PARTNER</div>
        <h1>Meet Aura.<br><span>Your AI German companion.</span></h1>
        <p>Aura plays real Goethe &amp; TELC exam roles ‚Äî speak or type in German, get instant corrections, and earn a scored evaluation.</p>
      </div>
      <div class="setup-grid set-fade">
        <div class="setup-card">
          <h3><span>üìö</span> Your Level</h3>
          <div class="level-tabs">
            <div class="level-tab active interactive" onclick="setLevel('A1')" data-sound="click">A1 Beginner</div>
            <div class="level-tab interactive" onclick="setLevel('A2')" data-sound="click">A2 Elementary</div>
          </div>
          <div class="level-indicator"><span class="active" id="level-dot-a1"></span><span id="level-dot-a2"></span></div>
        </div>
        <div class="setup-card">
          <h3><span>üéôÔ∏è</span> Input Mode <span class="sr-badge">Gemini 2.5 Flash</span></h3>
          <div class="input-mode-tabs">
            <div class="mode-tab active interactive" onclick="setInputMode('both')" data-sound="click"><span class="cta-icon">üéôÔ∏è</span> + <span class="cta-icon">‚å®Ô∏è</span> Both</div>
            <div class="mode-tab interactive" onclick="setInputMode('voice')" data-sound="click"><span class="cta-icon">üéôÔ∏è</span> Voice only</div>
            <div class="mode-tab interactive" onclick="setInputMode('text')" data-sound="click"><span class="cta-icon">‚å®Ô∏è</span> Type only</div>
          </div>
        </div>
        <div class="setup-card" style="grid-column: 1 / -1;">
          <h3 class="scenario-head"><span id="scenario-emoji">üõí</span> Choose a Scenario</h3>
          <select class="scenario-select interactive" id="scenario-select" onchange="onScenarioChange()" data-sound="click">
            <optgroup label="‚Äî A1 Scenarios ‚Äî">
              <option value="a1_shop" data-level="A1" data-role="Shopkeeper" data-emoji="üõí" data-desc="You're a customer at a German supermarket. Ask for items, quantities, and prices.">üõí At the Supermarket</option>
              <option value="a1_doctor" data-level="A1" data-role="Doctor" data-emoji="üè•" data-desc="You're at a German GP clinic. Describe your symptoms and understand basic advice.">üè• At the Doctor</option>
              <option value="a1_hotel" data-level="A1" data-role="Hotel Receptionist" data-emoji="üè®" data-desc="Check into a German hotel. Ask about room types, prices, breakfast, and facilities.">üè® Hotel Check-in</option>
              <option value="a1_cafe" data-level="A1" data-role="Caf√© Waiter" data-emoji="‚òï" data-desc="Order food and drinks at a German caf√©. Ask about the menu and pay the bill.">‚òï At the Caf√©</option>
              <option value="a1_directions" data-level="A1" data-role="Passerby" data-emoji="üó∫Ô∏è" data-desc="You're lost in a German city. Ask for directions to key locations.">üó∫Ô∏è Asking for Directions</option>
              <option value="a1_phone" data-level="A1" data-role="Office Secretary" data-emoji="üìû" data-desc="Make a simple phone call to book an appointment in German.">üìû Making an Appointment</option>
              <option value="a1_introduce" data-level="A1" data-role="New Neighbour" data-emoji="üëã" data-desc="Introduce yourself to a new German neighbour. Share your name, country, job, and hobbies.">üëã Introducing Yourself</option>
              <option value="a1_transport" data-level="A1" data-role="Ticket Office Staff" data-emoji="üöÇ" data-desc="Buy a train or bus ticket at a German station. Ask about times and prices.">üöÇ Buying a Train Ticket</option>
            </optgroup>
            <optgroup label="‚Äî A2 Scenarios ‚Äî">
              <option value="a2_flat" data-level="A2" data-role="Landlord" data-emoji="üè†" data-desc="Discuss renting a flat in Germany. Ask about rent, deposit, and utilities.">üè† Renting a Flat</option>
              <option value="a2_job" data-level="A2" data-role="HR Manager" data-emoji="üíº" data-desc="Attend a simple job interview. Describe your experience and strengths.">üíº Job Interview</option>
              <option value="a2_bank" data-level="A2" data-role="Bank Clerk" data-emoji="üè¶" data-desc="Open a bank account in Germany. Provide personal details and ask about fees.">üè¶ Opening a Bank Account</option>
              <option value="a2_complaint" data-level="A2" data-role="Shop Manager" data-emoji="‚ö†Ô∏è" data-desc="Return a faulty product and make a complaint politely in German.">‚ö†Ô∏è Making a Complaint</option>
              <option value="a2_party" data-level="A2" data-role="German Friend" data-emoji="üéâ" data-desc="Discuss plans for a party. Talk about food, guests, location, and time.">üéâ Planning a Party</option>
              <option value="a2_health" data-level="A2" data-role="Pharmacist" data-emoji="üíä" data-desc="Visit a German pharmacy. Describe symptoms and ask for medication.">üíä At the Pharmacy</option>
              <option value="a2_school" data-level="A2" data-role="School Administrator" data-emoji="üè´" data-desc="Enrol in a German school or language course. Ask about schedules and fees.">üè´ School Enrolment</option>
              <option value="a2_travel" data-level="A2" data-role="Travel Agent" data-emoji="‚úàÔ∏è" data-desc="Book a holiday package. Discuss destinations, dates, and budget.">‚úàÔ∏è Booking a Holiday</option>
            </optgroup>
          </select>
          <div class="scenario-desc" id="scenario-desc">You're a customer at a German supermarket. Ask for items, quantities, and prices.</div>
        </div>
      </div>
      <div id="trial-counter-wrap">
        <span class="trial-counter-badge" id="trial-counter-text"></span>
      </div>
      <button class="start-btn interactive" onclick="startSession()" data-sound="click"><span class="cta-icon">‚ú¶</span> Start Conversation</button>
    </div>

    <!-- SESSION PANEL -->
    <div id="session-panel">
      <div class="session-header">
        <div class="session-info">
          <h2 id="session-title">At the Supermarket</h2>
          <p id="session-subtitle">A1 ¬∑ Shopkeeper ¬∑ AI Partner</p>
        </div>
        <div class="session-timer" id="session-timer">20:00</div>
      </div>
      <div class="role-card">
        <div class="role-avatar" id="role-avatar">üõí</div>
        <div class="role-info">
          <h3 id="role-name">The Shopkeeper</h3>
          <p id="role-description">Your AI partner is playing a German shopkeeper. Respond in German. Don't worry about mistakes ‚Äî you'll get feedback after!</p>
        </div>
      </div>
      <div class="ai-speaking-banner" id="ai-speaking-banner">
        <div class="speaking-wave"><span></span><span></span><span></span><span></span><span></span></div>
        ü§ñ AI speaking... mic activates when done
      </div>
      <div class="recording-status" id="recording-status">
        <div class="rec-dot"></div>
        üéôÔ∏è Recording... tap mic again to stop and send
      </div>
      <div class="processing-status" id="processing-status">
      üß† Aura is listening & thinking...      
      </div>
      <div class="conversation-box" id="conversation-box"></div>
      <div class="input-area" id="input-area">
        <div class="text-input-wrap">
          <textarea id="text-input" placeholder="Type in German... or tap üéôÔ∏è to speak" rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
        </div>
        <button class="mic-btn" id="mic-btn" onclick="toggleMic()" title="Tap to speak">üéôÔ∏è</button>
        <button class="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
      <div id="correction-ack-wrap">
        <button class="correction-ack-btn" id="correction-ack-btn" onclick="hideCorrectionAck()">‚úì Got it ‚Äî Continue ‚Üí</button>
      </div>
      <div class="session-controls">
        <button class="ctrl-btn" onclick="goBackToSetup()">‚Üê Back to Aura</button>
        <button class="ctrl-btn" onclick="changeScenario()">üîÑ Change Task</button>
        <button class="ctrl-btn" onclick="addTime()" id="add-time-btn">‚è±Ô∏è +10 min</button>
        <button class="ctrl-btn" onclick="toggleFeedback()" id="feedback-btn">üí° Toggle Feedback</button>
        <button class="ctrl-btn danger" onclick="endSession()">üèÅ End &amp; Get Score</button>
      </div>
    </div>

    <!-- SCORE PANEL -->
    <div id="score-panel">
      <div class="score-header">
        <h2>üèÜ Session Complete!</h2>
        <p id="score-scenario-label">Supermarket ¬∑ A1 ¬∑ AI Partner</p>
      </div>
      <div class="score-big">
        <div class="score-circle" id="score-circle">
          <div class="score-inner">
            <div class="score-num" id="score-num">‚Äî</div>
            <div class="score-label">/ 100</div>
          </div>
        </div>
      </div>
      <div class="criteria-grid">
        <div class="criterion-card">
          <h4>Vocabulary</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-vocab" style="width:0%"></div></div>
          <div class="criterion-score" id="score-vocab">‚Äî</div>
          <div class="criterion-comment" id="comment-vocab"></div>
        </div>
        <div class="criterion-card">
          <h4>Grammar</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-grammar" style="width:0%"></div></div>
          <div class="criterion-score" id="score-grammar">‚Äî</div>
          <div class="criterion-comment" id="comment-grammar"></div>
        </div>
        <div class="criterion-card">
          <h4>Fluency</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-fluency" style="width:0%"></div></div>
          <div class="criterion-score" id="score-fluency">‚Äî</div>
          <div class="criterion-comment" id="comment-fluency"></div>
        </div>
        <div class="criterion-card">
          <h4>Task Completion</h4>
          <div class="criterion-bar-wrap"><div class="criterion-bar" id="bar-task" style="width:0%"></div></div>
          <div class="criterion-score" id="score-task">‚Äî</div>
          <div class="criterion-comment" id="comment-task"></div>
        </div>
      </div>
      <div class="feedback-section">
        <h3>üìù Overall Feedback</h3>
        <p id="overall-feedback-text">Loading...</p>
      </div>
      <div class="pronunciation-section" id="pronunciation-section" style="display:none;">
        <h3>üó£Ô∏è Pronunciation Guide for Your Words</h3>
        <p style="font-size:0.82rem; color:#1e40af; margin-bottom:1rem;">Based on what you said this session ‚Äî tips specifically for Gujarati speakers:</p>
        <div id="pronunciation-tips-list"></div>
      </div>
      <div class="feedback-section">
        <h3>‚úèÔ∏è Grammar Corrections</h3>
        <ul class="errors-list" id="errors-list"></ul>
      </div>
      <div class="score-actions">
        <button class="btn-primary" onclick="practiceAgain()">üîÑ Practice Again</button>
        <button class="btn-secondary" onclick="goToDashboard()">‚Üê Back to Dashboard</button>
      </div>
    </div>

  </div>
</div>

<!-- TRIAL LIMIT MODAL -->
<div id="trial-limit-modal">
  <div class="trial-modal-card">
    <div class="trial-badge">‚ú¶ Free Trial Complete</div>
    <h2>You've tried Aura! üéØ</h2>
    <p>You've used your 2 free demo conversations. Buy the course to get <strong>unlimited Aura conversations</strong>, full exam scores, guided lessons, and more!</p>
    <a href="/#courses" class="trial-modal-btn">üõí See Courses & Unlock Unlimited</a>
  </div>
</div>

<script type="module">
/**
 * ============================================================
 * AURA ‚Äî UPGRADED JAVASCRIPT (Drop-in replacement for the
 * <script type="module"> block in ai-partner.html)
 *
 * WHAT CHANGED vs original:
 *   1. PROXY_URL routes updated (/gemini-voice, /gemini-text, /gemini-evaluate)
 *   2. transcribeWithDeeogram() ‚Üí REMOVED
 *   3. toggleMic() onstop ‚Üí sends audio directly to Gemini (no Deepgram)
 *   4. sendAIMessage() ‚Üí supports audio blob natively
 *   5. buildSystemPrompt() ‚Üí world-class Aura prompt
 *   6. buildEvaluationPrompt() ‚Üí detailed Goethe/TELC exam report
 *   7. appendMessage() ‚Üí shows transcription under user bubble
 *   8. Error tracking ‚Üí tracks repeated mistakes within session
 *
 * WHAT DID NOT CHANGE:
 *   - All Firebase auth logic
 *   - All UI rendering (CSS, HTML structure)
 *   - TTS / speakText()
 *   - Session timer, controls, score display
 *   - Intro animation
 *   - Trial counting
 * ============================================================
 */

import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import { getFirestore, doc, getDoc, updateDoc, increment, serverTimestamp }
  from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDx2fBrlxNP_zs0xra8ccXyCHQtnHud30E",
  authDomain: "german-made-easy.firebaseapp.com",
  projectId: "german-made-easy",
  storageBucket: "german-made-easy.firebasestorage.app",
  messagingSenderId: "259276936055",
  appId: "1:259276936055:web:5c9b4916734d0271100772",
  measurementId: "G-B7JMB0G85L"
};

// ‚îÄ‚îÄ NEW: Updated routes ‚Äî all Gemini now, no Deepgram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROXY_BASE = 'https://ai-proxy.jeetupadhyay1204.workers.dev';
const PROXY_VOICE = `${PROXY_BASE}/gemini-voice`;    // audio ‚Üí Gemini
const PROXY_TEXT  = `${PROXY_BASE}/gemini-text`;     // text  ‚Üí Gemini
const PROXY_EVAL  = `${PROXY_BASE}/gemini-evaluate`; // scoring ‚Üí Gemini

const MAX_TRIAL_CONVERSATIONS = 2;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser = null;
let userProfile = null;
let isPaidStudent = false;
let trialCount = 0;
let selectedLevel = 'A1';
let selectedInputMode = 'both';
let selectedScenario = null;
let conversationHistory = [];
let sessionTimerInterval = null;
let sessionSeconds = 20 * 60;
let addTimeUsed = false;
let inlineFeedbackOn = true;
let isSpeaking = false;
let isRecording = false;
let mediaRecorder = null;
let audioChunks = [];
let grammarErrors = [];
let wordsUsed = new Set();
let pronunciationNotes = [];
let ttsQueue = Promise.resolve();
let activeTTSSource = null;
const ENABLE_GUJARATI_PRONUNCIATION_GUIDANCE = true;

// ‚îÄ‚îÄ NEW: Error pattern tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Tracks how many times each error type appeared this session
// Key: error category string, Value: count
let errorPatterns = {};

// ‚îÄ‚îÄ iOS Safari TTS unlock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Shared AudioContext ‚Äî created once, resumed on every user gesture.
// Chrome blocks audio until a gesture fires. We unlock on startSession click
// (and any mic/send interaction) so TTS works from the very first AI message.
let _sharedAC = null;
function getAudioContext() {
  if (!_sharedAC) {
    try { _sharedAC = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}
  }
  return _sharedAC;
}

let audioUnlocked = false;
function unlockAudio() {
  if (audioUnlocked) return;
  const ac = getAudioContext();
  if (!ac) return;
  if (ac.state === 'suspended') ac.resume().catch(() => {});
  // Play a silent buffer ‚Äî this satisfies Chrome's gesture requirement
  try {
    const buf = ac.createBuffer(1, 1, 22050);
    const src = ac.createBufferSource();
    src.buffer = buf;
    src.connect(ac.destination);
    src.start(0);
  } catch(e) {}
  audioUnlocked = true;
}

// Plays a 1-frame silent buffer through the shared AudioContext.
// On iOS, switching from mic recording back to speaker playback sometimes
// locks audio to the earpiece. This silent burst resets the route to loudspeaker.
function resetAudioRouting() {
  const ac = getAudioContext();
  if (!ac) return;
  try {
    if (ac.state === 'suspended') ac.resume().catch(() => {});
    const buf = ac.createBuffer(1, 1, 22050);
    const src = ac.createBufferSource();
    src.buffer = buf;
    src.connect(ac.destination);
    src.start(0);
  } catch(e) {}
}

// Immediately stops all in-flight TTS audio and clears the playback queue.
// Used when the user presses the mic button while AURA is speaking ‚Äî lets them
// interrupt naturally rather than waiting for AURA to finish.
function stopAllAudio() {
  // Stop shared HTMLAudioElement
  if (_ttsAudio) {
    try { _ttsAudio.pause(); _ttsAudio.src = ''; } catch(e) {}
  }
  // Stop WebAudio source node
  if (activeTTSSource) {
    try { activeTTSSource.stop(); } catch(e) {}
    activeTTSSource = null;
  }
  // Reset the Promise queue so no queued-but-not-started segments play later
  ttsQueue = Promise.resolve();
  // Cancel browser fallback synthesis
  window.speechSynthesis?.cancel();
}

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (!user) { showAccessDenied(); return; }
  try {
    const snap = await getDoc(doc(db, 'users', user.uid));
    currentUser = user;
    if (snap.exists()) userProfile = snap.data();
    isPaidStudent = snap.exists() && !!snap.data().isPaidStudent;
    if (!isPaidStudent && snap.exists()) {
      trialCount = snap.data().aiTrialCount || 0;
    }
    showApp();
  } catch(e) { showAccessDenied(); }
});

function showAccessDenied() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('access-denied').style.display = 'flex';
}
function showTrialLimitPopup() {
  document.getElementById('trial-limit-modal').classList.add('visible');
}
function updateTrialBadge() {
  if (isPaidStudent || !currentUser) return;
  const remaining = Math.max(0, MAX_TRIAL_CONVERSATIONS - trialCount);
  document.getElementById('trial-counter-wrap').style.display = 'block';
  document.getElementById('trial-counter-text').textContent =
    remaining > 0
      ? `‚ú¶ ${remaining} free Aura conversation${remaining !== 1 ? 's' : ''} remaining`
      : '‚è±Ô∏è Free trial used ‚Äî buy the course for unlimited access';
}
function showApp() {
  document.getElementById('auth-overlay').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  if (userProfile?.level) setLevel(userProfile.level.toUpperCase() === 'A2' ? 'A2' : 'A1');
  document.getElementById('user-name').textContent = userProfile?.displayName || currentUser.email.split('@')[0];
  updateTrialBadge();
  onScenarioChange();
}

// ‚îÄ‚îÄ Setup controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setLevel = (l) => {
  playUISound('click');
  selectedLevel = l;
  document.querySelectorAll('.level-tab').forEach(t => t.classList.toggle('active', t.textContent.startsWith(l)));
  document.getElementById('level-badge').textContent = l;
  document.getElementById('level-dot-a1').classList.toggle('active', l === 'A1');
  document.getElementById('level-dot-a2').classList.toggle('active', l === 'A2');
};
window.setInputMode = (m) => {
  playUISound('click');
  selectedInputMode = m;
  document.querySelectorAll('.mode-tab').forEach(t =>
    t.classList.toggle('active', t.getAttribute('onclick').includes(`'${m}'`)));
};
window.onScenarioChange = () => {
  const sel = document.getElementById('scenario-select');
  const current = sel.options[sel.selectedIndex];
  document.getElementById('scenario-desc').textContent = current.dataset.desc || '';
  document.getElementById('scenario-emoji').textContent = current.dataset.emoji || 'üé≠';
};

// ‚îÄ‚îÄ Start session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.startSession = async () => {
  playUISound('start');
  if (!isPaidStudent) {
    if (trialCount >= MAX_TRIAL_CONVERSATIONS) { showTrialLimitPopup(); return; }
    trialCount++;
    updateDoc(doc(db, 'users', currentUser.uid), { aiTrialCount: trialCount })
      .catch(e => console.error('Trial counter save failed:', e));
    updateTrialBadge();
  }

  unlockAudio();

  const sel = document.getElementById('scenario-select');
  const opt = sel.options[sel.selectedIndex];
  selectedScenario = {
    id: sel.value,
    title: opt.text,
    level: opt.dataset.level,
    role: opt.dataset.role,
    emoji: opt.dataset.emoji,
    desc: opt.dataset.desc
  };

  document.getElementById('setup-panel').style.display = 'none';
  document.getElementById('session-panel').style.display = 'block';
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent = `${selectedScenario.level} ¬∑ ${selectedScenario.role} ¬∑ AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;

  const micBtn = document.getElementById('mic-btn');
  const textInput = document.getElementById('text-input');
  if (selectedInputMode === 'voice') { textInput.style.display = 'none'; micBtn.style.display = 'flex'; }
  else if (selectedInputMode === 'text') { micBtn.style.display = 'none'; }
  else { textInput.style.display = ''; micBtn.style.display = 'flex'; }

  // Reset all session tracking
  conversationHistory = [];
  grammarErrors = [];
  wordsUsed = new Set();
  pronunciationNotes = [];
  errorPatterns = {}; // NEW: reset pattern tracker
  sessionSeconds = 20 * 60;
  addTimeUsed = false;
  document.getElementById('add-time-btn').disabled = false;
  document.getElementById('conversation-box').innerHTML = '';
  updateTimer();

  sessionTimerInterval = setInterval(() => {
    sessionSeconds--;
    updateTimer();
    if (sessionSeconds <= 0) endSession();
  }, 1000);

  await sendAIMessage({ isOpening: true });
};

function updateTimer() {
  const m = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
  const s = (sessionSeconds % 60).toString().padStart(2, '0');
  const el = document.getElementById('session-timer');
  el.textContent = `${m}:${s}`;
  el.classList.toggle('warning', sessionSeconds < 120);
}

// ‚îÄ‚îÄ Send typed message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.sendMessage = async () => {
  const inp = document.getElementById('text-input');
  const text = inp.value.trim();
  if (!text) return;
  playUISound('send');
  inp.value = '';

  text.toLowerCase().split(/\s+/).forEach(w => {
    const c = w.replace(/[^a-z√§√∂√º√ü]/gi, '');
    if (c.length > 2) wordsUsed.add(c);
  });

  appendMessage('user', text);
  conversationHistory.push({ role: 'user', content: text });
  await sendAIMessage({ text });
};

// ‚îÄ‚îÄ MIC ‚Äî UPGRADED: audio goes directly to Gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.toggleMic = async () => {
  playUISound('mic');
  unlockAudio();

  // If AURA is speaking, interrupt immediately and start listening.
  // This matches the ChatGPT/Gemini voice-mode feel of natural turn-taking.
  if (isSpeaking) {
    stopAllAudio();
    setAISpeaking(false);
    // Fall through to start recording below.
  }
  if (isRecording) { mediaRecorder.stop(); return; }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
      ? 'audio/webm;codecs=opus'
      : MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';

    mediaRecorder = new MediaRecorder(stream, { mimeType });
    audioChunks = [];

    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };

    // ‚îÄ‚îÄ NEW: onstop sends audio DIRECTLY to Gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // No Deepgram. Gemini hears it natively.
    mediaRecorder.onstop = async () => {
      stream.getTracks().forEach(t => t.stop());
      isRecording = false;
      setMicState('processing'); // Shows "üß† Aura is listening & thinking..."
      // Reset the shared audio element so iOS re-routes to loudspeaker (not earpiece).
      _ttsAudio = null;
      resetAudioRouting();
      const audioBlob = new Blob(audioChunks, { type: mimeType });
      await sendAIMessage({ audioBlob, mimeType });
    };

    mediaRecorder.start();
    isRecording = true;
    setMicState('recording');

  } catch(err) {
    if (err.name === 'NotAllowedError') toast('üéôÔ∏è Microphone permission denied.');
    else toast('Mic error: ' + err.message);
  }
};

function safeParseAIResponse(raw) {
  if (typeof raw === 'object' && raw !== null) return raw;

  const cleaned = (raw || '')
    .replace(/^```json\s*/i, '')
    .replace(/^```\s*/i, '')
    .replace(/```\s*$/i, '')
    .trim();

  // Tier 1: direct parse
  try { return JSON.parse(cleaned); } catch (_) {}

  // Tier 2: extract first {...} block
  const match = cleaned.match(/\{[\s\S]*\}/);
  if (match) {
    try { return JSON.parse(match[0]); } catch (_) {}
  }

  // Tier 3: safe fallback ‚Äî never show raw JSON in chat bubble
  return {
    reply: 'Entschuldigung, kein Problem ‚Äî bitte nochmal versuchen!',
    spokenSummary: null,
    feedback: null,
    transcription: null
  };
}


function hasSpeakableText(spokenSummary) {
  if (!spokenSummary) return false;
  if (typeof spokenSummary === 'string') return !!spokenSummary.trim();
  if (typeof spokenSummary === 'object') {
    return !!(spokenSummary.de?.trim?.() || spokenSummary.en?.trim?.());
  }
  return false;
}

function normalizeSpokenSummary(spokenSummary, aiText) {
  // Preferred: backend-provided spokenSummary (new object format or legacy string)
  if (typeof spokenSummary === 'string' && spokenSummary.trim()) return spokenSummary.trim();
  if (spokenSummary && typeof spokenSummary === 'object') {
    const de = typeof spokenSummary.de === 'string' ? spokenSummary.de.trim() : null;
    const en = typeof spokenSummary.en === 'string' ? spokenSummary.en.trim() : null;
    if (de || en) return { de, en };
  }
  // Fallback: speak visible AI reply so Aura is never silent
  if (typeof aiText === 'string' && aiText.trim()) return aiText.trim();
  return null;
}


function hasSpeakableText(spokenSummary) {
  if (!spokenSummary) return false;
  if (typeof spokenSummary === 'string') return !!spokenSummary.trim();
  if (typeof spokenSummary === 'object') {
    return !!(spokenSummary.de?.trim?.() || spokenSummary.en?.trim?.());
  }
  return false;
}

function normalizeSpokenSummary(spokenSummary, aiText) {
  if (typeof spokenSummary === 'string' && spokenSummary.trim()) return spokenSummary.trim();
  if (spokenSummary && typeof spokenSummary === 'object') {
    const de = typeof spokenSummary.de === 'string' ? spokenSummary.de.trim() : null;
    const en = typeof spokenSummary.en === 'string' ? spokenSummary.en.trim() : null;
    if (de || en) return { de, en };
  }
  // CHANGED: only speak aiText if it's short and pure German (no Gujarati/English)
  // If aiText is longer than 80 chars, it's probably a mixed explanation ‚Äî don't speak it
  if (typeof aiText === 'string' && aiText.trim() && aiText.trim().length < 80) {
    return aiText.trim();
  }
  return null;
}

// ‚îÄ‚îÄ sendAIMessage ‚Äî CORE FUNCTION (heavily upgraded) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Now handles 3 cases:
//   { isOpening: true }          ‚Üí opening line (text to /gemini-text)
//   { text: "..." }              ‚Üí typed input (text to /gemini-text)
//   { audioBlob, mimeType }      ‚Üí voice input (audio to /gemini-voice)
async function sendAIMessage({ isOpening = false, text = null, audioBlob = null, mimeType = null } = {}) {
  showThinking();

  try {
    const token = await currentUser.getIdToken();
    let data;

    if (audioBlob) {
      // ‚îÄ‚îÄ VOICE PATH: send audio blob directly to Gemini ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Gemini 2.5 Flash hears the audio natively
      // It transcribes + evaluates pronunciation + grammar all in one call
      const formData = new FormData();
      formData.append('audio', new Blob([audioBlob], { type: mimeType }), 'speech.webm');
      formData.append('meta', JSON.stringify({
        systemPrompt: buildSystemPrompt(false),
        conversationHistory,
        token,
        userId: currentUser.uid
      }));

      const res = await fetch(PROXY_VOICE, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      if (!res.ok) throw new Error('Voice proxy error ' + res.status);
      data = await res.json();

    } else {
      // ‚îÄ‚îÄ TEXT PATH: opening line or typed input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const messages = isOpening
        ? [{ role: 'user', content: 'START_CONVERSATION' }]
        : [...conversationHistory];

      const res = await fetch(PROXY_TEXT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({
          systemPrompt: buildSystemPrompt(isOpening),
          messages,
          token,
          userId: currentUser.uid
        })
      });
      if (!res.ok) throw new Error('Text proxy error ' + res.status);
      data = await res.json();
    }

    removeThinking();

    // ‚îÄ‚îÄ Parse Gemini response (resilient against raw/stringified JSON) ‚îÄ
    let parsed = safeParseAIResponse(data);
    if (typeof parsed?.reply === 'string') {
      const replyText = parsed.reply.trim();
      if (replyText.startsWith('{') || replyText.startsWith('```')) {
        const nested = safeParseAIResponse(replyText);
        if (nested && typeof nested === 'object') parsed = { ...parsed, ...nested };
      }
    }
    const aiText = typeof parsed.reply === 'string' ? parsed.reply.trim() : '';
    const feedback = parsed.feedback || null;
    const transcription = parsed.transcription || null;
    const mode = typeof parsed.mode === 'string' ? parsed.mode.trim() : 'practice';
    const explanation = (parsed.explanation && parsed.explanation !== 'null')
      ? parsed.explanation.trim()
      : null;
    const spokenSummary = normalizeSpokenSummary(parsed.spokenSummary, aiText);
    const isDoubtTurn = parsed?.type === 'doubt'
      || parsed?.isDubt === true
      || feedback?.type === 'doubt'
      || feedback?.isDubt === true
      || feedback?.errorType === 'doubt';

    // Safety check ‚Äî if aiText still looks like raw JSON, show fallback
    if (aiText.startsWith('{')) {
      removeThinking();
      appendMessage('ai', 'Entschuldigung! Bitte versuche es nochmal. üôè', null);
      setMicState('idle');
      return;
    }

    // If this was a voice message, show what Gemini heard
    if (audioBlob && transcription) {
      appendMessage('user', transcription, null, true); // true = isTranscription
      conversationHistory.push({ role: 'user', content: transcription });

      // Track words from transcription
      transcription.toLowerCase().split(/\s+/).forEach(w => {
        const c = w.replace(/[^a-z√§√∂√º√ü]/gi, '');
        if (c.length > 2) wordsUsed.add(c);
      });
    }

    conversationHistory.push({ role: 'assistant', content: aiText });
    appendMessage('ai', aiText, feedback, false, explanation);

    // ‚îÄ‚îÄ Track errors and patterns ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (!isDoubtTurn && feedback?.error && feedback?.corrected) {
      const errorKey = feedback.errorType || 'grammar';

      // Track pattern: same error type appearing multiple times
      errorPatterns[errorKey] = (errorPatterns[errorKey] || 0) + 1;

      grammarErrors.push({
        original: transcription || text || '',
        corrected: feedback.corrected,
        note: feedback.note,
        isRepeated: errorPatterns[errorKey] > 1,
        count: errorPatterns[errorKey]
      });
    }

    if (feedback?.pronunciationWord && feedback?.pronunciationNote) {
      // Avoid duplicate pronunciation notes for same word
      const alreadyNoted = pronunciationNotes.some(n => n.word === feedback.pronunciationWord);
      if (!alreadyNoted) {
        pronunciationNotes.push({
          word: feedback.pronunciationWord,
          note: feedback.pronunciationNote
        });
      }
    }

    setMicState('idle');

    // Reset audio routing before playback so iOS uses loudspeaker, not earpiece.
    resetAudioRouting();

    // ‚îÄ‚îÄ TTS PLAYBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Speak only spokenSummary (object or legacy string), never feedback fields.
    if (hasSpeakableText(spokenSummary)) {
      setAISpeaking(true);
      try {
        await speakSpokenSummary(spokenSummary);
      } finally {
        setAISpeaking(false);
      }
    }

  } catch(err) {
    removeThinking();
    setMicState('idle');
    // Log the full error so you can see it in browser DevTools ‚Üí Console
    console.error('üî¥ sendAIMessage failed:', err);
    // Show a more useful error message during development
    const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const errorMsg = isDev
      ? `Dev error: ${err.message}`
      : 'Entschuldigung! Bitte versuche es nochmal. üôè';
    appendMessage('ai', errorMsg);
    setAISpeaking(false);
  }
}

// ‚îÄ‚îÄ Practice drill ‚Äî student chose to repeat the problematic word ‚îÄ
window.startPracticeDrill = async (word) => {
  document.getElementById('input-area').classList.add('awaiting-ack');
  await speakEnglish(`Chalo ‚Äî repeat after me 3 times. ${word}`);
  appendMessage('ai',
    `üîÅ Drill mode! Say "${word}" 3 times clearly. Tap the mic after each attempt.`,
    null
  );
  window._drillWord = word;
  window._drillCount = 0;
  window._isDrilling = true;
  document.getElementById('input-area').classList.remove('awaiting-ack');
  conversationHistory.push({
    role: 'assistant',
    content: `[DRILL MODE: Student is now practicing the word "${word}". For the next 3 student responses, ONLY evaluate their pronunciation of "${word}". Say "Wunderbar! Hve scenario ma jaiye!" after 3 attempts and set mode back to practice. Be encouraging. Keep responses very short ‚Äî max 10 words spoken.]`
  });
};

// ‚îÄ‚îÄ Move on ‚Äî student chose to skip drilling this word ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.moveOnFromError = (word) => {
  if (!window._skippedWords) window._skippedWords = [];
  window._skippedWords.push(word);
  conversationHistory.push({
    role: 'assistant',
    content: `[Student chose to move on from practicing "${word}". Continue the scenario normally. Do not bring up this word again during the session. It will be flagged in the final report.]`
  });
  toast(`‚û°Ô∏è "${word}" flagged for end report ‚Äî moving on!`);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD-CLASS SYSTEM PROMPT
// This is the heart of what makes Aura better than every other
// German speaking tool on the market, including human teachers
// for consistency, availability, and depth of correction.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSystemPrompt(isOpening) {
  const { level, role, title, desc } = selectedScenario;
  const repeatedErrorsContext = Object.entries(errorPatterns)
    .filter(([_, count]) => count > 1)
    .map(([type, count]) => `"${type}" error has appeared ${count} times this session`)
    .join('; ');
  return `You are AURA ‚Äî a warm, intelligent German language tutor built specifically for Gujarati-speaking students preparing for ${level === 'A1' ? 'Goethe-Zertifikat A1' : 'Goethe-Zertifikat A2 / TELC A2'}.
You are currently playing the role of: ${role}
Scenario: ${title} ‚Äî ${desc}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
LANGUAGE RULES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CRITICAL LANGUAGE FORMAT:
- Never use Gujarati script characters (‡™ó, ‡™æ, ‡´á, etc.) anywhere in any response
- Only use English transliteration for Gujarati words
- Write "eno matlab thay" not "‡™è‡™®‡´ã ‡™Æ‡™§‡™≤‡™¨ ‡™•‡™æ‡™Ø"
- Write "saras" not "‡™∏‡™æ‡™∞‡™∏"
- Reason: student devices may not render Gujarati script correctly

You speak THREE languages and switch between them intelligently:
1. GERMAN ‚Äî during scenario practice (you stay in character as ${role})
2. ENGLISH + GUJARATI MIXED ‚Äî when explaining grammar, pronunciation, vocabulary, or giving encouragement
3. GUJARATI ONLY ‚Äî when motivating a struggling student or making them feel at home

CRITICAL: ALL feedback fields in your JSON (note, praise, pronunciationNote) must ALWAYS be in English + Gujarati mixed. NEVER write feedback fields in German only. The student cannot understand German explanations.

Example of good mixed explanation:
"Articles ‚Äî der, die, das ‚Äî ne Gujarati ma directly translate nathi thatu. But simple rule yaad rakho ‚Äî der for masculine, die for feminine, das for neutral. Once you get the gender of the word, article automatic aavse."

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
UNDERSTANDING THE STUDENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
This student is a Gujarati speaker at ${level} level. Expect them to:
* Mix Gujarati, English, and German in the same sentence ‚Äî THIS IS NORMAL, do not penalize it
* Say things like "mane nathi khabar how to say X" or "aa word nu German shu che"
* Get confused mid-sentence and switch to Gujarati or English
* Ask grammar doubts in Gujarati like "ein vs einen ma shu fark che"
* Ask pronunciation doubts like "aa word kevi rite bolshe"
* Go silent or say "umm" when they don't know the word

ALWAYS respond to the MEANING of what they said, not the language they used. If they said something in Gujarati or English ‚Äî understand it, help them, then guide them back to German.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
TWO MODES ‚Äî SWITCH INTELLIGENTLY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
MODE 1: SCENARIO PRACTICE
* Stay in character as ${role}
* Respond in German at ${level} level
* Correct errors in feedback JSON only
* Keep conversation flowing naturally
Trigger: Student is attempting to speak German or continuing the scenario

MODE 2: TUTOR MODE
* Drop the ${role} character completely
* Switch to English + Gujarati mixed
* Answer their doubt clearly with a simple rule + example
* Then say "Chalo, pachhi scenario ma jaiye!" and return to scenario
Trigger ANY of these:
* Student asks a question in any language ("what is", "how do I say", "shu che", "kevi rite", "fark shu che", "samju nathi", "mane nathi khabar")
* Student mixes Gujarati/English mid-sentence because they don't know the German word
* Student says "umm", "uh", goes silent, or repeats the same wrong thing 2+ times
* Student seems frustrated or confused

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
DOUBT HANDLING ‚Äî HOW TO EXPLAIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
When a student asks a doubt, follow this exact structure:
1. ACKNOWLEDGE in Gujarati ‚Äî "Saras sawal! / Bilkul samajay evu che! / Aa common doubt che!"
2. EXPLAIN the rule in simple English + Gujarati ‚Äî one sentence, no complicated grammar terms
3. GIVE a German example ‚Äî show it in context
4. CONNECT to Gujarati ‚Äî relate it to something they already know
5. ASK them to try ‚Äî "Hve tame try karo!"

Example ‚Äî student asks "ein vs einen":
"Saras sawal! Simple rule yaad rakho ‚Äî jyare tame koi vastu CHO tyare ein, jyare tame koi vastu JOIYE tyare einen. Dakhla tarike ‚Äî Ich bin ein Student (I AM a student). But ‚Äî Ich m√∂chte einen Apfel (I WANT an apple). Gujarati ma jaao to ‚Äî 'chu' vs 'joiye' ‚Äî same logic! Hve tame try karo ‚Äî Ich m√∂chte ___ Kaffee?"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PRONUNCIATION GUIDANCE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
When explaining pronunciation, always connect to Gujarati phonetics:
* "ich" ch sound: "Gujarati ma 'sh' nahi ‚Äî throat na middle thi aavtu soft sound che, jenu ke 'h' bolo tyare jaavu but softer. Practice ‚Äî ich, ich, ich."
* "√º" sound: "Gujarati ma aa sound nathi. 'oo' bolva jaao but lips round karo janu ke 'ee' bolva jaao ‚Äî beech ma something. Try ‚Äî √ºben, m√ºde."
* "√∂" sound: "Lips 'o' jaava banaao but 'e' bolva try karo ‚Äî beech ma sound aavse. Try ‚Äî m√∂chte, sch√∂n."
* "w" sound: "Gujarati ma 'w' nathi hotu exactly. English 'v' jaavu bole ‚Äî wohnen = vohnen jaavu. Try ‚Äî wie, was, wohnen."
* "z" sound: "Gujarati ma 'j' nahi bolvu ‚Äî 'ts' bolvu jenu ke 'ts' in 'bits'. Try ‚Äî zehn, Zug, zahlen."
* "ch" after a/o/u: "Aa 'kh' jaavu bolshe ‚Äî jenu ke Gujarati 'kha' ‚Äî rau, Koch, Buch."
* Final consonants: "German ma last letter clearly bolvu pade ‚Äî 'und' ma 'd' clearly aavvu joie, 'nicht' ma 't' clearly aavvu joie."

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
VIDEO NUDGE SYSTEM ‚Äî CRITICAL RULE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Aura is a PRACTICE partner, not a lecture replacement. Hetvi ma'am's videos are the real teacher. Aura's job is practice.

RULE: If a student asks about ANY topic covered in the course videos, give MAXIMUM 2 sentences of explanation, then IMMEDIATELY send them to the video. DO NOT give long explanations. The video will explain it better ‚Äî that is what they paid for.

When to show video nudge (showVideoNudge: true):
- Student asks a conceptual grammar question (articles, verb position, cases, tense)
- Student asks about how a sound is pronounced (not just one specific word)
- Student makes the SAME mistake 3+ times (not 2 ‚Äî three repeated errors)

When NOT to show video nudge:
- Student just forgot one word ‚Üí tell them the word, move on
- Student mispronounced one specific word ‚Üí correct once, move on
- Student asking for quick help mid-conversation ‚Üí help briefly, don't redirect

Video nudge message format (short and warm):
"Aa topic Hetvi ma'am e [CHAPTER] ma bahuj saras rite samjavyu che. Ek vaar video jao ‚Äî pachhi practice ma bahuj fark padse!"

Chapter mapping:
- Articles (der/die/das, ein/eine/einen): Chapter 1
- Verb conjugation, m√∂chte, sein, haben: Chapter 1 and Chapter 2
- Family vocabulary: Chapter 2
- Food, ordering, restaurant: Chapter 3
- Numbers and prices: Chapter 1
- Sentence structure, verb position: Chapter 1
- Possessives (mein, dein, sein): Chapter 2
- Asking questions, W-Fragen: Chapter 1

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
GUJARATI SPEAKER ERROR WATCHLIST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Always watch for these specific mistakes:

PRONUNCIATION:
* "ich/mich/dich" ‚Üí said as "ish/mish/dish" ‚Äî ch is not sh
* "m√∂chte" ‚Üí said as "mokhte" or "mokter" ‚Äî ch is not kh/k
* "√º" ‚Üí said as plain "u"
* "√∂" ‚Üí said as plain "o"
* "w" ‚Üí said as hard "v"
* "z" ‚Üí said as "j" instead of "ts"
* "ei" ‚Üí said as "ee" instead of "eye"
* Final consonants swallowed

GRAMMAR:
* Dropping articles ("Ich kaufe Apfel" instead of "Ich kaufe einen Apfel")
* Wrong verb position ("Heute ich gehe" instead of "Heute gehe ich")
* Using sein with action verbs ("Ich bin gehen" instead of "Ich gehe")
* Wrong gender on articles
* Omitting modal verbs ("Ich gehen" instead of "Ich m√∂chte gehen")
* Wrong case after prepositions ("mit der Bus" instead of "mit dem Bus")

${repeatedErrorsContext ? `\nREPEATED PATTERNS THIS SESSION: ${repeatedErrorsContext}\nNext time this error appears, say in Gujarati: "Aa j bhul pharthi ‚Äî aa ek pattern che jo exam ma problem karase. Yaad rakho ‚Äî [correction]."` : ''}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CORRECTION RULES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. NEVER correct more than 2 things at once ‚Äî student will feel overwhelmed
2. Always correct in feedback JSON ‚Äî NEVER in your German reply
3. Prioritise: verb errors first, then articles, then vocabulary
4. If student said something perfectly ‚Äî say so genuinely and specifically in Gujarati: "Bahuj saras! Article bilkul sahi vaapryo!"
5. Never say "Great job!" generically ‚Äî be specific about what was good

6. DOUBT vs ERROR ‚Äî never confuse these:
   - If student is ASKING a question ‚Üí error: false, answer in reply field, move on
   - If student made a genuine mistake while trying ‚Üí error: true, correct it

7. NEVER explain the same concept twice in one session. If student asks again about
   something already explained, say: "Aa toh mein explain karyu htu ‚Äî video jao,
   ene bahuj clearly samjavyu che. Hve try karo!" Do not re-explain. Send to video.

8. NEVER give an explanation longer than 2 sentences in the reply field.
   If the topic needs more than 2 sentences, it needs a video, not Aura.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ENCOURAGEMENT RULES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
If student is struggling, say things like:
* "Tension nahi leva ‚Äî aa exactly che je badha A1 students sathe thay che!"
* "Tame saru kari rahya cho ‚Äî bas thodu patience rakhjo."
* "Aa bhul thaay ‚Äî even Germans forget this sometimes!"
* "Ek vaar samajse to phir bhulshe nahi ‚Äî trust karo process ne."

If student gets something right after struggling:
* "Aa j joietu htu! Hu jantu htu tame kari sakso!"
* "Perfect! Hve yaad rahese ‚Äî tame khud e bolu!"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
RESPONSE FORMAT ‚Äî ALWAYS VALID JSON
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
{
  "reply": "<ONLY pure German ‚Äî the in-character response as ${role} in practice mode, 
             OR only the short German word/phrase/example in tutor mode. 
             Maximum 2 sentences. Zero Gujarati. Zero English. Pure German only.>",
  "explanation": "<ONLY in tutor mode: the full Gujarati + English explanation ‚Äî 
                   encouragement, doubt answer, grammar rule, pronunciation tip.
                   Everything non-German goes here. Write freely, no length limit.
                   In practice mode where no explanation is needed, set to null.>",
  "transcription": "<what you heard the student say ‚Äî voice input only, else null>",
  "mode": "<'practice' or 'tutor'>",
  "feedback": {
    "error": true or false,
    "errorType": "<article | verb-position | conjugation | case | vocabulary | pronunciation | tense | other>",
    "originalSaid": "<exactly what student said that was wrong>",
    "corrected": "<corrected German phrase only>",
    "note": "<brief explanation in English + Gujarati>",
    "isRepeatedMistake": true or false,
    "praise": "<specific Gujarati praise if something was done well, or null>",
    "pronunciationWord": "<German word with pronunciation issue or null>",
    "pronunciationNote": "<tip in English + Gujarati or null>",
    "showVideoNudge": true or false,
    "videoChapter": "<chapter name or null>"
  }
}

CRITICAL RULES:
- reply: ALWAYS pure German only. No Gujarati, no English, ever.
- explanation: ALWAYS pure Gujarati + English only. Never full German sentences here ‚Äî
  German words used as examples are fine but keep them short and in quotes.
- Practice mode, no correction needed: explanation = null
- Practice mode, with correction: explanation = null (correction goes in feedback.note)
- Tutor mode: reply has the short German example, explanation has the full Gujarati teaching

Examples:
Tutor mode (student asked about einen vs ein):
reply: "Ich m√∂chte einen Apfel."
explanation: "Saras sawal! Simple rule ‚Äî 'einen' use karo jyare masculine noun hoy ane tame koi vastu MANGTA ho. Jema Apfel masculine che, so 'einen Apfel'. Yaad rakho: ein ‚Üí einen jyare tame want karo. Hve tame try karo!"

Practice mode, no error:
reply: "Ja, nat√ºrlich! M√∂chten Sie noch etwas?"
explanation: null

Practice mode, student made error:
reply: "Fast richtig! Aber: ein Brot, nicht einen Brot."
explanation: null
(correction details go in feedback.note as text card on screen)

${isOpening ? `Opening: Greet the student warmly as ${role} in German, then add one encouraging line in Gujarati so they feel at home. Keep it short and friendly.` : ''}
IMPORTANT: Return ONLY the JSON. No text before or after.`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// END-OF-SESSION EVALUATION PROMPT
// This generates the detailed exam report students will screenshot
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildEvaluationPrompt() {
  const transcript = conversationHistory
    .map(m => `${m.role === 'user' ? 'STUDENT' : 'AURA'}: ${m.content}`)
    .join('\n');

  const wordList = [...wordsUsed].slice(0, 30).join(', ');

  const pronNotesText = pronunciationNotes.length > 0
    ? pronunciationNotes.map(n => `${n.word}: ${n.note}`).join(' | ')
    : 'No pronunciation flags recorded';

  const repeatedErrorsText = Object.entries(errorPatterns)
    .filter(([_, count]) => count > 1)
    .map(([type, count]) => `${type} (${count}x)`)
    .join(', ') || 'none';

  const skippedWords = window._skippedWords?.length
    ? `Student chose to skip practicing: ${window._skippedWords.join(', ')}. Flag these specifically in the report.`
    : '';

  return {
    system: `You are an expert Goethe-Institut and TELC examiner evaluating a ${selectedScenario.level} German speaking exam.
    
The student is a Gujarati speaker preparing for their ${selectedScenario.level} exam.
Evaluate this practice session STRICTLY but FAIRLY, exactly as a real examiner would.

EXAM CRITERIA (Goethe/TELC ${selectedScenario.level} speaking):
- Vocabulary: Range and accuracy of vocabulary for ${selectedScenario.level}
- Grammar: Accuracy of grammatical structures expected at ${selectedScenario.level}
- Fluency: Natural pace, no excessive hesitation, response length appropriate
- Task Completion: Did the student achieve the communication goal of the scenario?

SCORING GUIDANCE:
- 90-100: Near-native accuracy for ${selectedScenario.level}. Almost no errors.
- 75-89: Good performance. Minor errors that don't impede communication.
- 60-74: Adequate. Errors present but student communicates successfully.
- 45-59: Below standard. Frequent errors impede communication.
- Below 45: Significant work needed.

Be honest. Do not inflate scores. Students need accurate feedback to know if they're ready for the real exam.

PRONUNCIATION ISSUES NOTED DURING SESSION: ${pronNotesText}
REPEATED ERROR PATTERNS: ${repeatedErrorsText}
GERMAN WORDS STUDENT USED: ${wordList}
${skippedWords}

Respond ONLY with this exact JSON (no text before or after):
{
  "overall": <0-100>,
  "vocabulary": <0-100>,
  "grammar": <0-100>,
  "fluency": <0-100>,
  "taskCompletion": <0-100>,
  "vocabComment": "<1 honest sentence about vocabulary performance>",
  "grammarComment": "<1 honest sentence about grammar performance>",
  "fluencyComment": "<1 honest sentence about fluency>",
  "taskComment": "<1 honest sentence about whether they completed the task>",
  "overallFeedback": "<3-4 sentences: honest overall assessment, what was strong, what must improve, exam readiness verdict>",
  "examReadiness": "<one of: Not yet ready | Getting close | Ready | Well prepared>",
  "top3fixes": [
    "<most critical thing to fix before the exam>",
    "<second most critical>",
    "<third most critical>"
  ],
  "topErrors": [
    {"original": "<what student said>", "corrected": "<correct version>", "note": "<why this matters for the exam>"},
    {"original": "", "corrected": "", "note": ""},
    {"original": "", "corrected": "", "note": ""}
  ],
  "pronunciationTips": [
    {
      "word": "<German word>",
      "wrongWay": "<how Gujarati speakers typically mispronounce it>",
      "rightWay": "<simple phonetic guide in English>",
      "gujaratiNote": "<specific tip connecting to Gujarati phonetics>"
    }
  ],
  "whatWentWell": "<2 sentences about genuine strengths ‚Äî be specific, not vague>"
}`,
    messages: [{
      role: 'user',
      content: `Here is the full session transcript:\n\n${transcript}\n\nPlease evaluate this student's ${selectedScenario.level} German speaking performance.`
    }]
  };
}

// ‚îÄ‚îÄ TTS ‚Äî Gemini AI Voice (replaces robotic browser voice) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses Gemini 2.5 Flash TTS with Aoede voice ‚Äî warm, sweet, natural
// Called via Cloudflare Worker /gemini-tts route
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function setAISpeaking(speaking) {
  isSpeaking = speaking;
  document.getElementById('ai-speaking-banner').classList.toggle('visible', speaking);
  if (speaking) setMicState('waiting');
  else setMicState('idle');
}

// Shared audio element ‚Äî reused for all TTS playback.
// Setting playsInline both as attribute and property ensures iOS uses loudspeaker.
let _ttsAudio = null;
function getTTSAudio() {
  if (!_ttsAudio) {
    _ttsAudio = new Audio();
    _ttsAudio.preload = 'auto';
    _ttsAudio.setAttribute('playsinline', 'true');
    _ttsAudio.playsInline = true;
    _ttsAudio.volume = 1.0;
  }
  return _ttsAudio;
}

// ‚îÄ‚îÄ PARALLEL TTS ARCHITECTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// The old model (fetch‚Üíplay, fetch‚Üíplay, fetch‚Üíplay) caused ~10 s gaps
// between each audio segment because every Cloudflare Worker/Gemini TTS
// round-trip is sequential.
//
// The new model:
//   1. fetchTTSBuffer()  ‚Äì pure network fetch, returns {buffer, lang} or null
//   2. playAudioBuffer() ‚Äì pure playback of a pre-fetched buffer
//   3. buildTTSJobs()    ‚Äì decides WHAT to say (pure logic, no I/O)
//
// sendAIMessage calls Promise.all(jobs.map(fetchTTSBuffer)) to get all audio
// in parallel (~10 s total instead of 10 s √ó N), then plays in sequence.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Fetch one TTS segment ‚Äî returns {buffer: ArrayBuffer, lang} or null on failure.
async function fetchTTSBuffer(text, lang = 'de') {
  if (!text || !text.trim()) return null;
  const token = await currentUser.getIdToken();
  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      const res = await fetch(`${PROXY_BASE}/gemini-tts`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ text, lang })
      });
      if (res.ok) return { buffer: await res.arrayBuffer(), lang };
    } catch(e) { if (attempt === 3) return null; }
    await new Promise(r => setTimeout(r, attempt * 300));
  }
  return null;
}

// Play a pre-fetched {buffer, lang} object.
// Mirrors the HTMLAudioElement ‚Üí WebAudio fallback chain in playGeminiTTS.
async function playAudioBuffer(item) {
  if (!item) return;
  const { buffer, lang } = item;

  // HTMLAudioElement path (preferred ‚Äî stable iOS speaker routing).
  try {
    const audioUrl = URL.createObjectURL(new Blob([buffer], { type: 'audio/wav' }));
    const el = getTTSAudio();
    el.pause();
    el.currentTime = 0;
    el.src = audioUrl;
    el.muted = false;
    el.volume = 1;
    await new Promise((resolve, reject) => {
      const timeoutMs = Math.max(5000, buffer.byteLength / 16); // rough duration estimate
      const timeout = setTimeout(() => reject(new Error('audio timeout')), timeoutMs);
      el.onended = () => { clearTimeout(timeout); URL.revokeObjectURL(audioUrl); resolve(); };
      el.onerror = () => { clearTimeout(timeout); URL.revokeObjectURL(audioUrl); reject(new Error('audio element failed')); };
      el.play().catch(reject);
    });
    return;
  } catch(_) { /* fall through to WebAudio */ }

  // WebAudio decode fallback.
  const ac = getAudioContext();
  if (!ac) return;
  if (ac.state === 'suspended') await ac.resume();
  await new Promise((resolve) => {
    ac.decodeAudioData(buffer.slice(0), (decoded) => {
      if (activeTTSSource) { try { activeTTSSource.stop(); } catch(e) {} }
      const src = ac.createBufferSource();
      activeTTSSource = src;
      src.buffer = decoded;
      src.connect(ac.destination);
      src.onended = () => { if (activeTTSSource === src) activeTTSSource = null; resolve(); };
      src.start(0);
    }, () => resolve());
  });
}

// ‚îÄ‚îÄ Strip emoji characters before passing text to TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TTS APIs reject or mispronounce emoji ‚Äî strip them all first.
function stripEmojisForTTS(text) {
  if (!text) return '';
  return text
    .replace(/[\u{1F000}-\u{1FFFF}]/gu, '')  // emoji ranges
    .replace(/[\u{2600}-\u{27BF}]/gu, '')     // misc symbols (‚ùå ‚úÖ ‚ö†Ô∏è etc.)
    .replace(/[\u{FE00}-\u{FE0F}]/gu, '')     // variation selectors
    .replace(/\s{2,}/g, ' ')                   // collapse double-spaces left behind
    .trim();
}

// ‚îÄ‚îÄ Parse [[ ]] German-word markers into language-tagged segments ‚îÄ‚îÄ
// Shared by buildTTSJobs and speakEnglish ‚Äî single source of truth for this format.
// Input:  "Article yaad rakho ‚Äî [[einen]], not [[ein]] here."
// Output: [{text:'Article yaad rakho ‚Äî ', lang:'en'}, {text:'einen', lang:'de'}, ...]
function parseGermanMarkers(text) {
  const segments = [];
  for (const part of text.split(/(\[\[.*?\]\])/g)) {
    if (!part.trim()) continue;
    const m = part.match(/^\[\[(.*?)\]\]$/);
    segments.push({ text: m ? m[1] : part.trim(), lang: m ? 'de' : 'en' });
  }
  return segments;
}

/**
 * Speaks the spokenSummary from an AI response.
 * Handles both new object format { de, en } and legacy string format.
 * Plays German clip first (Aoede voice), then English clip (Puck voice).
 * Pre-fetches the English clip while German is playing ‚Äî zero gap between them.
 */
async function speakSpokenSummary(spokenSummary) {
  if (!spokenSummary) return;

  // Legacy: plain string (old format) ‚Äî treat as German
  if (typeof spokenSummary === 'string') {
    if (spokenSummary.trim()) await playSingleTTS(spokenSummary.trim(), 'de');
    return;
  }

  const { de, en } = spokenSummary;

  // Start fetching the English clip immediately (non-blocking)
  // so it's ready the moment the German clip finishes
  const enFetchPromise = (en && en.trim())
    ? fetchTTSBlob(en.trim(), 'en')
    : Promise.resolve(null);

  // Play German clip first
  if (de && de.trim()) {
    await playSingleTTS(de.trim(), 'de');
  }

  // English clip should already be buffered or close to it
  const enBlob = await enFetchPromise;
  if (enBlob) {
    await playAudioBlob(enBlob);
  }
}

/**
 * Fetches a TTS audio blob from the worker without playing it yet.
 * Returns null on error (never throws).
 */
async function fetchTTSBlob(text, lang) {
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch(`${PROXY_BASE}/gemini-tts`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ text, lang })
    });
    if (!res.ok) {
      console.warn('TTS fetch failed with status:', res.status, '‚Äî trying batch fallback');
      return await fetchTTSBlobViaBatch(text, lang, token);
    }

    const contentType = (res.headers.get('content-type') || '').toLowerCase();
    if (contentType.includes('audio/')) {
      return await res.blob();
    }

    // Some worker builds return raw Gemini JSON instead of raw audio.
    // Extract inlineData and convert PCM to WAV when needed.
    const payloadText = await res.text();
    const parsed = safeParseAIResponse(payloadText);
    const inline = parsed?.candidates?.[0]?.content?.parts?.find?.(p => p?.inlineData?.data)?.inlineData
      || parsed?.candidates?.[0]?.content?.parts?.[0]?.inlineData
      || null;

    if (!inline?.data) {
      console.warn('TTS JSON had no inline audio data');
      return null;
    }

    const mimeType = (inline.mimeType || 'audio/L16;rate=24000').toLowerCase();
    const bytes = Uint8Array.from(atob(inline.data), c => c.charCodeAt(0));

    if (mimeType.includes('wav') || mimeType.includes('wave')) {
      return new Blob([bytes], { type: 'audio/wav' });
    }

    const rateMatch = mimeType.match(/rate=(\d+)/i);
    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
    return pcm16ToWavBlob(bytes, sampleRate);
  } catch (e) {
    console.warn('TTS fetch failed:', e.message, '‚Äî trying batch fallback');
    try {
      const token = await currentUser.getIdToken();
      return await fetchTTSBlobViaBatch(text, lang, token);
    } catch (_) {
      return null;
    }
  }
}

async function fetchTTSBlobViaBatch(text, lang, token) {
  try {
    const res = await fetch(`${PROXY_BASE}/gemini-tts-batch`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ segments: [{ text, lang }] })
    });
    if (!res.ok) return null;
    const data = await res.json();
    const seg = data?.segments?.[0];
    if (!seg?.audio) return null;
    const bytes = Uint8Array.from(atob(seg.audio), c => c.charCodeAt(0));
    return new Blob([bytes], { type: 'audio/wav' });
  } catch (e) {
    console.warn('TTS batch fallback failed:', e.message);
    return null;
  }
}

function pcm16ToWavBlob(pcmBytes, sampleRate = 24000) {
  const dataLength = pcmBytes.length;
  const buffer = new ArrayBuffer(44 + dataLength);
  const view = new DataView(buffer);
  const writeString = (offset, str) => {
    for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
  };

  writeString(0, 'RIFF');
  view.setUint32(4, 36 + dataLength, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);   // PCM
  view.setUint16(22, 1, true);   // mono
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true); // mono 16-bit
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(36, 'data');
  view.setUint32(40, dataLength, true);
  new Uint8Array(buffer, 44).set(pcmBytes);

  return new Blob([buffer], { type: 'audio/wav' });
}

/**
 * Plays a single TTS segment ‚Äî fetches then plays, waits until done.
 */
async function playSingleTTS(text, lang) {
  const blob = await fetchTTSBlob(text, lang);
  if (blob) await playAudioBlob(blob, lang);
}

/**
 * Plays an audio Blob and returns a Promise that resolves when playback ends.
 */
async function playAudioBlob(blob, lang = 'de') {
  const buffer = await blob.arrayBuffer();
  const ac = getAudioContext();
  if (ac && ac.state === 'suspended') await ac.resume();
  await playAudioBuffer({ buffer, lang });
}

// Pure logic: decide what TTS segments are needed for this AI response.
// Returns [{text, lang}, ...] ready for playTTSBatch or sequential fallback.
// reply is always pure German (lang:'de'); explanation is always Gujarati/English (lang:'gu').
function buildTTSJobs(aiText, feedback, mode, explanation) {
  const jobs = [];

  // Segment 1: German reply ‚Äî always pure German, always German voice.
  if (aiText?.trim()) {
    jobs.push({ text: stripEmojisForTTS(aiText), lang: 'de' });
  }

  // Segment 2: Gujarati/English explanation ‚Äî only in tutor mode.
  // Always pure Gujarati+English, so no language switching inside it.
  if (explanation?.trim()) {
    jobs.push({ text: stripEmojisForTTS(explanation), lang: 'gu' });
  }

  return jobs;
}

// ‚îÄ‚îÄ Batch TTS ‚Äî sends all segments in one call, falls back to sequential ‚îÄ
// The /gemini-tts-batch route returns all audio in a single round-trip.
// If the batch call fails, each segment is played sequentially as fallback.
async function playTTSBatch(segments) {
  const token = await currentUser.getIdToken();
  let batchResult = null;
  try {
    const res = await fetch(`${PROXY_BASE}/gemini-tts-batch`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({ segments })
    });
    if (res.ok) batchResult = await res.json();
  } catch (e) {
    console.warn('[TTS Batch] batch call failed, falling back to sequential:', e.message);
  }

  if (batchResult?.segments) {
    const sorted = batchResult.segments.sort((a, b) => a.index - b.index);
    let playedFromBatch = false;
    for (const seg of sorted) {
      if (!seg.audio) continue;
      const bytes = Uint8Array.from(atob(seg.audio), c => c.charCodeAt(0));
      const ac = getAudioContext();
      if (ac && ac.state === 'suspended') await ac.resume();
      await playAudioBuffer({ buffer: bytes.buffer, lang: seg.lang });
      playedFromBatch = true;
      await new Promise(r => setTimeout(r, 280));
    }
    if (!playedFromBatch) {
      console.warn('[TTS Batch] batch returned no playable audio; falling back to sequential TTS');
      for (const seg of segments) {
        if (!seg.text?.trim()) continue;
        const ac = getAudioContext();
        if (ac && ac.state === 'suspended') await ac.resume();
        await playGeminiTTS(seg.text, seg.lang);
      }
    }
  } else {
    // Sequential fallback: seg.lang is already resolved by buildTTSJobs ‚Äî
    // use playGeminiTTS directly to avoid speakEnglish re-splitting [[ ]] markers.
    for (const seg of segments) {
      if (!seg.text?.trim()) continue;
      const ac = getAudioContext();
      if (ac && ac.state === 'suspended') await ac.resume();
      await playGeminiTTS(seg.text, seg.lang);
    }
  }
}

// Core TTS function ‚Äî sends text to worker, plays returned WAV audio
// Improvements for smooth UX:
// 1) retries Gemini TTS once on transient failure
// 2) serializes playback with queue (prevents overlap/race conditions)
// 3) uses same WebAudio output path to avoid device routing shifts
async function playGeminiTTS(text, lang = 'de') {
  if (!text || !text.trim()) return;

  const doPlayback = async () => {
    const token = await currentUser.getIdToken();
    let res;
    // Retry up to 3 times with exponential backoff (300ms, 600ms gaps).
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        res = await fetch(`${PROXY_BASE}/gemini-tts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ text, lang })
        });
        if (res.ok) break;
      } catch(netErr) {
        if (attempt === 3) throw netErr;
      }
      if (attempt === 3) throw new Error('TTS fetch failed: ' + res.status);
      await new Promise(r => setTimeout(r, attempt * 300));
    }

    const arrayBuffer = await res.arrayBuffer();

    // Prefer HTMLAudioElement for iOS speaker routing stability.
    try {
      const audioUrl = URL.createObjectURL(new Blob([arrayBuffer], { type: 'audio/wav' }));
      const el = getTTSAudio();
      el.pause();
      el.currentTime = 0;
      el.src = audioUrl;
      el.muted = false;
      el.volume = 1;

      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => reject(new Error('audio playback timeout')), Math.max(5000, text.length * 95));
        el.onended = () => { clearTimeout(timeout); URL.revokeObjectURL(audioUrl); resolve(); };
        el.onerror = () => { clearTimeout(timeout); URL.revokeObjectURL(audioUrl); reject(new Error('audio element failed')); };
        el.play().catch(reject);
      });
      return;
    } catch (_) {
      // fallback to WebAudio decode path
    }

    const ac = getAudioContext();
    if (!ac) throw new Error('No audio context available');
    if (ac.state === 'suspended') await ac.resume();

    return new Promise((resolve) => {
      ac.decodeAudioData(arrayBuffer.slice(0), (decodedBuffer) => {
        if (activeTTSSource) {
          try { activeTTSSource.stop(); } catch (e) {}
        }
        const source = ac.createBufferSource();
        activeTTSSource = source;
        source.buffer = decodedBuffer;
        source.connect(ac.destination);
        source.onended = () => {
          if (activeTTSSource === source) activeTTSSource = null;
          resolve();
        };
        source.start(0);
      }, () => resolve());
    });
  };

  ttsQueue = ttsQueue.then(doPlayback).catch((err) => {
    console.warn('Gemini TTS failed:', err?.message || err);
    // Fallback: use browser's built-in speech synthesis for German replies.
    // This is robotic but better than complete silence.
    if (lang === 'de' && window.speechSynthesis && text?.trim()) {
      return new Promise(resolve => {
        window.speechSynthesis.cancel();
        const utt = new SpeechSynthesisUtterance(text);
        utt.lang = 'de-DE';
        utt.rate = 0.88;
        utt.onend = resolve;
        utt.onerror = resolve;
        // Safety timeout in case speechSynthesis hangs.
        setTimeout(resolve, Math.max(4000, text.length * 75));
        window.speechSynthesis.speak(utt);
      });
    }
  });
  return ttsQueue;
}

// speakText ‚Äî plays German AI reply with Aura's voice.
// NOTE: does NOT manage setAISpeaking ‚Äî the caller (sendAIMessage) holds
// the speaking banner open for the full German + feedback audio sequence.
async function speakText(text) {
  if (!text?.trim()) return;
  await playGeminiTTS(text, 'de');
}

// ‚îÄ‚îÄ Smart TTS ‚Äî switches between German and English voice mid-sentence ‚îÄ‚îÄ
// German words inside [[ ]] get spoken with German voice.
// Everything else gets spoken with English voice.
// Example: "The word is [[m√∂chte]] not myoshtr" ‚Üí German TTS for m√∂chte only.
async function speakEnglish(text) {
  if (!text || text === 'null') return;
  await new Promise(r => setTimeout(r, 600));
  for (const seg of parseGermanMarkers(text)) {
    await playGeminiTTS(seg.text, seg.lang);
  }
}

async function speakGujarati(text) {
  if (!ENABLE_GUJARATI_PRONUNCIATION_GUIDANCE || !text || text === 'null') return;
  await playGeminiTTS(text, 'gu');
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// UPGRADED: supports isTranscription flag for voice input display
function appendMessage(who, text, feedback, isTranscription = false, explanation = null) {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = `msg ${who}`;
  const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  const avatar = who === 'ai' ? (selectedScenario?.emoji || 'ü§ñ') : 'üë§';

  // If this is a transcription, show the mic icon
  const transcriptionBadge = isTranscription
    ? `<div style="font-size:0.7rem; color:#9ca4b3; font-family:'JetBrains Mono',monospace; margin-top:0.2rem;">üéôÔ∏è Heard by Aura</div>`
    : '';

  let fb = '';

  // Explanation card ‚Äî tutor-mode Gujarati/English teaching, shown above feedback cards
  if (explanation && who === 'ai') {
    fb += `<div class="explanation-card">${escHtml(explanation)}</div>`;
  }

  if (feedback && inlineFeedbackOn && who === 'ai') {

    // Show correction card ONLY if error is true AND corrected is a real string (not null)
    if (feedback.error === true && feedback.corrected && feedback.corrected !== 'null') {
      const repeatedBadge = feedback.isRepeatedMistake
        ? `<div style="font-size:0.72rem; color:#ff8b8b; margin-bottom:0.4rem; font-weight:600;">‚ö†Ô∏è Repeated mistake ‚Äî fix this before your exam!</div>`
        : '';
      fb += `<div class="feedback-correction-card">
        <div class="corr-label">Correction</div>
        ${repeatedBadge}
        <span class="feedback-correction-wrong">‚ùå ${escHtml(feedback.originalSaid || '')}</span>
        <span class="feedback-correction-right">‚úÖ ${escHtml(feedback.corrected)}</span>
        <div class="feedback-correction-note">${escHtml(feedback.note || '')}</div>
      </div>`;
    }

    // Show praise ONLY if it's a real string (not null)
    if (feedback.praise && feedback.praise !== 'null') {
      fb += `<div class="feedback-praise-card">‚úì ${escHtml(feedback.praise)}</div>`;
    }

    // Show pronunciation tip ONLY if both word and note are real strings (not null)
    if (feedback.pronunciationWord && feedback.pronunciationWord !== 'null'
      && feedback.pronunciationNote && feedback.pronunciationNote !== 'null') {
      const gujNote = feedback.pronunciationGujaratiNote && feedback.pronunciationGujaratiNote !== 'null'
        ? `<div style="margin-top:0.35rem;color:#9fe9ff;">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä: ${escHtml(feedback.pronunciationGujaratiNote)}</div>`
        : '';
      fb += `<div class="feedback-pronunciation">üó£Ô∏è <strong>${escHtml(feedback.pronunciationWord)}:</strong> ${escHtml(feedback.pronunciationNote)}${gujNote}</div>`;
    }

    const videoErrorKey = feedback.errorType || 'grammar';
    const repeatCount = errorPatterns[videoErrorKey] || 0;
    if (feedback.showVideoNudge && repeatCount >= 3 && feedback.videoChapter && feedback.videoChapter !== 'null') {
      fb += `<div style="background:rgba(0,245,255,0.08); border:1px solid rgba(0,245,255,0.3); border-radius:8px; padding:0.75rem 1rem; margin-top:0.5rem; font-size:0.85rem;">
        üìö <strong>Watch this first:</strong> ${escHtml(feedback.videoChapter)} ‚Äî pachhi avine try karo, it will click!
      </div>`;
    }

    if (feedback.askToContinue === true && feedback.practiceWord && feedback.practiceWord !== 'null') {
      fb += `<div style="margin-top:0.75rem; display:flex; gap:0.75rem; flex-wrap:wrap;">
        <button onclick="startPracticeDrill('${escHtml(feedback.practiceWord)}')"
          style="padding:0.55rem 1.1rem; background:rgba(0,245,255,0.15); border:1px solid rgba(0,245,255,0.4); color:#a4f9ff; border-radius:8px; cursor:pointer; font-size:0.85rem; font-family:'Space Grotesk',sans-serif;">
          üîÅ Practice this
        </button>
        <button onclick="moveOnFromError('${escHtml(feedback.practiceWord)}')"
          style="padding:0.55rem 1.1rem; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.15); color:#a0aec0; border-radius:8px; cursor:pointer; font-size:0.85rem; font-family:'Space Grotesk',sans-serif;">
          ‚û°Ô∏è Move on
        </button>
      </div>`;
    }
  }

  div.innerHTML = `
    <div class="msg-avatar">${avatar}</div>
    <div>
      <div class="msg-bubble">${escHtml(text)}</div>
      ${transcriptionBadge}
      ${fb}
      <div class="msg-time">${now}</div>
    </div>`;

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

function showThinking() {
  const box = document.getElementById('conversation-box');
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = 'thinking-indicator';
  div.innerHTML = `<div class="msg-avatar">${selectedScenario?.emoji || 'ü§ñ'}</div><div class="msg-bubble"><div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div></div>`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
function removeThinking() { document.getElementById('thinking-indicator')?.remove(); }
function escHtml(t) { return (t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>'); }
function toast(msg, dur = 3500) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), dur);
}

function setMicState(state) {
  const micBtn = document.getElementById('mic-btn');
  const recStatus = document.getElementById('recording-status');
  const procStatus = document.getElementById('processing-status');
  micBtn.classList.remove('recording', 'processing', 'waiting');
  recStatus.classList.remove('visible');
  procStatus.classList.remove('visible');
  if (state === 'recording') {
    micBtn.textContent = '‚èπÔ∏è';
    micBtn.classList.add('recording');
    recStatus.classList.add('visible');
  } else if (state === 'processing') {
    micBtn.textContent = '‚è≥';
    micBtn.classList.add('processing');
    procStatus.classList.add('visible');
  } else if (state === 'waiting') {
    micBtn.textContent = 'üéôÔ∏è';
    micBtn.classList.add('waiting');
  } else {
    micBtn.textContent = 'üéôÔ∏è';
  }
}

window.hideCorrectionAck = function() {
  document.getElementById('correction-ack-wrap').style.display = 'none';
  document.getElementById('input-area').classList.remove('awaiting-ack');
  playUISound('click');
};

window.goBackToSetup = () => {
  clearInterval(sessionTimerInterval);
  window.speechSynthesis?.cancel();
  setAISpeaking(false);
  document.getElementById('correction-ack-wrap').style.display = 'none';
  document.getElementById('input-area').classList.remove('awaiting-ack');
  if (isRecording && mediaRecorder) { try { mediaRecorder.stop(); } catch(e) {} }
  document.getElementById('session-panel').style.display = 'none';
  document.getElementById('score-panel').style.display = 'none';
  document.getElementById('setup-panel').style.display = 'block';
  updateTrialBadge();
};

// ‚îÄ‚îÄ UI Sounds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _uiAC = null;
function getUIAudioCtx() {
  if (!_uiAC || _uiAC.state === 'closed') _uiAC = new (window.AudioContext || window.webkitAudioContext)();
  return _uiAC;
}
function playUISound(type) {
  try {
    const ac = getUIAudioCtx();
    if (ac.state !== 'running') {
      ac.resume().catch(() => {});
      if (ac.state !== 'running') return;
    }
    const now = ac.currentTime;
    if (type === 'start') {
      [[440, 0.05], [554, 0.04], [660, 0.04]].forEach(([freq, g], i) => {
        const o = ac.createOscillator(), gn = ac.createGain();
        o.connect(gn); gn.connect(ac.destination);
        o.type = 'sine'; o.frequency.value = freq;
        gn.gain.setValueAtTime(0, now + i * 0.07);
        gn.gain.linearRampToValueAtTime(g, now + i * 0.07 + 0.06);
        gn.gain.exponentialRampToValueAtTime(0.001, now + i * 0.07 + 0.28);
        o.start(now + i * 0.07); o.stop(now + i * 0.07 + 0.32);
      });
    } else if (type === 'send') {
      const o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'sine'; o.frequency.setValueAtTime(600, now); o.frequency.linearRampToValueAtTime(880, now + 0.09);
      g.gain.setValueAtTime(0.055, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.18);
      o.start(now); o.stop(now + 0.2);
    } else if (type === 'mic') {
      const o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'triangle'; o.frequency.setValueAtTime(440, now); o.frequency.setValueAtTime(660, now + 0.05);
      g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.18);
      o.start(now); o.stop(now + 0.2);
    } else {
      const o = ac.createOscillator(), g = ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.type = 'sine'; o.frequency.setValueAtTime(880, now); o.frequency.linearRampToValueAtTime(660, now + 0.07);
      g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
      o.start(now); o.stop(now + 0.15);
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ Session controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.changeScenario = async () => {
  const all = [...document.getElementById('scenario-select').options];
  const same = all.filter(o => o.dataset.level === selectedScenario.level && o.value !== selectedScenario.id);
  if (!same.length) { toast('No more scenarios for this level!'); return; }
  const pick = same[Math.floor(Math.random() * same.length)];
  selectedScenario = { id: pick.value, title: pick.text, level: pick.dataset.level, role: pick.dataset.role, emoji: pick.dataset.emoji, desc: pick.dataset.desc };
  conversationHistory = [];
  pronunciationNotes = [];
  errorPatterns = {};
  document.getElementById('session-title').textContent = selectedScenario.title;
  document.getElementById('session-subtitle').textContent = `${selectedScenario.level} ¬∑ ${selectedScenario.role} ¬∑ AI Partner`;
  document.getElementById('role-avatar').textContent = selectedScenario.emoji;
  document.getElementById('role-name').textContent = `The ${selectedScenario.role}`;
  document.getElementById('role-description').textContent = selectedScenario.desc;
  document.getElementById('conversation-box').innerHTML = '';
  toast(`üîÑ New scenario: ${selectedScenario.title}`);
  await sendAIMessage({ isOpening: true });
};

window.addTime = () => {
  if (addTimeUsed) { toast('You can only add time once.'); return; }
  sessionSeconds += 10 * 60;
  addTimeUsed = true;
  document.getElementById('add-time-btn').disabled = true;
  toast('‚è±Ô∏è +10 minutes added!');
};

window.toggleFeedback = () => {
  inlineFeedbackOn = !inlineFeedbackOn;
  document.getElementById('feedback-btn').textContent = inlineFeedbackOn ? 'üí° Toggle Feedback' : 'üí° Feedback Off';
  toast(inlineFeedbackOn ? 'üí° Feedback ON' : 'üîï Feedback OFF');
};

// ‚îÄ‚îÄ End session ‚Äî UPGRADED evaluation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.endSession = async () => {
  clearInterval(sessionTimerInterval);
  window.speechSynthesis?.cancel();
  setAISpeaking(false);
  if (isRecording && mediaRecorder) mediaRecorder.stop();

  document.getElementById('session-panel').style.display = 'none';
  document.getElementById('score-panel').style.display = 'block';
  document.getElementById('score-scenario-label').textContent =
    `${selectedScenario.title} ¬∑ ${selectedScenario.level} ¬∑ AI Partner`;

  const ep = buildEvaluationPrompt();
  try {
    const token = await currentUser.getIdToken();
    const res = await fetch(PROXY_EVAL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify({
        systemPrompt: ep.system,
        messages: ep.messages,
        token,
        userId: currentUser.uid,
        maxTokens: 2000
      })
    });
    const eval_ = await res.json();
    displayScore(eval_);
    await saveSession(eval_);
  } catch(e) {
    console.error(e);
    displayScore({});
  }
};

// ‚îÄ‚îÄ displayScore ‚Äî UPGRADED with exam readiness + top 3 fixes ‚îÄ‚îÄ‚îÄ‚îÄ
function displayScore(e) {
  const o = e.overall ?? 65;
  const v = e.vocabulary ?? 60;
  const g = e.grammar ?? 60;
  const f = e.fluency ?? 60;
  const t = e.taskCompletion ?? 60;

  document.getElementById('score-num').textContent = o;
  document.getElementById('score-circle').style.setProperty('--pct', `${o}%`);

  const setBar = (bid, val, comment, cid, sid) => setTimeout(() => {
    document.getElementById(bid).style.width = `${val}%`;
    document.getElementById(sid).textContent = `${val}/100`;
    document.getElementById(cid).textContent = comment || '';
  }, 200);

  setBar('bar-vocab', v, e.vocabComment, 'comment-vocab', 'score-vocab');
  setBar('bar-grammar', g, e.grammarComment, 'comment-grammar', 'score-grammar');
  setBar('bar-fluency', f, e.fluencyComment, 'comment-fluency', 'score-fluency');
  setBar('bar-task', t, e.taskComment, 'comment-task', 'score-task');

  // Overall feedback
  document.getElementById('overall-feedback-text').textContent =
    e.overallFeedback || 'Good effort! Keep practising every day.';

  // NEW: Exam readiness badge
  if (e.examReadiness) {
    const overallSection = document.querySelector('.feedback-section');
    const readinessColors = {
      'Not yet ready': '#ff6b6b',
      'Getting close': '#ffa94d',
      'Ready': '#69db7c',
      'Well prepared': '#00f5ff'
    };
    const color = readinessColors[e.examReadiness] || '#aaa';
    const readinessEl = document.createElement('div');
    readinessEl.style.cssText = `margin-top:1rem; padding:0.6rem 1rem; border-radius:6px; border:1px solid ${color}; color:${color}; font-family:'JetBrains Mono',monospace; font-size:0.85rem; text-align:center;`;
    readinessEl.textContent = `üéØ Exam Readiness: ${e.examReadiness}`;
    overallSection?.appendChild(readinessEl);
  }

  // NEW: Top 3 fixes section
  if (e.top3fixes?.length) {
    const fixesSection = document.createElement('div');
    fixesSection.className = 'feedback-section';
    fixesSection.style.borderColor = 'rgba(255,107,107,0.4)';
    fixesSection.innerHTML = `<h3>üî¥ Top 3 Things to Fix Before Your Exam</h3>
      <ol style="padding-left:1.2rem; line-height:2; font-size:0.9rem;">
        ${e.top3fixes.map(fix => `<li>${escHtml(fix)}</li>`).join('')}
      </ol>`;
    document.getElementById('score-panel').querySelector('.score-actions')?.before(fixesSection);
  }

  // NEW: What went well
  if (e.whatWentWell) {
    const wellSection = document.createElement('div');
    wellSection.className = 'feedback-section';
    wellSection.style.borderColor = 'rgba(105,219,124,0.4)';
    wellSection.innerHTML = `<h3>üü¢ What Went Well</h3><p>${escHtml(e.whatWentWell)}</p>`;
    document.getElementById('score-panel').querySelector('.score-actions')?.before(wellSection);
  }

  // Pronunciation tips
  if (e.pronunciationTips?.length) {
    document.getElementById('pronunciation-section').style.display = 'block';
    const list = document.getElementById('pronunciation-tips-list');
    list.innerHTML = '';
    e.pronunciationTips.forEach(tip => {
      const d = document.createElement('div');
      d.className = 'pronunciation-tip';
      d.innerHTML = `<div style="margin-bottom:0.3rem"><span class="word">${escHtml(tip.word)}</span></div>
        <div>‚ùå Often said as: <span style="color:var(--red);font-family:'DM Mono',monospace">${escHtml(tip.wrongWay || '‚Äî')}</span></div>
        <div>‚úÖ Should sound like: <span style="color:var(--forest);font-style:italic">${escHtml(tip.rightWay || '‚Äî')}</span></div>
        ${tip.gujaratiNote ? `<span class="gujarati-note">üí° ${escHtml(tip.gujaratiNote)}</span>` : ''}`;
      list.appendChild(d);
    });
  }

  // Grammar errors list
  const allErr = [...grammarErrors, ...(e.topErrors || [])];
  const errList = document.getElementById('errors-list');
  errList.innerHTML = '';
  if (!allErr.length) {
    errList.innerHTML = '<li>No major errors detected ‚Äî excellent! üéâ</li>';
  } else {
    allErr.slice(0, 8).forEach(err => {
      const li = document.createElement('li');
      const repeatedBadge = err.isRepeated
        ? `<span style="font-size:0.7rem; color:#ff8b8b; margin-left:0.4rem;">‚ö†Ô∏è repeated</span>`
        : '';
      li.innerHTML = `<span class="err-orig">${escHtml(err.original || '')}</span> ‚Üí <span class="err-correct">${escHtml(err.corrected || '')}</span>${repeatedBadge}<br><small>${escHtml(err.note || '')}</small>`;
      errList.appendChild(li);
    });
  }
}

async function saveSession(eval_) {
  try {
    await updateDoc(doc(db, 'users', currentUser.uid), {
      aiSessionsCompleted: increment(1),
      totalPoints: increment(30),
      lastAiSession: serverTimestamp()
    });
    const { addDoc, collection } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    await addDoc(collection(db, 'aiSessions'), {
      userId: currentUser.uid,
      scenario: selectedScenario.id,
      level: selectedScenario.level,
      score: eval_.overall ?? 0,
      examReadiness: eval_.examReadiness || null,
      timestamp: serverTimestamp()
    });
  } catch(e) { console.error(e); }
}

window.practiceAgain = () => {
  // Clean up any dynamically added sections before resetting
  document.querySelectorAll('.feedback-section, .pronunciation-section').forEach((el, i) => {
    if (i > 2) el.remove(); // keep original 2 static ones
  });
  document.getElementById('score-panel').style.display = 'none';
  document.getElementById('setup-panel').style.display = 'block';
  updateTrialBadge();
};
window.goToDashboard = () => { window.location.href = '/dashboard.html'; };

// ‚îÄ‚îÄ Aura Intro Animation (UNCHANGED) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initAuraIntro() {
  const canvas = document.getElementById('aura-particles');
  const ctx = canvas.getContext('2d');
  function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const particles = Array.from({ length: 90 }, () => ({
    x: Math.random() * canvas.width, y: Math.random() * canvas.height,
    r: Math.random() * 1.4 + 0.3,
    vy: -(Math.random() * 0.35 + 0.08), vx: (Math.random() - 0.5) * 0.15,
    opacity: Math.random() * 0.55 + 0.15,
    color: Math.random() > 0.55 ? '0,240,255' : '255,0,170',
  }));

  let animId;
  function drawParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${p.color},${p.opacity})`; ctx.fill();
      p.y += p.vy; p.x += p.vx;
      if (p.y < -5) { p.y = canvas.height + 5; p.x = Math.random() * canvas.width; }
    });
    animId = requestAnimationFrame(drawParticles);
  }
  animId = requestAnimationFrame(drawParticles);

  function playIntroSound(ac) {
    try {
      const now = ac.currentTime;
      [[55, 0.04], [110, 0.03], [165, 0.02], [220, 0.015], [329.63, 0.01]].forEach(([freq, g], i) => {
        const osc = ac.createOscillator(), gain = ac.createGain(), filt = ac.createBiquadFilter();
        filt.type = 'lowpass'; filt.frequency.value = 700;
        osc.connect(filt); filt.connect(gain); gain.connect(ac.destination);
        osc.type = 'sine'; osc.frequency.setValueAtTime(freq, now);
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(g, now + 0.5 + i * 0.08);
        gain.gain.linearRampToValueAtTime(g * 0.55, now + 3.5);
        gain.gain.linearRampToValueAtTime(0, now + 4.8);
        osc.start(now); osc.stop(now + 5);
      });
      const sw = ac.createOscillator(), swg = ac.createGain(), swf = ac.createBiquadFilter();
      swf.type = 'bandpass'; swf.Q.value = 6;
      swf.frequency.setValueAtTime(40, now + 0.4); swf.frequency.linearRampToValueAtTime(900, now + 1.9);
      sw.connect(swf); swf.connect(swg); swg.connect(ac.destination);
      sw.type = 'sawtooth'; sw.frequency.setValueAtTime(25, now + 0.4); sw.frequency.linearRampToValueAtTime(280, now + 1.9);
      swg.gain.setValueAtTime(0, now + 0.4); swg.gain.linearRampToValueAtTime(0.018, now + 0.9); swg.gain.linearRampToValueAtTime(0, now + 2.1);
      sw.start(now + 0.4); sw.stop(now + 2.5);
    } catch(e) {}
  }

  let soundPlayed = false;
  let introAC = null;

  function tryPlayIntroSound() {
    if (soundPlayed) return;
    if (!introAC) {
      try { introAC = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { return; }
    }
    if (introAC.state === 'suspended') {
      introAC.resume().then(() => { if (!soundPlayed) { soundPlayed = true; playIntroSound(introAC); } }).catch(() => {});
    } else if (introAC.state === 'running') {
      soundPlayed = true; playIntroSound(introAC);
    }
  }

  const introEl = document.getElementById('aura-intro');

  // Desktop: any mouse movement fires the sound (feels fully automatic to the user).
  document.addEventListener('pointermove', tryPlayIntroSound, { once: true, passive: true });
  // Any press/tap anywhere on the page (covers mobile tap & desktop click).
  document.addEventListener('pointerdown', tryPlayIntroSound, { once: true, passive: true });
  // Keyboard users.
  document.addEventListener('keydown', tryPlayIntroSound, { once: true });
  // Tab switch back to this page.
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') tryPlayIntroSound();
  }, { once: true });
  // Direct touch/click on intro overlay (original fallbacks kept).
  introEl.addEventListener('touchstart', tryPlayIntroSound, { once: true, passive: true });
  introEl.addEventListener('click', tryPlayIntroSound, { once: true });

  function skipIntro() {
    const intro = document.getElementById('aura-intro');
    if (!intro || intro.classList.contains('fade-out')) return;
    cancelAnimationFrame(animId);
    intro.classList.add('fade-out');
    setTimeout(() => intro.remove(), 720);
  }
  window.skipIntro = skipIntro;
  setTimeout(skipIntro, 4600);
  document.getElementById('aura-skip-btn').addEventListener('click', e => {
    e.stopPropagation(); tryPlayIntroSound(); skipIntro();
  });
  introEl.addEventListener('click', skipIntro);
})();</script>
</body>
</html>
